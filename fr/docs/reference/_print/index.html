<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=fr class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://osrd.fr/fr/docs/reference/><link rel=alternate type=application/rss+xml href=https://osrd.fr/fr/docs/reference/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Référence technique | OSRD</title>
<meta name=description content="Machinerie interne et APIs"><meta property="og:title" content="Référence technique"><meta property="og:description" content="Machinerie interne et APIs"><meta property="og:type" content="website"><meta property="og:url" content="https://osrd.fr/fr/docs/reference/"><meta itemprop=name content="Référence technique"><meta itemprop=description content="Machinerie interne et APIs"><meta name=twitter:card content="summary"><meta name=twitter:title content="Référence technique"><meta name=twitter:description content="Machinerie interne et APIs"><link rel=preload href=/scss/main.min.4d9db1288b215f6876c21ef883bcd30df98e7409451895d47ac7aa0297a1a496.css as=style><link href=/scss/main.min.4d9db1288b215f6876c21ef883bcd30df98e7409451895d47ac7aa0297a1a496.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/fr/><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" id="svg36" width="110.767" height="22"><style id="style1">.st9{fill:#fff}</style><g id="ok" transform="scale(.1918)"><g id="g36"><g id="g29"><path id="path23" d="M38.5 83.4c-1.9 8.2-2.9 17-2.9 26.5v4.8h16.6c-2.8-13.2-7.8-23.4-13.7-31.3z" class="st9"/><path id="path24" d="M0 57.5v19.9c3.1 1.2 6.3 2.7 9.5 4.6 8.5 5.2 15 12.6 19.4 21.8v-31c-3.4-3-6.9-5.5-10.3-7.5-6.5-3.7-13-6.2-18.6-7.8z" class="st9"/><path id="path25" d="M35.6 69.9c4.3-11.3 10.6-21.1 18.9-29.4V0H35.6z" class="st9"/><path id="path26" d="M40.8 75.4c5.3 6.2 10.1 13.8 13.7 23.3V50.6C48.6 57.8 44 66.1 40.8 75.4z" class="st9"/><path id="path27" d="M100.7.0H61.3v34.5C73.1 25.2 86 20 96.9 17.2c1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-11.4 2.9-25.3 8.6-37.2 19.7v31.8c2.9-6.3 6.7-11.7 11.4-16.4 9.4-9.3 21-14.1 30.5-16.6 1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-4.7 1.2-10.1 3.1-15.3 6-19 10.3-28.2 28.4-28.2 55.2v4.8h39.3c7.8.0 14.1-6.3 14.1-14.1V14.1C114.7 6.3 108.4.0 100.7.0z" class="st9"/><path id="path28" d="M22 59.6c2.2 1.3 4.5 2.8 6.8 4.6V0H14.1C6.3.0.0 6.3.0 14.1v36.4c6.5 1.7 14.2 4.5 22 9.1z" class="st9"/><path id="path29" d="M5.4 87.5c-1.8-1.1-3.6-2-5.4-2.8v15.9c0 7.8 6.3 14.1 14.1 14.1h11.6c-3.6-12.2-10.4-21.3-20.3-27.2z" class="st9"/></g><g id="g30"><path id="path30" d="M201.7 109c-30.8.0-53.7-21.2-53.7-52.5.0-31.7 22.9-51.6 53.7-51.6 31 0 53.9 20 53.9 51.6-.1 31.3-23 52.5-53.9 52.5zm0-82.6c-16.7.0-28.2 12.8-28.2 30.1.0 17.9 11.6 30.7 28.2 30.7S230 74.4 230 56.6c0-17.3-11.6-30.2-28.3-30.2z" class="st9"/></g><g id="g32"><g id="g31"><path id="path31" d="M334.3 33.3c-4-5.2-11.4-8.5-17.6-8.5-6.2.0-13.8 2.1-13.8 9.9.0 6.6 5.9 8.7 15.2 11.6 13.4 4.3 30.7 10 30.7 29.7.0 22.7-18.3 32.9-37.8 32.9-14.1.0-28.3-5.2-37-14.2l15.6-15.9c4.7 6 13.5 10.5 21.3 10.5 7.3.0 13.7-2.8 13.7-10.7.0-7.5-7.5-9.9-20.5-14.1C291.6 60.3 279 53.9 279 36c0-21.9 19.8-31 38.2-31 11.2.0 23.7 4.2 32.4 12.1z" class="st9"/></g></g><g id="g34"><g id="g33"><path id="path32" d="m433.1 106.4-21.3-39.2h-8.1v39.2h-23.4V7.6H418c19 0 37.8 7.3 37.8 29.9.0 13.3-7.8 22.7-20.5 26.6l25.8 42.3zm-16.9-79.6h-12.7v23h11.3c7.7.0 17.3-2 17.3-12 0-9.2-8.7-11-15.9-11z" class="st9"/></g></g><g id="g35"><path id="path34" d="M522.2 106.4h-36.8V7.6H521c28 0 56.5 11.7 56.5 49.1.0 34.7-28.1 49.7-55.3 49.7zm-1.7-78.5h-11.9v57.8h11.3c17 0 32.8-7 32.8-29 0-22.2-15.8-28.8-32.2-28.8z" class="st9"/></g></g></g></svg></span><span class=navbar-brand__name>OSRD</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/fr/about/><span>À propos</span></a></li><li class=nav-item><a class="nav-link active" href=/fr/docs/><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/fr/blog/><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Français</a><ul class=dropdown-menu><li><a class=dropdown-item href=/en/docs/reference/>English</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=Rechercher aria-label=Rechercher autocomplete=off data-offline-search-index-json-src=/offline-search-index.407302fd45042cd0a17f8f3cf857fa0e.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>Version imprimable multipages.
<a href=# onclick="return print(),!1">Cliquer ici pour imprimer</a>.</p><p><a href=/fr/docs/reference/>Retour à la version par défaut</a>.</p></div><h1 class=title>Référence technique</h1><div class=lead>Machinerie interne et APIs</div><ul><li>1: <a href=#pg-b5e4bdbf196beb2ab115d04daf58146b>Architecture</a></li><ul><li>1.1: <a href=#pg-21c6725e49c5e2766b8042790b5db698>Flux des données</a></li><li>1.2: <a href=#pg-edf52d1d45d4337614b654cb14e38066>Services</a></li></ul><li>2: <a href=#pg-4f5886dd5946f64520e4862a078500b8>Documents de conception</a></li><ul><li>2.1: <a href=#pg-7f1a0daf0354ed2b782628a3f5c6f5c4>Poste d'aiguillage</a></li><ul><li>2.1.1: <a href=#pg-ee6003e9414db3f0e05978636a844345>Éléments mobiles</a></li><li>2.1.2: <a href=#pg-f9ae9ad8e8b03f8f0fcbef3b7d4be0b9>Localisation</a></li><li>2.1.3: <a href=#pg-102b27462f1d7abc5a5824a7ba5d0b82>Reservation</a></li><li>2.1.4: <a href=#pg-db83f9bbda0f6a9be54f5872c94185f4>Routage</a></li><li>2.1.5: <a href=#pg-d84f7d18068af2c677e12c6761184b2f>Ordonnancement</a></li><li>2.1.6: <a href=#pg-7430cbed022a567839d982205fb6211d>Train</a></li></ul><li>2.2: <a href=#pg-2a67b560f64e237130e37a54280c81f6>Recherche de sillons de dernière minute (STDCM)</a></li><ul><li>2.2.1: <a href=#pg-5e6a8c58f44ec33565becd41e00148ef>Contexte métier</a></li><li>2.2.2: <a href=#pg-43ea4c19a1c68f9d3854a75420fe7d2b>Module de recherche de sillons</a></li><ul><li>2.2.2.1: <a href=#pg-4b08bb54f5d63f53d5513a974bbf1597>Parcours de l'infrastructure</a></li><li>2.2.2.2: <a href=#pg-dd3ee9974c77fa971af65f7002bc8aa5>Détection de conflits</a></li><li>2.2.2.3: <a href=#pg-0b86147cbfa958e9f4364f4ce2ba795b>Représentation de l'espace de solutions</a></li><li>2.2.2.4: <a href=#pg-4cbbf502b73f6a39d1784fb6ef5fc8bf>Discontinuités et retours en arrière</a></li><li>2.2.2.5: <a href=#pg-86a0f2f4d5cb5405bb586c1fba4d4c0a>Contourner les conflits</a></li><li>2.2.2.6: <a href=#pg-878a5654bd8bd9fb14457386180665c4>Marge de régularité</a></li><li>2.2.2.7: <a href=#pg-9789474a8d15fe1be9951465d5eb1361>Détails d'implémentation</a></li></ul></ul></ul></ul><div class=content><p>Les guides de référence technique contiennent des références techniques pour les API et autres aspects de la machinerie OSRD. Ils présentent son fonctionnement et la manière de l’exploiter en partant du principe que les concepts clés de base sont maîtrisés.</p></div></div><div class=td-content><h1 id=pg-b5e4bdbf196beb2ab115d04daf58146b>1 - Architecture</h1><div class=lead>Détails lié à l&rsquo;architecture de OSRD</div><p>Les documents d&rsquo;architecture permettent de comprendre comment OSRD fonctionne globalement.</p></div><div class=td-content><h1 id=pg-21c6725e49c5e2766b8042790b5db698>1.1 - Flux des données</h1><div class=lead>Schéma des flux des données d&rsquo;osrd</div><p><img src=data_flow.svg alt="Data-flow diagram"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-edf52d1d45d4337614b654cb14e38066>1.2 - Services</h1><div class=lead>Architecture des services de l&rsquo;application</div><p>Il s’agit d’une architecture multi-services où plusieurs composants logiciels interagissent entre eux. Ce choix a été fait pour assurer la modularité du code et pour garantir l’exploitabilité de certains services d’OSRD par des applications extérieures.</p><h2 id=actuel>Actuel</h2><p><img src=services.fr.svg alt="Schéma des services du projet"></p><h2 id=cible>Cible</h2><p>De nombreuses choses sont prévues dans le futur, notamment</p><ul><li><input checked disabled type=checkbox> Ajouter un reverse proxy authentifiant (gateway)</li><li><input checked disabled type=checkbox> Déployer <code>editoast</code> en tant que service de tuiles cartographiques &ldquo;scalable&rdquo; horizontalement</li><li><input disabled type=checkbox> Rendre le service <code>core</code> &ldquo;scalable&rdquo; horizontalement<ul><li>Les services de base ne gèreront qu&rsquo;une seule infrastructure (sur une version donnée) à la fois</li><li>Ajouter un service RabbitMQ pour distribuer les requêtes à la bonne instance de core</li><li>Créer un service <code>core-controller</code> qui créera / tuera / mettra à l&rsquo;échelle les services <code>core</code> (avec le support de k8s et docker)</li><li>La responsabilité du chargement des infrastructures est déplacée du front vers le <code>core-controler</code>.</li></ul></li></ul><p><img src=services_target.fr.svg alt="Schéma des services du projet"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4f5886dd5946f64520e4862a078500b8>2 - Documents de conception</h1><div class=lead>Détails liés à la conceptions de solutions techniques</div><p>Les documents de conceptions décrivent comment et pourquoi un composant logiciel a été conçu, de l&rsquo;exposition du problème à la solution technique, en passant par le chemin pris pour y arriver.</p></div><div class=td-content><h1 id=pg-7f1a0daf0354ed2b782628a3f5c6f5c4>2.1 - Poste d'aiguillage</h1><div class=lead>Décrit le fonctionnement du poste d&rsquo;aiguillage virtuel</div><p>Le modèle de simulation définit le rôle et comportement des différents objets simulés au sein d&rsquo;OSRD.</p><p>Cette modélisation est un compromis entre de multiples enjeux:</p><ul><li>fidélité de la simulation</li><li>interprétabilité des résultats</li><li>adaptabilité du modèle à différentes technologies et usages, que cela soit en terme de signalisation, de poste d&rsquo;aiguillage, ou d&rsquo;usage des données</li></ul><p>En particulier, certaines subtilités propres aux systèmes pratiques ont été sacrifiées sur l&rsquo;autel de la compatibilité et de l&rsquo;interprétabilité:</p><ul><li>un signal doit forcément s&rsquo;addresser à un train en particulier: les signaux n&rsquo;ont pas d&rsquo;aspect par défaut; ils n&rsquo;existent que pour être vus</li><li>les itinéraires / routes sont formées à destination d&rsquo;un train en particulier</li></ul><div class="pageinfo pageinfo-info"><p>Ce document est une description du modèle de fonctionnement cible d&rsquo;OSRD.
Il a pour objectif de renseigner développeurs et experts métiers sur le fonctionnement du simulateur.
Des changements y sont apportés au fil de l&rsquo;évolution du projet.</p></div><div class="pageinfo pageinfo-warning"><p>Ce modèle est en cours d&rsquo;implémentation</p></div><h2 id=architecture>Architecture</h2><pre class=mermaid>flowchart TD
    %%%% NODES

    train[Train]
    %% ↓
    signaling[Signalisation]
    %% ↓
    routing[Routage]
    ordering[Ordonnancement]
    %% ↓
    reservation[Réservation]
    %% ↓
    location[Localisation]
    movable-elements[&#34;Éléments mobiles&#34;]

    %%%% EDGES

    train -- réagit à --&gt; signaling
    train -- réclame les itinéraires --&gt; ordering
    ordering -- commande --&gt; routing
    signaling -- observe --&gt; reservation
    routing -- observe et réserve --&gt; reservation
    reservation -- observe --&gt; location
    reservation -- actionne --&gt; movable-elements
    train -- informe --&gt; location

    %%%% CLICKABLE LINKS

    click train href &#34;./train/&#34; _self
    click ordering href &#34;./ordering/&#34; _self
    click signaling href &#34;./signaling/&#34; _self
    click routing href &#34;./routing/&#34; _self
    click reservation href &#34;./reservation/&#34; _self
    click location href &#34;./location/&#34; _self
    click movable-elements href &#34;./movable-elements/&#34; _self</pre><div class="alert alert-info" role=alert><h4 class=alert-heading>Pistes d'évolution</h4><ul><li>Gestion des overlaps</li></ul></div><h2 id=remerciements>Remerciements</h2><p>Par ordre alphabétique:</p><ul><li>Christophe Mémin</li><li>Djamal Bellebia</li><li>Gilles Dessagne</li><li>Nathanaël Dias</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ee6003e9414db3f0e05978636a844345>2.1.1 - Éléments mobiles</h1><div class=lead>Gère l&rsquo;état des organes de commande des aiguilles, passages à niveau, …</div><h2 id=description>Description</h2><p>Chaque élément mobile, aiguille ou passage à niveau, a une liste d&rsquo;états possibles.
Ces états sont mutuellement exclusifs.</p><h2 id=dépendances>Dépendances</h2><ul><li><code>statique</code> une liste d&rsquo;élements mobiles</li><li><code>statique</code> liste des états possibles de chaque élément mobile</li></ul><h2 id=opérations-possibles>Opérations possibles</h2><ul><li>observer un élément mobile</li><li>verrouiller / déverrouiller un élément mobile</li><li>bouger un élément mobile</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f9ae9ad8e8b03f8f0fcbef3b7d4be0b9>2.1.2 - Localisation</h1><div class=lead>Fournit les informations de position des trains sur le réseau</div><h2 id=description>Description</h2><p>La couche de localisation permet à d&rsquo;autres modules de simulation de suivre le déplacement du train dans l&rsquo;infrastructure.
L&rsquo;infrastructure ferroviaire est découpée en régions appelées zones. Quand on train entre dans une zone, ce module permet d&rsquo;en être notifié.</p><p>Les zones (ou TVDSection / DetectionSection) sont des partitions physiques des voies :</p><ul><li>capables de détecter la présence d&rsquo;un train</li></ul><h2 id=exigences-de-conception>Exigences de conception</h2><ul><li>il doit être possible de suivre les changements d&rsquo;occupation d&rsquo;une zone</li><li>il <em>devra</em> être possible de suivre les déplacements d&rsquo;un train</li><li>il <em>devra</em> être possible d&rsquo;implémenter un système de bloc mobile</li></ul><h2 id=dépendances>Dépendances</h2><ul><li><code>statique</code> une liste de zones</li></ul><h2 id=opérations>Opérations</h2><ul><li>Occuper une zone</li><li>Libérer une zone</li><li>Observer les changements d&rsquo;occupation d&rsquo;une zone</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-102b27462f1d7abc5a5824a7ba5d0b82>2.1.3 - Reservation</h1><div class=lead>Gère l&rsquo;état de réservation des zones</div><div class="alert alert-warning" role=alert>Le mot réservation ici a pour sens réservation de la resource itinéraire, et non le sens commande plannifiée d&rsquo;itinéraire</div><h2 id=description>Description</h2><p>Les zones (ou TVDSection / DetectionSection) sont des partitions physiques des voies :</p><ul><li>capables de détecter la présence d&rsquo;un train</li><li>qui fournissent un service de réservation à l&rsquo;usage des routes</li></ul><p>Chaque zone a un certain nombre de configurations différentes.
Par exemple, une zone sans aiguille aura deux configurations :</p><ul><li>sens pair</li><li>sens impair</li></ul><p>Une zone avec une aiguille aura 4 configurations possibles :</p><ul><li>sens pair voie principale</li><li>sens impair voie principale</li><li>sens pair voie déviation</li><li>sens impair voie déviation</li></ul><p><strong>Chaque zone ne peut être réservée que pour une configuration donnée à la fois, mais peut être réservée simultanément par plusieurs routes</strong>.
Une zone ne peut changer de configuration que lorsqu&rsquo;elle n&rsquo;est pas réservée.</p><div class="alert alert-info" role=alert><p>En discutant avec des experts métiers, vous entendrez parler d&rsquo;<a href=https://fr.wikipedia.org/wiki/Enclenchement>enclenchements</a>:
le terme viens de l&rsquo;époque où les postes de signalisations étaient entièrement mécaniques.
Les enclenchements étaient alors des objets physiques qui empêchaient certaines configurations.</p><p>Une conséquence de cet héritage historique et que beaucoup de règles ferroviaires sont exprimées par contraintes au lieu d&rsquo;être exprimées par garanties.
Un enclenchement, c&rsquo;est une garantie qu&rsquo;une situation particulière ne peut pas se produire.</p></div><h3 id=état-dynamique-dune-zone>État dynamique d&rsquo;une zone</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ZoneState</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// A list of active reservations.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Each reservation requires a particular configuration to be upheld.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>reservations</span>: <span style=color:#000>VecDeque</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ZoneReservation</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ZoneReservation</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The train which requires this reservation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>train</span>: <span style=color:#000>TrainHandle</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// The configuration required for this reservation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>requirements</span>: <span style=color:#000>ZoneRequirements</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The state of this reservation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>status</span>: <span style=color:#000>ZoneReservationStatus</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ZoneReservationStatus</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// In the process of being reserved, but not yet ready
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>PRE_RESERVED</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The train can arrive anytime
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>RESERVED</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The train is inside the zone
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>OCCUPIED</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The zone is pending release
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>PENDING_RELEASE</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ZoneRequirements</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>entry</span>: <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DirDetector</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>exit</span>: <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DirDetector</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>movable_elements</span>: <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MovableElement</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MovableElementConfig</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ZoneState</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Get the combined requirements for all the currently active reservations
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>get_combined_requirements</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ZoneRequirements</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reservations</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>res</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>requirements</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reduce</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ZoneRequirements</span>::<span style=color:#000>combine</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=exigences-de-conception>Exigences de conception</h2><ul><li>Les zones doivent pouvoir être <strong>verrouillées</strong> dans une configuration particulière.</li><li>Il doit être possible pour plusieurs routes de <strong>partager une réservation</strong> de configuration.</li><li>Il doit être possible d&rsquo;observer l&rsquo;<strong>évolution de statut d&rsquo;une réservation</strong>.</li><li>Il doit être possible de faire évoluer le statut d&rsquo;une réservation.</li></ul><h2 id=dépendances>Dépendances</h2><ul><li><code>statique</code> les détecteurs qui délimitent chaque zone</li><li><code>statique</code> les aiguilles dans chaque zone</li><li><code>dynamique</code> capacité d&rsquo;observer l&rsquo;occupation des zones</li><li><code>dynamique</code> capacité d&rsquo;actionner les éléments mobiles</li></ul><h2 id=opérations>Opérations</h2><ul><li><strong>espacement</strong>: Observer l&rsquo;état d&rsquo;une zone</li><li><strong>routage</strong>: Verrouiller et déverrouiller la zone : permet d&rsquo;obtenir un droit d&rsquo;action. Toutes les opérations en écriture nécessitent d&rsquo;avoir acquis le verrou.</li><li><strong>routage</strong>: Attendre que toutes les réservations d&rsquo;une zone expirent</li><li><strong>routage</strong>: Pré-réserver une configuration de zone</li><li><strong>routage</strong>: Confirmer la réservation d&rsquo;une zone</li><li><strong>routage</strong>: Attendre que la réservation de la zone soit occupée par son train</li><li><strong>routage</strong>: Relacher une réservation de zone</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-db83f9bbda0f6a9be54f5872c94185f4>2.1.4 - Routage</h1><div class=lead>Gère le cycle des routes</div><h2 id=description>Description</h2><ul><li>Les routes ont pour responsabilité d&rsquo;autoriser le déplacement des trains dans l&rsquo;infrastructure. Elles doivent se terminer à un point où l&rsquo;arrêt du train est prévu (en terme de signalisation, pas voyageur).</li><li>Les routes sont assimilables à des itinéraires, ou à des suites d&rsquo;itinéraires et d&rsquo;installations de pleine voie.</li><li>Les routes n&rsquo;ont pas de lien direct avec le cantonnement et la signalisation. Elles nourrissent des informations sur la disponibilité des voies qui sont utilisées par le cantonnement et la signalisation.</li><li>Une route est un chemin de détecteur en détecteur. Elle représente une portion de chemin qu&rsquo;il est sûr pour un train d&rsquo;emprunter.</li><li>Les routes ont des points de libération, qui sont des détecteurs qui délimitent quand détruire l&rsquo;itinéraire, ce qui permet d&rsquo;implémenter transit souple, rigide, et entre-deux.</li><li>Une route peut être à nouveau formée alors qu&rsquo;un train est déjà en train de la parcourir. Cela permet à plusieurs trains de se suivre sur la même route.</li></ul><h3 id=cycle-de-vie-dune-route>Cycle de vie d&rsquo;une route</h3><p>Les routes n&rsquo;ont pas d&rsquo;état, mais leur commande donne lieu à une suite d&rsquo;événements systématique :</p><ul><li>le système commande toutes les routes sur le trajet du train dans l&rsquo;ordre, sans attendre<ul><li>la commande doit être acceptée par le <strong>régulateur</strong></li></ul></li><li>lorsque le régulateur accepte la commande, la <strong>formation</strong> commence<ul><li>le droit d&rsquo;action de chaque zone de la route est acquis, selon un ordre global</li><li>en parallèle pour toutes les zones:<ul><li>si la zone n’est pas dans la configuration souhaitée:<ul><li>si elle est déjà réservée, attendre que les réservations expirent</li><li>sinon, la mettre dans la configuration souhaitée en déplaçant les aiguilles</li></ul></li><li>pré-réserver la zone pour le passage du train</li><li>le droit d&rsquo;action de la zone est cédé</li></ul></li></ul></li><li>une fois que la formation est terminée, la route est <strong>établie</strong><ul><li>pour chaque zone, transformer la pré-réservation du train en réservation</li></ul></li><li>dès que la route est établie, un processus de <strong>destruction de la route</strong> commence<ul><li>pour chaque zone de la route donnant lieu à une libération<ul><li>attendre que le train quitte la zone (que la réservation passe de l&rsquo;état <code>OCCUPIED</code> à l&rsquo;état <code>PENDING_RELEASE</code>)</li><li>libérer la réservation des zones du début de la route jusqu&rsquo;à la zone actuelle</li></ul></li></ul></li></ul><div class="alert alert-info" role=alert><h4 class=alert-heading>Piste d'évolution</h4>Certains postes d&rsquo;aiguillages ont un enclenchement entre itinéraires de sens contraire (affrontement) qui empêche l&rsquo;activation d&rsquo;une route en menant à une zone avec un transit en sens contraire. Il serait envisageable de réserver une zone supplémentaire à la fin du chemin protégé par la route, par sécurité.</div><div class="alert alert-info" role=alert><h4 class=alert-heading>Piste d'évolution</h4>Certains itinéraires en gare ne permettent pas le partage du chemin par plusieurs trains</div><div class="alert alert-info" role=alert><h4 class=alert-heading>Piste d'évolution</h4>En pratique, il pourrait être intéressant d&rsquo;introduire une notion de route partielle afin de réduire le nombre de routes nécessaires: une route partielle est une portion de route qu&rsquo;il n&rsquo;est pas sûr d&rsquo;activer indépendament.</div><h2 id=exigences-de-conception>Exigences de conception</h2><p>Le système doit, indirectement ou directement:</p><ul><li>permettre à la <strong>signalisation</strong> de déterminer si une section de voie est <strong>prête à être empruntée</strong>.</li><li>permettre l&rsquo;<strong>ordonnancement</strong> des trains selon des critères configurables.</li><li>permettre la destruction progressive (<strong>transit souple</strong>) de l&rsquo;itinéraire après le passage du train.</li><li>il doit être possible d&rsquo;avoir plusieurs processus de commande actifs au même moment pour la même route, afin de supporter des trains qui se suivent</li></ul><h2 id=dépendances>Dépendances</h2><ul><li><p><code>statique</code> le chemin des routes de détecteur à détecteur</p></li><li><p><code>statique</code> la position requise des aiguilles, par zone</p></li><li><p><code>statique</code> les points de libération des zones (qui implémentent le transit souple / rigide)</p></li><li><p><code>dynamique</code> <code>régulateur</code> soumettre des commandes</p></li><li><p><code>dynamique</code> <code>réservation</code> acquérir et relacher un droit d&rsquo;action par zone</p></li><li><p><code>dynamique</code> <code>réservation</code> attendre que les réservations d&rsquo;une zone expirent</p></li><li><p><code>dynamique</code> <code>éléments mobiles</code> déplacer des aiguilles</p></li><li><p><code>dynamique</code> <code>réservation</code> pré-réserver une zone</p></li><li><p><code>dynamique</code> <code>réservation</code> promouvoir une pré-réservation en réservation</p></li><li><p><code>dynamique</code> <code>réservation</code> lors de la destruction de la route, attendre qu&rsquo;une réservation passe en <code>PENDING_RELEASE</code></p></li><li><p><code>dynamique</code> <code>réservation</code> libérer une réservation</p></li></ul><h2 id=opérations>Opérations</h2><ul><li><strong>commander une route</strong>: démarre un processus asynchrone qui ne se terminera que lorsque la route aura été établie. <strong>Un processus de destruction doit démarrer dès que la route est établie</strong>.</li></ul><h2 id=notes-de-conception>Notes de conception</h2><p>Ces notes permettent d&rsquo;expliquer les décisions qui ont été prises, afin de pouvoir plus aisément les comprendre et évoluer.</p><h3 id=informer-la-signalisation>Informer la signalisation</h3><p>Sachant que:</p><ul><li>il peut y avoir beaucoup de zones partant d&rsquo;un même point, il est préférable d&rsquo;éviter de contraindre les signaux à observer une liste de routes</li><li>il est potentiellement difficile d&rsquo;associer un état clair à chaque route</li></ul><p>Il en ressort plusieurs manières d&rsquo;informer la signalisation de la navigabilité des voies:</p><ul><li>soit <strong>directement</strong>, en faisant observer à la signalisation les points d&rsquo;entrée des routes. Si plusieurs routes partent du même endroit, elles partageraient un objet entrée:<ul><li>moins de complexité dans la couche de réservation, plus de complexité dans la couche de routage</li></ul></li><li>soit <strong>indirectement</strong>, via la couche de réservation des zones, qui auraient un état supplémentaire pour marquer leur navigabilité:<ul><li>moins de complexité dans la couche de routage, plus de complexité dans la couche de réservation</li><li><code>avantage</code> le processus d&rsquo;activation des routes n&rsquo;aurait pas besoin d&rsquo;attendre l&rsquo;arrivée du train, la couche de réservation s&rsquo;en occuperait.</li><li><code>avantage</code> découplage entre routage et cantonnement / signalisation.</li></ul></li></ul><p>La seconde option a été choisie, car :</p><ul><li>elle permet d&rsquo;avoir un couplage moins fort entre la signalisation et les routes.</li><li>elle évite aussi au processus d&rsquo;activation des routes d&rsquo;attendre le passage du train alors que la couche de réservation le fait déjà.</li></ul><h3 id=cycle-de-vie-des-routes-et-état-des-zones>Cycle de vie des routes et état des zones</h3><p>Plusieurs enjeux motivent le cycle de vie des routes et l&rsquo;état des zones :</p><ul><li>d&rsquo;une part, l&rsquo;état des zones est au coeur de la détection de conflit : il doit être possible d&rsquo;extraire d&rsquo;une simulation d&rsquo;un train seul ses besoins en ressources</li><li>d&rsquo;autre part, il faut qu&rsquo;une simulation multi-train fonctionne correctement : le temps de déplacement des aiguilles selon la configuration actuellement en place, en particulier, est un point de friction important</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d84f7d18068af2c677e12c6761184b2f>2.1.5 - Ordonnancement</h1><div class=lead>Décide de l&rsquo;ordre de formation des itinéraires</div><div class="alert alert-warning" role=alert>Cette page est une ébauche, contribuez-y!</div><h2 id=définition>Définition</h2><p>La couche d&rsquo;ordonnancement a pour responsabilité d&rsquo;établir l&rsquo;ordre de commande des itinéraires, et par conséquent, l&rsquo;ordre de passage des trains.
La méthode exacte utilisée pour prendre cette décision n&rsquo;importe pas, du moment qu&rsquo;elle garantit que la simulation se termine (elle ne doit pas amener de trains en nez-à-nez, ou créer d&rsquo;autres cas de figure de blocage).</p><p>Il est possible d&rsquo;implémenter un module d&rsquo;ordonnancement via des tableaux d&rsquo;ordre de succession des trains aux aiguilles.</p><h2 id=exigences-de-conception>Exigences de conception</h2><ul><li>Il doit être possible de connecter n&rsquo;importe quel algorithme d&rsquo;ordonnancement</li><li>Le module d&rsquo;ordonnancement doit approuver les commandes de routes.</li></ul><h2 id=opérations>Opérations</h2><ul><li><strong>train</strong>: Des itinéraires sont <strong>commandés</strong> pour chaque trains, aussi loin et aussi tôt que possible. L&rsquo;approbation de la commande est soumise au régulateur, qui peut la retarder indéfiniment, selon des critères de son choix.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7430cbed022a567839d982205fb6211d>2.1.6 - Train</h1><div class=lead>Représente un train dans la simulation</div><h2 id=description>Description</h2><p>Les contraintes sur ce qu&rsquo;est un train sont relativement faibles.
Il doit seulement avoir un identifiant, qui permet aux autres systèmes de garder des références vers des trains.</p><h2 id=exigences-de-conception>Exigences de conception</h2><ul><li>Les trains <strong>occupent les zones</strong>.</li><li>Les trains doivent être <strong>suivis</strong> pour préserver leur <strong>ordre de passage</strong>.</li><li>Les trains ont pour responsabilité de <strong>demander les itinéraires</strong> devant eux.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2a67b560f64e237130e37a54280c81f6>2.2 - Recherche de sillons de dernière minute (STDCM)</h1><p>OSRD permet d&rsquo;ajouter un nouveau train dans une grille horaire déjà établie,
sans générer aucun conflit avec les autres trains. L&rsquo;application directe de cette fonctionnalité
est appelée la <strong>recherche de sillon de dernière minute</strong>.</p><p>L&rsquo;acronyme STDCM (Short Term Digital Capacity Management) est utilisé
pour parler du concept en général.</p></div><div class=td-content><h1 id=pg-5e6a8c58f44ec33565becd41e00148ef>2.2.1 - Contexte métier</h1><p>Quelques définitions :</p><h3 id=la-capacité>La capacité</h3><p>La <strong>capacité</strong>, dans ce contexte, correspond à la possibilité de
réserver des éléments d&rsquo;infrastructure pour permettre le passage
d&rsquo;un train.</p><p>La capacité s&rsquo;exprime en fonction de l&rsquo;espace et du temps :
la réservation d&rsquo;un élément peut bloquer une zone précise
qui devient inaccessible aux autres trains, et cette réservation
se fait sur un intervalle de temps.</p><p>On peut la représenter
sur un graphique, avec le temps en abscisse et la distance parcourue
sur un chemin en ordonnée.</p><p><img src=space_time_chart.png alt="Graphique espace temps"></p><blockquote><p>Exemple d&rsquo;un graphique espace-temps montrant le passage d&rsquo;un train.</p><p>Les couleurs représentent ici les aspects des signaux, mais
montrent également une consommation de la capacité :
quand ces blocs se superposent pour deux trains, ils sont en conflit.</p></blockquote><p>Deux trains d&rsquo;une grille horaire sont en <strong>conflit</strong>
quand ils réservent en même temps un même objet, dans des
configurations incompatibles.</p><p><img src=conflict.png alt="Graphique espace temps avec conflit"></p><blockquote><p>Exemple d&rsquo;un graphique espace-temps avec conflit : le second train
est plus rapide que le premier, ils sont en conflit sur la fin du trajet,
quand les rectangles se superposent.</p><p>En essayant de simuler cette grille horaire, le second train serait
ralentis par des signaux indiquant de ralentir, provoqués par la
présence du premier train.</p></blockquote><p>La consommation de capacité est souvent représentée sous la forme de
rectangles car, dans les systèmes de signalisation les plus simples,
il s&rsquo;agit de réservations d&rsquo;une zone fixe dans l&rsquo;espace pendant un intervalle de temps donné.</p><h3 id=les-sillons-horaires>Les sillons horaires</h3><p>Un <strong>sillon</strong> correspond à une réservation de capacité pour le
passage d&rsquo;un train. Il est fixé dans l&rsquo;espace et dans le temps :
le temps de départ et le chemin emprunté sont connus.
Sur les graphiques espace-temps de cette page, un sillon correspond
à l&rsquo;ensemble des blocs pour un train.</p><p>Dans un fonctionnement habituel, le gestionnaire d&rsquo;infrastructure
(ex : SNCF Réseau) propose des sillons à la vente pour les entreprises
ferroviaires (ex : SNCF Voyageurs).</p><p>À une date donnée avant le jour de
circulation prévu, tous les sillons sont attribués. Mais <strong>il peut rester
assez de capacité pour faire rouler plus de trains</strong>. Il est
possible de placer des trains entre les sillons déjà établis,
quand ces derniers sont suffisamment espacés ou n&rsquo;ont pas
trouvé d&rsquo;acheteurs.</p><p>La capacité restante après l&rsquo;attribution des sillons est appelée
la <strong>capacité résiduelle</strong>. Le problème traité ici est la recherche
de sillons dans celle-ci.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-43ea4c19a1c68f9d3854a75420fe7d2b>2.2.2 - Module de recherche de sillons</h1><p>Ce module gère la recherche de solution.</p><p>Les entrées et sorties sont fortement simplifiées et abstraites
pour simplifier le problème au maximum et permettre des tests efficaces.</p><p>Pour décrire son fonctionnement en quelques phrases :
l&rsquo;espace de solutions est représenté sous forme d&rsquo;un graphe qui encode le temps,
la position et la vitesse. Une recherche de chemin est ensuite effectuée
dans ce graphe pour trouver une solution. Le graphe est calculé
au fil de son exploration.</p><p>Ce graphe peut d&rsquo;une certaine manière être vu comme une forme
d&rsquo;arbre de décision, si différents chemins peuvent mener au même noeud.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4b08bb54f5d63f53d5513a974bbf1597>2.2.2.1 - Parcours de l'infrastructure</h1><p>La première chose à définir est <em>comment un train se déplace sur l&rsquo;infrastructure</em>,
sans prendre en compte les conflits pour l&rsquo;instant.</p><p>On a besoin d&rsquo;une manière de définir et d&rsquo;énumérer les différents chemins
possibles et de parcourir l&rsquo;infrastructure, avec plusieurs contraintes :</p><ol><li>Le chemin doit être compatible avec le matériel roulant donné
(électrification, gabarit, systèmes de signalisation)</li><li>À n&rsquo;importe quel point, on doit être en mesure d&rsquo;accéder aux propriétés
du chemin depuis le point de départ jusqu&rsquo;au point considéré.
Cela inclus les routes et les cantons.</li><li>Dans certains cas, on doit savoir où le train ira <em>après</em>
le point actuellement évalué (pour une détection de conflits correcte).</li></ol><p>Pour répondre à ce besoin, une classe <code>InfraExplorer</code> a été implémentée.
Elle utilise les cantons (section de signal en signal) comme subdivision
principale.
Elle est composée de 3 sections : le canton courant, les prédécesseurs,
et les cantons suivants.</p><p><img src=infra_explorer.svg alt="InfraExplorer structure"></p><p>Dans cet exemple, les flèches vertes sont les cantons précédents.
Ce qui se produit dessus est considéré comme immuable.</p><p>La flèche rouge est le canton actuellement exploré.
C&rsquo;est à cet endroit que les simulations du train et de la
signalisation sont effectuées, et que les conflits
sont évités.</p><p>Les flèches bleues sont les cantons suivants. Cette section
n&rsquo;est pas encore simulée, elle existe seulement pour savoir
où le train ira ensuite. Dans cet exemple, elle indique
que le signal en bas à droite peut être ignoré, seul
le chemin du haut sera utilisé.
Le chemin du bas sera évalué dans une autre instance de
<code>InfraExplorer</code>.</p><p>Plus de détails sur la classe et son interface sont
présents sur la version anglaise de la page.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-dd3ee9974c77fa971af65f7002bc8aa5>2.2.2.2 - Détection de conflits</h1><p>Maintenant qu&rsquo;on sait quels chemins peuvent être utilisés,
on doit déterminer à quel moment ces chemins sont libres.</p><p>La documentation (en anglais seulement)
de la détection de conflits explique comment elle est réalisée
en interne. Pour résumer, un train est en conflit avec un autre
quand il observe un signal lui indiquant de ralentir.
Dans notre cas, une solution où cette situation se produit
est considérée comme invalide, le train doit arriver
au signal donné plus tard (ou plus tôt) quand le signal
n&rsquo;est plus contraignant.</p><p>Cependant, la détection de conflit doit être réalisée de
manière <em>incrémentale</em>, ce qui veut dire que :</p><ol><li>Quand une simulation est effectuée jusqu&rsquo;à t=x, tous les conflits
qui arrivent avant t=x doivent être connus, <em>même s&rsquo;ils sont
indirectement provoqués par un signal vu à t > x</em> plus loin sur le chemin.</li><li>Les conflits et utilisations de ressources doivent être identifiés
dès qu&rsquo;ils se produisent, même si le temps de fin d&rsquo;utilisation n&rsquo;est
pas encore défini.</li></ol><p>Pour que ce soit possible, on doit être en mesure de savoir où
le train ira <em>après</em> la section actuellement simulée (cf
<a href=https://osrd.fr/fr/docs/reference/design-docs/stdcm/pathfinding_module/infrastructure_exploration/ title="exploration de l'infrastructure">exploration de l&rsquo;infrastructure</a>
)</p><p>Pour gérer ce cas, le module de détection de conflit
peut renvoyer une erreur quand il est nécessaire d&rsquo;avoir
plus d&rsquo;information sur la suite du chemin. Quand ce cas
se produit, les objets <code>InfraExplorer</code> sont clonés
pour étendre les chemins.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0b86147cbfa958e9f4364f4ce2ba795b>2.2.2.3 - Représentation de l'espace de solutions</h1><h4 id=principe-général>Principe général</h4><p>Le problème reste une recherche de graphe. En représentant
l&rsquo;espace de solution sous forme de graphe, il est possible de réutiliser
nos outils déjà existants de recherche de chemin.</p><p>Le <em>graphe produit</em> de la position, du temps, et de la vitesse est utilisé.
Autrement dit, chaque élément du graphe contient (entre autres) ces
3 variables.</p><p>Chaque arête du graphe est calculée avec un
<a href=https://osrd.fr/fr/docs/explanation/running_time_calculation/ title="calcul de marche">calcul de marche</a>
pour connaître l&rsquo;évolution de la vitesse et de la position dans le temps.</p><h4 id=représentation-visuelle>Représentation visuelle</h4><p>Le graphe de départ représente l&rsquo;infrastructure physique</p><p><img src=routes_time_1.png alt="Graphe produit (1/3)"></p><p>Il est ensuite &ldquo;dupliqué&rdquo; à des temps différents</p><p><img src=routes_time_2.png alt="Graphe produit (2/3)"></p><p>Puis des nœuds sont reliés de manière à refléter le temps de parcours</p><p><img src=routes_time_3.png alt="Graphe produit (3/3)"></p><h4 id=précisions>Précisions</h4><ul><li>Le graphe est construit <em>au fil de l&rsquo;exploration</em>.</li><li>Une discrétisation est faite au niveau du temps, uniquement pour
évaluer ce qui a déjà été visité. Si le même emplacement est visité une
seconde fois, il faut une certaine différence de temps pour estimer
qu&rsquo;il n&rsquo;est pas déjà visité.</li><li>Toutes les arêtes sont réalisées avec des calculs de marche</li><li>La vitesse n&rsquo;est pas discrétisée ni utilisée pour estimer quel
emplacement est déjà visité, mais elle fait partie des calculs.</li><li>Par défaut, tous les calculs sont faits en allant à la vitesse maximale.
Les ralentissements sont ajoutés seulement quand ils sont nécessaires.</li></ul><h4 id=exemple>Exemple</h4><p>Par exemple, avec l&rsquo;infrastructure suivante en se basant sur
le graphe des voies :
<img src=example_infra.svg alt="Infra d&rsquo;exemple"></p><p>Explorer le graphe des sillons possibles peut donner ce
type de résultat :
<img src=example_graph.svg alt="Représentation du graphe"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4cbbf502b73f6a39d1784fb6ef5fc8bf>2.2.2.4 - Discontinuités et retours en arrière</h1><h4 id=le-problème-des-discontinuités>Le problème des discontinuités</h4><p>Au moment d&rsquo;explorer une arête du graphe, on effectue un calcul de
marche pour connaître l&rsquo;évolution de la vitesse.
Mais il n&rsquo;est pas possible de voir plus loin que l&rsquo;arête en question,
ce qui est gênant pour calculer les courbes de freinages qui peuvent
nécessiter de commencer à freiner plusieurs kilomètres avant l&rsquo;arrivée.</p><p><img src=discontinuity.png alt=Discontinuité></p><blockquote><p>Cet exemple illustre le problème : par défaut
la première arête est explorée en allant à la vitesse maximale.
C&rsquo;est seulement en explorant la seconde arête que la destination devient visible,
sans que la distance restante soit suffisante pour s&rsquo;arrêter.</p></blockquote><h4 id=la-solution--revenir-en-arrière>La solution : revenir en arrière</h4><p>Pour régler ce problème, lorsqu&rsquo;une arête est générée avec une discontinuité
dans les courbes de vitesse, l&rsquo;algorithme revient sur les arêtes précédentes
pour en créer des nouvelles qui incluent les décélérations.</p><p>Pour donner un exemple simplifié, sur un chemin de 4 routes
où le train peut accélérer ou décélérer de 10km/h par route :</p><p><img src=backtracking_1.png alt="Discontinuité (version arêtes, 1/2)"></p><p>Pour que le train s&rsquo;arrête à la fin de la route 4, il doit être au plus à 10km/h
à la fin de la route 3. Une nouvelle arête est alors créée sur la route
3 qui finit à 10km/h. Une décélération est ensuite calculée à rebours de la fin de la route
vers le début, jusqu&rsquo;à retrouver la courbe d&rsquo;origine (ou le début
de l&rsquo;arrête).</p><p>Dans cet exemple, la discontinuité a seulement été déplacée vers la
transition entre les routes 2 et 3. Le procédé est ensuite réitéré
sur la route 2, ce qui donne le résultat suivant :</p><p><img src=backtracking_2.png alt="Discontinuité (version arêtes, 2/2)"></p><p>Les anciennes arêtes sont toujours présentes dans le graphe, elles
peuvent mener à d&rsquo;autres solutions.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-86a0f2f4d5cb5405bb586c1fba4d4c0a>2.2.2.5 - Contourner les conflits</h1><p>En explorant le graphe, il arrive souvent de tomber sur des situations
qui mèneraient à des conflits. Il faut être en mesure de rajouter du délai
pour les éviter.</p><h4 id=décalage-du-temps-de-départ>Décalage du temps de départ</h4><p>Dans les paramètres de l&rsquo;algorithme, le temps de départ est donné
sous la forme d&rsquo;une fenêtre : un temps de départ au plus tôt et au plus tard.
Tant que c&rsquo;est possible, il est toujours préférable de décaler le temps
de départ pour éviter les conflits.</p><blockquote><p>Par exemple : un train doit partir entre 10:00 et 11:00. En partant
à 10:00, cela provoque un conflit, le train doit entrer en gare
d&rsquo;arrivée 15 minutes plus tard. Il suffit de faire partir le train à
10:15 pour régler le problème.</p></blockquote><p>Dans OSRD, cette fonctionnalité est gérée en gardant une trace,
à chaque arête, du décalage maximal du temps de départ qui pourra
être ajouté sur la suite du parcours. Tant que cette valeur est suffisante,
tous les conflits sont évités par ce moyen.</p><p>Le décalage du temps de départ est une valeur stockée sur chaque arête
et additionnée à la fin de la recherche de chemin.</p><blockquote><p>Par exemple :</p><ul><li>un train doit partir entre 10:00 et 11:00. La recherche
commence avec un délai maximal de 1:00.</li><li>Après quelques arêtes, une non-disponibilité est constatée
20 minutes après notre passage. La valeur passe donc à
20 minutes pour la suite du parcours.</li><li>Le temps de départ est ensuite décalé de 5 minutes pour contourner
un conflit, modifiant le décalage maximal à 15 minutes.</li><li>Ce procédé continue jusqu&rsquo;à arriver à la fin du trajet, ou
jusqu&rsquo;au point où il faut ajouter plus de délai.</li></ul></blockquote><h4 id=marges-de-construction>Marges de construction</h4><p>Quand la valeur de décalage maximal du temps de départ tombe à 0,
il faut rajouter du délai entre deux points du parcours du train.</p><p><img src=engineering_allowance.png alt="Marge de construction (1/2)"></p><p>Le principe est le même que pour régler les discontinuités de vitesse :
le graphe est parcouru en arrière pour créer de nouvelles arêtes.</p><p><img src=engineering_allowance_edges.png alt="Marge de construction (2/2)"></p><p>La <a href=https://osrd.fr/fr/docs/explanation/running_time_calculation/allowances/ title=marges>marge de construction</a>
est une fonctionnalité du calcul de marche
permettant d&rsquo;ajouter un délai donné entre deux points du parcours.</p><h2 id=post-processing>Post-processing</h2><p>Les marges de constructions <em>étaient</em> calculées pendant
l&rsquo;exploration du graph, mais ce procédé était trop
couteux en temps de calcul. On effectuait des dichotomies
sur des simulations qui pouvaient s&rsquo;étendre sur des
portions importantes du chemin.</p><p>On a seulement besoin de savoir si la marge de construction
<em>peut</em> être réalisée sans provoquer de conflit.
Des heuristiques peuvent être utilisées ici tant qu&rsquo;on est
plus restrictif que permissif : une marge impossible
doit être identifiée comme telle, mais manquer une solution
avec une marge extrêmement serrée n&rsquo;est pas une mauvaise chose.</p><p>Mais avec ce changement, une fois qu&rsquo;une solution est trouvée,
il ne suffit plus de concaténer les résultats de simulation
pour obtenir la simulation finale. On doit réaliser une
simulation complète avec les vraies marges de construction
qui évitent tout conflit. Cette étape se rejoint avec celle
décrite pour les
<a href=https://osrd.fr/fr/docs/reference/design-docs/stdcm/pathfinding_module/standard_allowance/ title="marges de régularité">marges de régularité</a>,
qui est maintenant réalisée même sans marge de régularité
spécifiée.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-878a5654bd8bd9fb14457386180665c4>2.2.2.6 - Marge de régularité</h1><p>Une des fonctionnalités qui doit être supportée par STDCM est la
<a href=https://osrd.fr/fr/docs/explanation/running_time_calculation/allowances/ title="marge de régularité">marge de régularité</a>.
L&rsquo;utilisateur doit pouvoir indiquer une valeur
de marge, exprimée en fonction de la distance ou du temps de parcours,
et cette marge doit être ajoutée au trajet.</p><blockquote><p>Par exemple : l&rsquo;utilisateur peut indiquer une marge de 5 minutes au
100km. Sur un trajet de 42km, un trajet de 10 minutes au plus rapide
doit maintenant durer 12 minutes et 6 secondes.</p></blockquote><p>Le problème se situe au niveau de la détection de conflits.
En effet, ralentir le train décale l&rsquo;ensemble du sillon dans le temps
et augmente la capacité consommée.
La marge doit donc être prise en compte pendant l&rsquo;exploration
pour détecter correctement les conflits.</p><p>Pour plus de difficulté, la marge doit suivre le modèle
<a href=/pdf/MARECO.pdf>MARECO</a>.
La marge n&rsquo;est pas répartie uniformément sur le trajet, mais selon
un calcul qui nécessite de connaître l&rsquo;ensemble du trajet.</p><h3 id=pendant-lexploration>Pendant l&rsquo;exploration</h3><p>La principale implication de la marge de régularité est pendant
l&rsquo;exploration du graphe, quand on identifie les conflits.
Les temps et les vitesses doivent être baissés linéairement
pour prendre en compte les conflits au bon moment.
La simulation au plus rapide doit tout de même être calculée
car elle peut définir le temp supplémentaire.</p><p>Ce procédé <em>n&rsquo;est pas exact</em> car il ignore la manière dont
la marge est appliquée (en particulier pour MARECO).
Mais à cette étape les temps exacts ne sont pas nécessaires,
il est seulement nécessaire de savoir si une solution existe
à ce temps approximatif.</p><div class="alert alert-info" role=alert>Ce procédé inexact peut sembler être un problème, mais en
pratique (pour la SNCF) les marges de régularités ont en
fait une tolérance entre deux points arbitraires
du chemin. Par exemple pour une marge indiquée à 5 minutes
par 100km, une solution avec la marge entre 3 et 7 minutes
entre deux PR serait acceptable. Cette tolérance ne sera
pas encodée explicitement, mais elle
permet de faire des approximations de quelques
secondes pendant la recherche.</div><h4 id=post-processing>Post-processing</h4><p>Une fois que le chemin est trouvé, il est nécessaire
de faire une simulation finale pour appliquer correctement
les marges. Le procédé est le suivant :</p><ol><li>Pour certains points du chemin, le temps est fixé.
C&rsquo;est un paramètre d&rsquo;entrée de la simulation qui appelle
le module de marge. À l&rsquo;initialisation, le temps est fixé
à chaque point d&rsquo;arrêt.</li><li>Une simulation est réalisée. En cas de conflit, on
s&rsquo;intéresse au premier</li><li>Un point est fixé à la position de ce conflit.
Le temps de référence est celui considéré pendant l&rsquo;exploration.</li><li>Ce procédé est répété itérativement jusqu&rsquo;à une absence de conflit</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-9789474a8d15fe1be9951465d5eb1361>2.2.2.7 - Détails d'implémentation</h1><p>Cette page précise certains détails d&rsquo;implémentation.
Sa lecture n&rsquo;est pas nécessaire pour comprendre les principes
généraux, mais peut aider avant de se plonger dans le code.</p><h4 id=stdcmedgebuilder>STDCMEdgeBuilder</h4><p>Cette classe est utilisée pour simplifier la création d&rsquo;instances de <code>STDCMEdge</code>,
les arêtes du graphe. Celles-ci contiennent de nombreux attributs,
la plupart pouvant être déterminés en fonction du contexte (comme
le nœud précédent). La classe <code>STDCMEdgeBuilder</code> permet de rendre
certains attributs optionnels et en calcule d&rsquo;autres.</p><p>Une fois instancié et paramétré, un <code>EdgeBuilder</code> a deux méthodes :</p><ul><li><p><code>Collection&lt;STDCMEdge> makeAllEdges()</code> permet de créer toutes
les arêtes possibles dans le contexte donné pour une route donnée.
S&rsquo;il y a plusieurs &ldquo;ouvertures&rdquo; entre des blocks d&rsquo;occupation,
une arête est créée par ouverture. Tous les conflits, leurs
évitements et les attributs associés sont déterminés ici.</p></li><li><p><code>STDCMEdge findEdgeSameNextOccupancy(double timeNextOccupancy)</code> :
Cette méthode permet d&rsquo;obtenir l&rsquo;arête passant par une certaine
&ldquo;ouverture&rdquo; (quand elle existe), identifiée ici par le temps
de la prochaine occupation sur la route. Elle est utilisée à chaque
fois qu&rsquo;une arête doit être re-créée dans un contexte différent,
comme pour appliquer une marge ou corriger une discontinuité.
Elle appelle la méthode précédente.</p></li></ul><h3 id=recherche-de-chemin>Recherche de chemin</h3><h4 id=evaluation-des-distances>Evaluation des distances</h4><p>La fonction utilisée pour déterminer la distance (au sens
de la recherche de chemin) détermine quel chemin sera privilégié.
Le chemin obtenu sera toujours le plus court en fonction du critère
donné.</p><p>Ici, deux paramètres sont utilisés : le temps de parcours total
et l&rsquo;heure de départ. Le second a un poids très faible par rapport
au premier, pour sélectionner en priorité le chemin le plus rapide.
Les détails du calcul sont indiqués dans les commentaires des
méthodes concernées.</p><h4 id=heuristiques>Heuristiques</h4><p>L&rsquo;algorithme de recherche de chemin dans le graphe est un A*,
avec une heuristique basée sur les coordonnées géographiques.</p><p>Cependant, la géométrie des infrastructures générées sont arbitraires,
elle ne correspond pas aux distances indiquées sur les voies.
Il est donc possible que, sur ces infrastructures, les chemins
obtenus ne soient pas les plus courts.</p><p>Il est en théorie possible d&rsquo;utiliser cette heuristique pour
déterminer si le chemin en cours d&rsquo;exploration pourra mener à une
solution dont le temps de parcours ne dépasse pas le maximum.
Mais pour la même raison, ajouter ce critère rend STDCM
inutilisable sur les infrastructures générées.
Plus de détails dans
<a href=https://github.com/osrd-project/osrd/issues/2818>cette issue</a>.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/osrd-project/osrd aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2024 Contributeurs à OSRD. Tous droits réservés</span></div></div></div></footer></div><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><script src=https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js integrity="sha512-ku2nmBrzAXY5YwohzTqLYH1/lvyMrpTVxgQKrvTabd/b/uesqltLORdmpVapYv6QhZVCLUX6wkvFaKOAY4xpUA==" crossorigin=anonymous></script><script src=/js/main.min.4261519102c0270f3bdd4edcd2b45867ee7a584a0ea82c94f59e4f991c6337a1.js integrity="sha256-QmFRkQLAJw873U7c0rRYZ+56WEoOqCyU9Z5PmRxjN6E=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>