<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=alternate type=text/html href=https://osrd.fr/en/docs/reference/design-docs/editoast-errors/_print/><link rel=alternate type=application/rss+xml href=https://osrd.fr/en/docs/reference/design-docs/editoast-errors/index.xml><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Editoast error management | OSRD</title>
<meta name=description content='Issues of the old system Mix between internal errors and API errors Errors are converted into InternalError early, which means that a caller of a function returning an editoast::Result will have some trouble matching on the error returned That means that it’s troublesome to add context to an existing error, or to wrap it into another higher-level one. We can’t track at compile-time which errors are returned by each function: that means that we don’t know for sure which errors an endpoint can return (without careful manual investigation at least…) Consequently, we hardly can declare in the OpenApi file what errors an endpoint precisely returns, degrading the editoast API quality The frontend still requires editoast to declare all its errors though, to ensure they are translated properly. To achieve that we dynamically collect each EditoastError using the crate inventory. All the error descriptions collected are then transformed into OpenAPI schemas procedurally. On top of being a Rust antipattern (collecting state in proc-macros), this is complex to maintain on both editoast and frontend sides. Not having each endpoint linked to the list of errors it can raise, also prevents the frontend easily handling errors properly. It’s still unclear how we should expose errors from Core. Goals Have a clear separation between logically distinct errors. Dispose of a way to actually match on errors when they occur deeper in the stack Separate the error definition and their serialization. Establish how we want to forward Core’s errors. Tie the errors to the endpoint they originate from in the OpenAPI. Constraints Keep the same error format (for backward compatibility reasons to avoid involving the frontend too much). We must keep the editoast: prefix in the error type. The error must live until it is handled, conversion to our standard error format only happens in the response serialization. Errors must implement std::error::Error. Errors must be composable. This will typically be handled by thiserror’s #[from] attribute. Error variants must be shareable to ensure the deduplication of error kinds. For example, let’s say we have two functions get_infra(id: usize) and rename_infra(id: usize, name: String). Both functions error types have to include a variant describing the error case of an infrastructure not being found by its ID. However, we can’t duplicate something like InfraNotFound { id: usize } in both error types as this leads to two different error paths describing the same error case. This is especially problematic for error translation keys. We need to be able to define an error InfraNotFound and include it in both error types. A unicity check may be performed in the post-processing of the OpenAPI file to ensure that each error has a unique error type. Each endpoint must provide all its error cases in the OpenAPI. (How the frontend will consume them is another problem that we’ll have to deal with.) As for OSRD errors, the context field of the error is populated in the views. Errors can be handled in a generic manner (for situations where it makes some sense to do so). I.e.: some form of downcasting is available. New system Rely on thiserror everywhere. Keep the trait EditoastError but only implement it for errors defined in views. Since it is only used in views now, let’s rename it to trait ViewError. Create a proc-macro derive(ViewError) which interfaces with derive(thiserror::Error). The context is empty by default but can be provided by the impl ViewError. The macro is also able to take context providers. ViewError’s #[source], #[from], source and backtrace fields are never serialized, unless explicitly provided. This shouldn’t be the case as it exposes editoast internals at the API level. impl<T: ViewError> utoipa::IntoResponses for T (may be generated or inferred) Errors should not implement Serialize except for view errors (derive(ViewError)) which generates an impl ViewError used to serialize in the HTTP response. Error cases that will be used repeatedly are defined as a struct but still derive(thiserror::Error). The error_type of each variant is generated by the macro at the format ErrorTypeName::VariantName, but can be provided explicitly if conflicts arise. editoast: will be prepended systematically to indicate the service that raised the error. Since this type is not guaranteed to be unique, we may implement a post-processing step to ensure errors with the same error_type have the same OpenAPI schema. To ease the debugging process, an optional source_location will be provided in ViewErrors containing a link to the GitHub file and line where the error is defined. Nominal case // in mod views; fn get_resource(key: Key) -> Result<Resource, GetError> { todo!() } #[derive(Debug, thiserror::Error)] pub enum GetError { #[error("ID not found")] IdNotFound { id: u64 }, #[error("name not found")] NameNotFound { name: String } } fn process_resource(resource: Resource) -> Result<Computation, ProcessingError> { todo!() } #[derive(Debug, thiserror::Error)] pub enum ProcessingError { #[error("Resource is invalid")] InvalidResource { resource: Resource }, #[error("Resource is too old")] OutdatedResource { resource: Resource } } #[utoipa::path( ..., responses( (status = 200, body = Computation), EndpointError, // impl utoipa::IntoResponse ) )] async fn endpoint(Path(key): Path<Key>) -> Result<Json<Computation>, EndpointError> { let resource = get_resource(key)?; let value = process_resource(resource)?; Ok(Json(value)) } #[derive(Debug, thiserror::Error, ViewError)] pub enum EndpointError { #[error("Resource not found")] #[view_error(user)] // <=> status = 400 ResourceNotFound(#[from] GetError), #[view_error(internal)] // <=> status = 500, default ProcessingFailed(#[from] ProcessingError) } Share errors between crates Since we require no other constraint that impl std::error::Error for composition, it’s easy to nest errors using thiserror.'><meta property="og:url" content="https://osrd.fr/en/docs/reference/design-docs/editoast-errors/"><meta property="og:site_name" content="OSRD"><meta property="og:title" content="Editoast error management"><meta property="og:description" content='Issues of the old system Mix between internal errors and API errors Errors are converted into InternalError early, which means that a caller of a function returning an editoast::Result will have some trouble matching on the error returned That means that it’s troublesome to add context to an existing error, or to wrap it into another higher-level one. We can’t track at compile-time which errors are returned by each function: that means that we don’t know for sure which errors an endpoint can return (without careful manual investigation at least…) Consequently, we hardly can declare in the OpenApi file what errors an endpoint precisely returns, degrading the editoast API quality The frontend still requires editoast to declare all its errors though, to ensure they are translated properly. To achieve that we dynamically collect each EditoastError using the crate inventory. All the error descriptions collected are then transformed into OpenAPI schemas procedurally. On top of being a Rust antipattern (collecting state in proc-macros), this is complex to maintain on both editoast and frontend sides. Not having each endpoint linked to the list of errors it can raise, also prevents the frontend easily handling errors properly. It’s still unclear how we should expose errors from Core. Goals Have a clear separation between logically distinct errors. Dispose of a way to actually match on errors when they occur deeper in the stack Separate the error definition and their serialization. Establish how we want to forward Core’s errors. Tie the errors to the endpoint they originate from in the OpenAPI. Constraints Keep the same error format (for backward compatibility reasons to avoid involving the frontend too much). We must keep the editoast: prefix in the error type. The error must live until it is handled, conversion to our standard error format only happens in the response serialization. Errors must implement std::error::Error. Errors must be composable. This will typically be handled by thiserror’s #[from] attribute. Error variants must be shareable to ensure the deduplication of error kinds. For example, let’s say we have two functions get_infra(id: usize) and rename_infra(id: usize, name: String). Both functions error types have to include a variant describing the error case of an infrastructure not being found by its ID. However, we can’t duplicate something like InfraNotFound { id: usize } in both error types as this leads to two different error paths describing the same error case. This is especially problematic for error translation keys. We need to be able to define an error InfraNotFound and include it in both error types. A unicity check may be performed in the post-processing of the OpenAPI file to ensure that each error has a unique error type. Each endpoint must provide all its error cases in the OpenAPI. (How the frontend will consume them is another problem that we’ll have to deal with.) As for OSRD errors, the context field of the error is populated in the views. Errors can be handled in a generic manner (for situations where it makes some sense to do so). I.e.: some form of downcasting is available. New system Rely on thiserror everywhere. Keep the trait EditoastError but only implement it for errors defined in views. Since it is only used in views now, let’s rename it to trait ViewError. Create a proc-macro derive(ViewError) which interfaces with derive(thiserror::Error). The context is empty by default but can be provided by the impl ViewError. The macro is also able to take context providers. ViewError’s #[source], #[from], source and backtrace fields are never serialized, unless explicitly provided. This shouldn’t be the case as it exposes editoast internals at the API level. impl<T: ViewError> utoipa::IntoResponses for T (may be generated or inferred) Errors should not implement Serialize except for view errors (derive(ViewError)) which generates an impl ViewError used to serialize in the HTTP response. Error cases that will be used repeatedly are defined as a struct but still derive(thiserror::Error). The error_type of each variant is generated by the macro at the format ErrorTypeName::VariantName, but can be provided explicitly if conflicts arise. editoast: will be prepended systematically to indicate the service that raised the error. Since this type is not guaranteed to be unique, we may implement a post-processing step to ensure errors with the same error_type have the same OpenAPI schema. To ease the debugging process, an optional source_location will be provided in ViewErrors containing a link to the GitHub file and line where the error is defined. Nominal case // in mod views; fn get_resource(key: Key) -> Result<Resource, GetError> { todo!() } #[derive(Debug, thiserror::Error)] pub enum GetError { #[error("ID not found")] IdNotFound { id: u64 }, #[error("name not found")] NameNotFound { name: String } } fn process_resource(resource: Resource) -> Result<Computation, ProcessingError> { todo!() } #[derive(Debug, thiserror::Error)] pub enum ProcessingError { #[error("Resource is invalid")] InvalidResource { resource: Resource }, #[error("Resource is too old")] OutdatedResource { resource: Resource } } #[utoipa::path( ..., responses( (status = 200, body = Computation), EndpointError, // impl utoipa::IntoResponse ) )] async fn endpoint(Path(key): Path<Key>) -> Result<Json<Computation>, EndpointError> { let resource = get_resource(key)?; let value = process_resource(resource)?; Ok(Json(value)) } #[derive(Debug, thiserror::Error, ViewError)] pub enum EndpointError { #[error("Resource not found")] #[view_error(user)] // <=> status = 400 ResourceNotFound(#[from] GetError), #[view_error(internal)] // <=> status = 500, default ProcessingFailed(#[from] ProcessingError) } Share errors between crates Since we require no other constraint that impl std::error::Error for composition, it’s easy to nest errors using thiserror.'><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Editoast error management"><meta itemprop=description content='Issues of the old system Mix between internal errors and API errors Errors are converted into InternalError early, which means that a caller of a function returning an editoast::Result will have some trouble matching on the error returned That means that it’s troublesome to add context to an existing error, or to wrap it into another higher-level one. We can’t track at compile-time which errors are returned by each function: that means that we don’t know for sure which errors an endpoint can return (without careful manual investigation at least…) Consequently, we hardly can declare in the OpenApi file what errors an endpoint precisely returns, degrading the editoast API quality The frontend still requires editoast to declare all its errors though, to ensure they are translated properly. To achieve that we dynamically collect each EditoastError using the crate inventory. All the error descriptions collected are then transformed into OpenAPI schemas procedurally. On top of being a Rust antipattern (collecting state in proc-macros), this is complex to maintain on both editoast and frontend sides. Not having each endpoint linked to the list of errors it can raise, also prevents the frontend easily handling errors properly. It’s still unclear how we should expose errors from Core. Goals Have a clear separation between logically distinct errors. Dispose of a way to actually match on errors when they occur deeper in the stack Separate the error definition and their serialization. Establish how we want to forward Core’s errors. Tie the errors to the endpoint they originate from in the OpenAPI. Constraints Keep the same error format (for backward compatibility reasons to avoid involving the frontend too much). We must keep the editoast: prefix in the error type. The error must live until it is handled, conversion to our standard error format only happens in the response serialization. Errors must implement std::error::Error. Errors must be composable. This will typically be handled by thiserror’s #[from] attribute. Error variants must be shareable to ensure the deduplication of error kinds. For example, let’s say we have two functions get_infra(id: usize) and rename_infra(id: usize, name: String). Both functions error types have to include a variant describing the error case of an infrastructure not being found by its ID. However, we can’t duplicate something like InfraNotFound { id: usize } in both error types as this leads to two different error paths describing the same error case. This is especially problematic for error translation keys. We need to be able to define an error InfraNotFound and include it in both error types. A unicity check may be performed in the post-processing of the OpenAPI file to ensure that each error has a unique error type. Each endpoint must provide all its error cases in the OpenAPI. (How the frontend will consume them is another problem that we’ll have to deal with.) As for OSRD errors, the context field of the error is populated in the views. Errors can be handled in a generic manner (for situations where it makes some sense to do so). I.e.: some form of downcasting is available. New system Rely on thiserror everywhere. Keep the trait EditoastError but only implement it for errors defined in views. Since it is only used in views now, let’s rename it to trait ViewError. Create a proc-macro derive(ViewError) which interfaces with derive(thiserror::Error). The context is empty by default but can be provided by the impl ViewError. The macro is also able to take context providers. ViewError’s #[source], #[from], source and backtrace fields are never serialized, unless explicitly provided. This shouldn’t be the case as it exposes editoast internals at the API level. impl<T: ViewError> utoipa::IntoResponses for T (may be generated or inferred) Errors should not implement Serialize except for view errors (derive(ViewError)) which generates an impl ViewError used to serialize in the HTTP response. Error cases that will be used repeatedly are defined as a struct but still derive(thiserror::Error). The error_type of each variant is generated by the macro at the format ErrorTypeName::VariantName, but can be provided explicitly if conflicts arise. editoast: will be prepended systematically to indicate the service that raised the error. Since this type is not guaranteed to be unique, we may implement a post-processing step to ensure errors with the same error_type have the same OpenAPI schema. To ease the debugging process, an optional source_location will be provided in ViewErrors containing a link to the GitHub file and line where the error is defined. Nominal case // in mod views; fn get_resource(key: Key) -> Result<Resource, GetError> { todo!() } #[derive(Debug, thiserror::Error)] pub enum GetError { #[error("ID not found")] IdNotFound { id: u64 }, #[error("name not found")] NameNotFound { name: String } } fn process_resource(resource: Resource) -> Result<Computation, ProcessingError> { todo!() } #[derive(Debug, thiserror::Error)] pub enum ProcessingError { #[error("Resource is invalid")] InvalidResource { resource: Resource }, #[error("Resource is too old")] OutdatedResource { resource: Resource } } #[utoipa::path( ..., responses( (status = 200, body = Computation), EndpointError, // impl utoipa::IntoResponse ) )] async fn endpoint(Path(key): Path<Key>) -> Result<Json<Computation>, EndpointError> { let resource = get_resource(key)?; let value = process_resource(resource)?; Ok(Json(value)) } #[derive(Debug, thiserror::Error, ViewError)] pub enum EndpointError { #[error("Resource not found")] #[view_error(user)] // <=> status = 400 ResourceNotFound(#[from] GetError), #[view_error(internal)] // <=> status = 500, default ProcessingFailed(#[from] ProcessingError) } Share errors between crates Since we require no other constraint that impl std::error::Error for composition, it’s easy to nest errors using thiserror.'><meta itemprop=wordCount content="2795"><meta name=twitter:card content="summary"><meta name=twitter:title content="Editoast error management"><meta name=twitter:description content='Issues of the old system Mix between internal errors and API errors Errors are converted into InternalError early, which means that a caller of a function returning an editoast::Result will have some trouble matching on the error returned That means that it’s troublesome to add context to an existing error, or to wrap it into another higher-level one. We can’t track at compile-time which errors are returned by each function: that means that we don’t know for sure which errors an endpoint can return (without careful manual investigation at least…) Consequently, we hardly can declare in the OpenApi file what errors an endpoint precisely returns, degrading the editoast API quality The frontend still requires editoast to declare all its errors though, to ensure they are translated properly. To achieve that we dynamically collect each EditoastError using the crate inventory. All the error descriptions collected are then transformed into OpenAPI schemas procedurally. On top of being a Rust antipattern (collecting state in proc-macros), this is complex to maintain on both editoast and frontend sides. Not having each endpoint linked to the list of errors it can raise, also prevents the frontend easily handling errors properly. It’s still unclear how we should expose errors from Core. Goals Have a clear separation between logically distinct errors. Dispose of a way to actually match on errors when they occur deeper in the stack Separate the error definition and their serialization. Establish how we want to forward Core’s errors. Tie the errors to the endpoint they originate from in the OpenAPI. Constraints Keep the same error format (for backward compatibility reasons to avoid involving the frontend too much). We must keep the editoast: prefix in the error type. The error must live until it is handled, conversion to our standard error format only happens in the response serialization. Errors must implement std::error::Error. Errors must be composable. This will typically be handled by thiserror’s #[from] attribute. Error variants must be shareable to ensure the deduplication of error kinds. For example, let’s say we have two functions get_infra(id: usize) and rename_infra(id: usize, name: String). Both functions error types have to include a variant describing the error case of an infrastructure not being found by its ID. However, we can’t duplicate something like InfraNotFound { id: usize } in both error types as this leads to two different error paths describing the same error case. This is especially problematic for error translation keys. We need to be able to define an error InfraNotFound and include it in both error types. A unicity check may be performed in the post-processing of the OpenAPI file to ensure that each error has a unique error type. Each endpoint must provide all its error cases in the OpenAPI. (How the frontend will consume them is another problem that we’ll have to deal with.) As for OSRD errors, the context field of the error is populated in the views. Errors can be handled in a generic manner (for situations where it makes some sense to do so). I.e.: some form of downcasting is available. New system Rely on thiserror everywhere. Keep the trait EditoastError but only implement it for errors defined in views. Since it is only used in views now, let’s rename it to trait ViewError. Create a proc-macro derive(ViewError) which interfaces with derive(thiserror::Error). The context is empty by default but can be provided by the impl ViewError. The macro is also able to take context providers. ViewError’s #[source], #[from], source and backtrace fields are never serialized, unless explicitly provided. This shouldn’t be the case as it exposes editoast internals at the API level. impl<T: ViewError> utoipa::IntoResponses for T (may be generated or inferred) Errors should not implement Serialize except for view errors (derive(ViewError)) which generates an impl ViewError used to serialize in the HTTP response. Error cases that will be used repeatedly are defined as a struct but still derive(thiserror::Error). The error_type of each variant is generated by the macro at the format ErrorTypeName::VariantName, but can be provided explicitly if conflicts arise. editoast: will be prepended systematically to indicate the service that raised the error. Since this type is not guaranteed to be unique, we may implement a post-processing step to ensure errors with the same error_type have the same OpenAPI schema. To ease the debugging process, an optional source_location will be provided in ViewErrors containing a link to the GitHub file and line where the error is defined. Nominal case // in mod views; fn get_resource(key: Key) -> Result<Resource, GetError> { todo!() } #[derive(Debug, thiserror::Error)] pub enum GetError { #[error("ID not found")] IdNotFound { id: u64 }, #[error("name not found")] NameNotFound { name: String } } fn process_resource(resource: Resource) -> Result<Computation, ProcessingError> { todo!() } #[derive(Debug, thiserror::Error)] pub enum ProcessingError { #[error("Resource is invalid")] InvalidResource { resource: Resource }, #[error("Resource is too old")] OutdatedResource { resource: Resource } } #[utoipa::path( ..., responses( (status = 200, body = Computation), EndpointError, // impl utoipa::IntoResponse ) )] async fn endpoint(Path(key): Path<Key>) -> Result<Json<Computation>, EndpointError> { let resource = get_resource(key)?; let value = process_resource(resource)?; Ok(Json(value)) } #[derive(Debug, thiserror::Error, ViewError)] pub enum EndpointError { #[error("Resource not found")] #[view_error(user)] // <=> status = 400 ResourceNotFound(#[from] GetError), #[view_error(internal)] // <=> status = 500, default ProcessingFailed(#[from] ProcessingError) } Share errors between crates Since we require no other constraint that impl std::error::Error for composition, it’s easy to nest errors using thiserror.'><link rel=preload href=/scss/main.min.5c45ececdbdfc535ee5253f678cfd68edfba69407b82367ff2e289cdf3db5514.css as=style integrity="sha256-XEXs7NvfxTXuUlP2eM/Wjt+6aUB7gjZ/8uKJzfPbVRQ=" crossorigin=anonymous><link href=/scss/main.min.5c45ececdbdfc535ee5253f678cfd68edfba69407b82367ff2e289cdf3db5514.css rel=stylesheet integrity="sha256-XEXs7NvfxTXuUlP2eM/Wjt+6aUB7gjZ/8uKJzfPbVRQ=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/en/><span class="navbar-brand__logo navbar-logo"><svg id="svg36" width="110.767" height="22"><style id="style1">.st9{fill:#fff}</style><g id="ok" transform="scale(.1918)"><g id="g36"><g id="g29"><path id="path23" d="M38.5 83.4c-1.9 8.2-2.9 17-2.9 26.5v4.8h16.6c-2.8-13.2-7.8-23.4-13.7-31.3z" class="st9"/><path id="path24" d="M0 57.5v19.9c3.1 1.2 6.3 2.7 9.5 4.6 8.5 5.2 15 12.6 19.4 21.8v-31c-3.4-3-6.9-5.5-10.3-7.5-6.5-3.7-13-6.2-18.6-7.8z" class="st9"/><path id="path25" d="M35.6 69.9c4.3-11.3 10.6-21.1 18.9-29.4V0H35.6z" class="st9"/><path id="path26" d="M40.8 75.4c5.3 6.2 10.1 13.8 13.7 23.3V50.6C48.6 57.8 44 66.1 40.8 75.4z" class="st9"/><path id="path27" d="M100.7.0H61.3v34.5C73.1 25.2 86 20 96.9 17.2c1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-11.4 2.9-25.3 8.6-37.2 19.7v31.8c2.9-6.3 6.7-11.7 11.4-16.4 9.4-9.3 21-14.1 30.5-16.6 1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-4.7 1.2-10.1 3.1-15.3 6-19 10.3-28.2 28.4-28.2 55.2v4.8h39.3c7.8.0 14.1-6.3 14.1-14.1V14.1C114.7 6.3 108.4.0 100.7.0z" class="st9"/><path id="path28" d="M22 59.6c2.2 1.3 4.5 2.8 6.8 4.6V0H14.1C6.3.0.0 6.3.0 14.1v36.4c6.5 1.7 14.2 4.5 22 9.1z" class="st9"/><path id="path29" d="M5.4 87.5c-1.8-1.1-3.6-2-5.4-2.8v15.9c0 7.8 6.3 14.1 14.1 14.1h11.6c-3.6-12.2-10.4-21.3-20.3-27.2z" class="st9"/></g><g id="g30"><path id="path30" d="M201.7 109c-30.8.0-53.7-21.2-53.7-52.5.0-31.7 22.9-51.6 53.7-51.6 31 0 53.9 20 53.9 51.6-.1 31.3-23 52.5-53.9 52.5zm0-82.6c-16.7.0-28.2 12.8-28.2 30.1.0 17.9 11.6 30.7 28.2 30.7S230 74.4 230 56.6c0-17.3-11.6-30.2-28.3-30.2z" class="st9"/></g><g id="g32"><g id="g31"><path id="path31" d="M334.3 33.3c-4-5.2-11.4-8.5-17.6-8.5-6.2.0-13.8 2.1-13.8 9.9.0 6.6 5.9 8.7 15.2 11.6 13.4 4.3 30.7 10 30.7 29.7.0 22.7-18.3 32.9-37.8 32.9-14.1.0-28.3-5.2-37-14.2l15.6-15.9c4.7 6 13.5 10.5 21.3 10.5 7.3.0 13.7-2.8 13.7-10.7.0-7.5-7.5-9.9-20.5-14.1C291.6 60.3 279 53.9 279 36c0-21.9 19.8-31 38.2-31 11.2.0 23.7 4.2 32.4 12.1z" class="st9"/></g></g><g id="g34"><g id="g33"><path id="path32" d="m433.1 106.4-21.3-39.2h-8.1v39.2h-23.4V7.6H418c19 0 37.8 7.3 37.8 29.9.0 13.3-7.8 22.7-20.5 26.6l25.8 42.3zm-16.9-79.6h-12.7v23h11.3c7.7.0 17.3-2 17.3-12 0-9.2-8.7-11-15.9-11z" class="st9"/></g></g><g id="g35"><path id="path34" d="M522.2 106.4h-36.8V7.6H521c28 0 56.5 11.7 56.5 49.1.0 34.7-28.1 49.7-55.3 49.7zm-1.7-78.5h-11.9v57.8h11.3c17 0 32.8-7 32.8-29 0-22.2-15.8-28.8-32.2-28.8z" class="st9"/></g></g></g></svg></span><span class=navbar-brand__name>OSRD</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/en/about/><span>About</span></a></li><li class=nav-item><a class="nav-link active" href=/en/docs/><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/en/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/en/join-us/><span>Join us</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/fr/docs/reference/design-docs/editoast-errors/>Français</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.49d2ff471a12273fc637b2a5472a6fe8.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.49d2ff471a12273fc637b2a5472a6fe8.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse foldable-nav" id=td-section-nav><div class="td-sidebar-nav__section nav-item dropdown d-block d-lg-none"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/fr/docs/reference/design-docs/editoast-errors/>Français</a></li></ul></div></div><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-endocs-li><a href=/en/docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-endocs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsexplanation-li><input type=checkbox id=m-endocsexplanation-check>
<label for=m-endocsexplanation-check><a href=/en/docs/explanation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanation><span>Explanations</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationcontainers-architecture-li><input type=checkbox id=m-endocsexplanationcontainers-architecture-check>
<label for=m-endocsexplanationcontainers-architecture-check><a href=/en/docs/explanation/containers-architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationcontainers-architecture><span>Containers architecture</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsexplanationmodels-li><input type=checkbox id=m-endocsexplanationmodels-check>
<label for=m-endocsexplanationmodels-check><a href=/en/docs/explanation/models/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationmodels><span>Models</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationmodelsdata-models-full-example-li><input type=checkbox id=m-endocsexplanationmodelsdata-models-full-example-check>
<label for=m-endocsexplanationmodelsdata-models-full-example-check><a href=/en/docs/explanation/models/data-models-full-example/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationmodelsdata-models-full-example><span>Infrastructure example</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationmodelsneutral_sections-li><input type=checkbox id=m-endocsexplanationmodelsneutral_sections-check>
<label for=m-endocsexplanationmodelsneutral_sections-check><a href=/en/docs/explanation/models/neutral_sections/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationmodelsneutral_sections><span>Neutral Sections</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationmodelsrealistic-rolling-stocks-li><input type=checkbox id=m-endocsexplanationmodelsrealistic-rolling-stocks-check>
<label for=m-endocsexplanationmodelsrealistic-rolling-stocks-check><a href=/en/docs/explanation/models/realistic-rolling-stocks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationmodelsrealistic-rolling-stocks><span>Rolling stock categories</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsexplanationrunning_time_calculation-li><input type=checkbox id=m-endocsexplanationrunning_time_calculation-check>
<label for=m-endocsexplanationrunning_time_calculation-check><a href=/en/docs/explanation/running_time_calculation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationrunning_time_calculation><span>Running time calculation</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationphysical_modeling-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationphysical_modeling-check>
<label for=m-endocsexplanationrunning_time_calculationphysical_modeling-check><a href=/en/docs/explanation/running_time_calculation/physical_modeling/ title="Physical modeling" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationphysical_modeling><span>1 - Physical modeling</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationnumerical_integration-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationnumerical_integration-check>
<label for=m-endocsexplanationrunning_time_calculationnumerical_integration-check><a href=/en/docs/explanation/running_time_calculation/numerical_integration/ title="Numerical integration" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationnumerical_integration><span>2 - Numerical integration</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationenvelopes_system-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationenvelopes_system-check>
<label for=m-endocsexplanationrunning_time_calculationenvelopes_system-check><a href=/en/docs/explanation/running_time_calculation/envelopes_system/ title="Envelopes system" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationenvelopes_system><span>3 - Envelopes system</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationpipeline-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationpipeline-check>
<label for=m-endocsexplanationrunning_time_calculationpipeline-check><a href=/en/docs/explanation/running_time_calculation/pipeline/ title=Pipeline class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationpipeline><span>4 - Pipeline</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationallowances-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationallowances-check>
<label for=m-endocsexplanationrunning_time_calculationallowances-check><a href=/en/docs/explanation/running_time_calculation/allowances/ title=Allowances class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationallowances><span>5 - Allowances</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationnetzgrafik-editor-li><input type=checkbox id=m-endocsexplanationnetzgrafik-editor-check>
<label for=m-endocsexplanationnetzgrafik-editor-check><a href=/en/docs/explanation/netzgrafik-editor/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationnetzgrafik-editor><span>Netzgrafik-Editor</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguides-li><input type=checkbox id=m-endocsguides-check>
<label for=m-endocsguides-check><a href=/en/docs/guides/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguides><span>How-to Guides</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguidescontribute-li><input type=checkbox id=m-endocsguidescontribute-check>
<label for=m-endocsguidescontribute-check><a href=/en/docs/guides/contribute/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidescontribute><span>Contribute to OSRD</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributepreamble-li><input type=checkbox id=m-endocsguidescontributepreamble-check>
<label for=m-endocsguidescontributepreamble-check><a href=/en/docs/guides/contribute/preamble/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributepreamble><span>Preamble</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributelicense-and-set-up-li><input type=checkbox id=m-endocsguidescontributelicense-and-set-up-check>
<label for=m-endocsguidescontributelicense-and-set-up-check><a href=/en/docs/guides/contribute/license-and-set-up/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributelicense-and-set-up><span>License and set-up</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguidescontributecontribute-code-li><input type=checkbox id=m-endocsguidescontributecontribute-code-check>
<label for=m-endocsguidescontributecontribute-code-check><a href=/en/docs/guides/contribute/contribute-code/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidescontributecontribute-code><span>Contribute code</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codegeneral-principles-li><input type=checkbox id=m-endocsguidescontributecontribute-codegeneral-principles-check>
<label for=m-endocsguidescontributecontribute-codegeneral-principles-check><a href=/en/docs/guides/contribute/contribute-code/general-principles/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codegeneral-principles><span>General principles</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codebackend-conventions-li><input type=checkbox id=m-endocsguidescontributecontribute-codebackend-conventions-check>
<label for=m-endocsguidescontributecontribute-codebackend-conventions-check><a href=/en/docs/guides/contribute/contribute-code/backend-conventions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codebackend-conventions><span>Back-end conventions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codefrontend-conventions-li><input type=checkbox id=m-endocsguidescontributecontribute-codefrontend-conventions-check>
<label for=m-endocsguidescontributecontribute-codefrontend-conventions-check><a href=/en/docs/guides/contribute/contribute-code/frontend-conventions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codefrontend-conventions><span>Front-end conventions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codewrite-code-li><input type=checkbox id=m-endocsguidescontributecontribute-codewrite-code-check>
<label for=m-endocsguidescontributecontribute-codewrite-code-check><a href=/en/docs/guides/contribute/contribute-code/write-code/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codewrite-code><span>Write code</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codecommit-conventions-li><input type=checkbox id=m-endocsguidescontributecontribute-codecommit-conventions-check>
<label for=m-endocsguidescontributecontribute-codecommit-conventions-check><a href=/en/docs/guides/contribute/contribute-code/commit-conventions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codecommit-conventions><span>Commit conventions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codeshare-changes-li><input type=checkbox id=m-endocsguidescontributecontribute-codeshare-changes-check>
<label for=m-endocsguidescontributecontribute-codeshare-changes-check><a href=/en/docs/guides/contribute/contribute-code/share-changes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codeshare-changes><span>Share your changes</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codetests-li><input type=checkbox id=m-endocsguidescontributecontribute-codetests-check>
<label for=m-endocsguidescontributecontribute-codetests-check><a href=/en/docs/guides/contribute/contribute-code/tests/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codetests><span>Tests</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecode-review-li><input type=checkbox id=m-endocsguidescontributecode-review-check>
<label for=m-endocsguidescontributecode-review-check><a href=/en/docs/guides/contribute/code-review/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecode-review><span>Review process</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributebug-reports-li><input type=checkbox id=m-endocsguidescontributebug-reports-check>
<label for=m-endocsguidescontributebug-reports-check><a href=/en/docs/guides/contribute/bug-reports/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributebug-reports><span>Report issues</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributeinstall-docker-li><input type=checkbox id=m-endocsguidescontributeinstall-docker-check>
<label for=m-endocsguidescontributeinstall-docker-check><a href=/en/docs/guides/contribute/install-docker/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributeinstall-docker><span>Install docker</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributereview-process-li><input type=checkbox id=m-endocsguidescontributereview-process-check>
<label for=m-endocsguidescontributereview-process-check><a href=/en/docs/guides/contribute/review-process/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributereview-process><span></span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguidesdeploy-li><input type=checkbox id=m-endocsguidesdeploy-check>
<label for=m-endocsguidesdeploy-check><a href=/en/docs/guides/deploy/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidesdeploy><span>Deploy OSRD</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesdeploydocker-compose-li><input type=checkbox id=m-endocsguidesdeploydocker-compose-check>
<label for=m-endocsguidesdeploydocker-compose-check><a href=/en/docs/guides/deploy/docker-compose/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidesdeploydocker-compose><span>Docker Compose</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesdeploykubernetes-li><input type=checkbox id=m-endocsguidesdeploykubernetes-check>
<label for=m-endocsguidesdeploykubernetes-check><a href=/en/docs/guides/deploy/kubernetes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidesdeploykubernetes><span>Kubernetes with Helm</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesdeploystdcm-search-env-li><input type=checkbox id=m-endocsguidesdeploystdcm-search-env-check>
<label for=m-endocsguidesdeploystdcm-search-env-check><a href=/en/docs/guides/deploy/stdcm-search-env/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidesdeploystdcm-search-env><span>STDCM search environment configuration</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguideslogo-li><input type=checkbox id=m-endocsguideslogo-check>
<label for=m-endocsguideslogo-check><a href=/en/docs/guides/logo/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguideslogo><span>Logo</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesdesign-li><input type=checkbox id=m-endocsguidesdesign-check>
<label for=m-endocsguidesdesign-check><a href=/en/docs/guides/design/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidesdesign><span>OSRD's design</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguidesrelease-li><input type=checkbox id=m-endocsguidesrelease-check>
<label for=m-endocsguidesrelease-check><a href=/en/docs/guides/release/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidesrelease><span>Release</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesreleaseprocess-li><input type=checkbox id=m-endocsguidesreleaseprocess-check>
<label for=m-endocsguidesreleaseprocess-check><a href=/en/docs/guides/release/process/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidesreleaseprocess><span>Release process</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesreleasepublish-li><input type=checkbox id=m-endocsguidesreleasepublish-check>
<label for=m-endocsguidesreleasepublish-check><a href=/en/docs/guides/release/publish/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidesreleasepublish><span>Publish a new release</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-endocsreference-li><input type=checkbox id=m-endocsreference-check checked>
<label for=m-endocsreference-check><a href=/en/docs/reference/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreference><span>Technical reference</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencearchitecture-li><input type=checkbox id=m-endocsreferencearchitecture-check>
<label for=m-endocsreferencearchitecture-check><a href=/en/docs/reference/architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencearchitecture><span>Architecture</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencearchitecturedata_flow-li><input type=checkbox id=m-endocsreferencearchitecturedata_flow-check>
<label for=m-endocsreferencearchitecturedata_flow-check><a href=/en/docs/reference/architecture/data_flow/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencearchitecturedata_flow><span>Data-flow</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencearchitectureservices-li><input type=checkbox id=m-endocsreferencearchitectureservices-check>
<label for=m-endocsreferencearchitectureservices-check><a href=/en/docs/reference/architecture/services/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencearchitectureservices><span>Services</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-endocsreferencedesign-docs-li><input type=checkbox id=m-endocsreferencedesign-docs-check checked>
<label for=m-endocsreferencedesign-docs-check><a href=/en/docs/reference/design-docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docs><span>Design documents</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsinterlocking-li><input type=checkbox id=m-endocsreferencedesign-docsinterlocking-check>
<label for=m-endocsreferencedesign-docsinterlocking-check><a href=/en/docs/reference/design-docs/interlocking/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docsinterlocking><span>Interlocking</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docssignaling-li><input type=checkbox id=m-endocsreferencedesign-docssignaling-check>
<label for=m-endocsreferencedesign-docssignaling-check><a href=/en/docs/reference/design-docs/signaling/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docssignaling><span>Signaling</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docssignalingsignaling-systems-li><input type=checkbox id=m-endocsreferencedesign-docssignalingsignaling-systems-check>
<label for=m-endocsreferencedesign-docssignalingsignaling-systems-check><a href=/en/docs/reference/design-docs/signaling/signaling-systems/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docssignalingsignaling-systems><span>Signaling systems</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docssignalingblocks-and-signals-li><input type=checkbox id=m-endocsreferencedesign-docssignalingblocks-and-signals-check>
<label for=m-endocsreferencedesign-docssignalingblocks-and-signals-check><a href=/en/docs/reference/design-docs/signaling/blocks-and-signals/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docssignalingblocks-and-signals><span>Blocks and signals</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docssignalingspeed-limits-li><input type=checkbox id=m-endocsreferencedesign-docssignalingspeed-limits-check>
<label for=m-endocsreferencedesign-docssignalingspeed-limits-check><a href=/en/docs/reference/design-docs/signaling/speed-limits/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docssignalingspeed-limits><span>Speed limits</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docssignalingsimulation-li><input type=checkbox id=m-endocsreferencedesign-docssignalingsimulation-check>
<label for=m-endocsreferencedesign-docssignalingsimulation-check><a href=/en/docs/reference/design-docs/signaling/simulation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docssignalingsimulation><span>Simulation lifecycle</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsconflict-detection-li><input type=checkbox id=m-endocsreferencedesign-docsconflict-detection-check>
<label for=m-endocsreferencedesign-docsconflict-detection-check><a href=/en/docs/reference/design-docs/conflict-detection/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsconflict-detection><span>Conflict detection</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docstrain-sim-v3-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3-check><a href=/en/docs/reference/design-docs/train-sim-v3/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docstrain-sim-v3><span>Train simulation v3</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstrain-sim-v3overview-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3overview-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3overview-check><a href=/en/docs/reference/design-docs/train-sim-v3/overview/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstrain-sim-v3overview><span>Overview</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstrain-sim-v3prior-art-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3prior-art-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3prior-art-check><a href=/en/docs/reference/design-docs/train-sim-v3/prior-art/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstrain-sim-v3prior-art><span>Prior art</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstrain-sim-v3driving-instruction-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3driving-instruction-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3driving-instruction-check><a href=/en/docs/reference/design-docs/train-sim-v3/driving-instruction/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstrain-sim-v3driving-instruction><span>Driving instructions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstrain-sim-v3driver-behavior-modules-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3driver-behavior-modules-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3driver-behavior-modules-check><a href=/en/docs/reference/design-docs/train-sim-v3/driver-behavior-modules/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstrain-sim-v3driver-behavior-modules><span>Driver behavior modules</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docsstdcm-li><input type=checkbox id=m-endocsreferencedesign-docsstdcm-check>
<label for=m-endocsreferencedesign-docsstdcm-check><a href=/en/docs/reference/design-docs/stdcm/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docsstdcm><span>Search for last-minute train slots (STDCM)</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmdomain_context-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmdomain_context-check>
<label for=m-endocsreferencedesign-docsstdcmdomain_context-check><a href=/en/docs/reference/design-docs/stdcm/domain_context/ title="Business context" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmdomain_context><span>1 - Business Context</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docsstdcmpathfinding_module-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_module-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_module-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/ title="Train slot search module" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docsstdcmpathfinding_module><span>2 - Train slot search module</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleinfrastructure_exploration-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_moduleinfrastructure_exploration-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_moduleinfrastructure_exploration-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/infrastructure_exploration/ title="Infrastructure exploration" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleinfrastructure_exploration><span>1 - Infrastructure exploration</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_detection-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_detection-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_detection-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/conflict_detection/ title="Conflict detection" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_detection><span>2 - Conflict detection</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_modulegraph_representation-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_modulegraph_representation-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_modulegraph_representation-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/graph_representation/ title="Encoding the solution space" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_modulegraph_representation><span>2 - Encoding the solution space</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_modulebacktracking-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_modulebacktracking-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_modulebacktracking-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/backtracking/ title="Discontinuities and backtracking" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_modulebacktracking><span>3 - Discontinuities and backtracking</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_avoidance-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_avoidance-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_avoidance-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/conflict_avoidance/ title="Conflict avoidance" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_avoidance><span>4 - Conflict avoidance</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_modulestandard_allowance-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_modulestandard_allowance-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_modulestandard_allowance-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/standard_allowance/ title="Standard allowance" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_modulestandard_allowance><span>5 - Standard allowance</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleimplementation_details-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_moduleimplementation_details-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_moduleimplementation_details-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/implementation_details/ title="Implementation details" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleimplementation_details><span>6 - Implementation details</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstimetable-li><input type=checkbox id=m-endocsreferencedesign-docstimetable-check>
<label for=m-endocsreferencedesign-docstimetable-check><a href=/en/docs/reference/design-docs/timetable/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstimetable><span>Timetable v2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docsauth-li><input type=checkbox id=m-endocsreferencedesign-docsauth-check>
<label for=m-endocsreferencedesign-docsauth-check><a href=/en/docs/reference/design-docs/auth/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docsauth><span>Authentication and authorization</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsautheditoast-internal-api-li><input type=checkbox id=m-endocsreferencedesign-docsautheditoast-internal-api-check>
<label for=m-endocsreferencedesign-docsautheditoast-internal-api-check><a href=/en/docs/reference/design-docs/auth/editoast-internal-api/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsautheditoast-internal-api><span>Editoast internal authorization API</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-endocsreferencedesign-docseditoast-errors-li><input type=checkbox id=m-endocsreferencedesign-docseditoast-errors-check checked>
<label for=m-endocsreferencedesign-docseditoast-errors-check><a href=/en/docs/reference/design-docs/editoast-errors/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docseditoast-errors><span class=td-sidebar-nav-active-item>Editoast error management</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsscalable-async-rpc-li><input type=checkbox id=m-endocsreferencedesign-docsscalable-async-rpc-check>
<label for=m-endocsreferencedesign-docsscalable-async-rpc-check><a href=/en/docs/reference/design-docs/scalable-async-rpc/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsscalable-async-rpc><span>Scalable async RPC</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferenceapis-li><input type=checkbox id=m-endocsreferenceapis-check>
<label for=m-endocsreferenceapis-check><a href=/en/docs/reference/apis/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferenceapis><span>APIs</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferenceapiseditoast-li><input type=checkbox id=m-endocsreferenceapiseditoast-check>
<label for=m-endocsreferenceapiseditoast-check><a href=/en/docs/reference/apis/editoast/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferenceapiseditoast><span>Editoast</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferenceapisgateway-li><input type=checkbox id=m-endocsreferenceapisgateway-check>
<label for=m-endocsreferenceapisgateway-check><a href=/en/docs/reference/apis/gateway/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferenceapisgateway><span>Gateway</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsrailway-wiki-li><input type=checkbox id=m-endocsrailway-wiki-check>
<label for=m-endocsrailway-wiki-check><a href=/en/docs/railway-wiki/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wiki><span>Railway Wiki</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikiglossary-li><input type=checkbox id=m-endocsrailway-wikiglossary-check>
<label for=m-endocsrailway-wikiglossary-check><a href=/en/docs/railway-wiki/glossary/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikiglossary><span>Glossary</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsrailway-wikisignalling-li><input type=checkbox id=m-endocsrailway-wikisignalling-check>
<label for=m-endocsrailway-wikisignalling-check><a href=/en/docs/railway-wiki/signalling/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignalling><span>Signalling</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikisignallingrisks-li><input type=checkbox id=m-endocsrailway-wikisignallingrisks-check>
<label for=m-endocsrailway-wikisignallingrisks-check><a href=/en/docs/railway-wiki/signalling/risks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingrisks><span>Railway risks</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikisignallingsignals-li><input type=checkbox id=m-endocsrailway-wikisignallingsignals-check>
<label for=m-endocsrailway-wikisignallingsignals-check><a href=/en/docs/railway-wiki/signalling/signals/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingsignals><span>Signals</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsrailway-wikisignallingoperation-modes-li><input type=checkbox id=m-endocsrailway-wikisignallingoperation-modes-check>
<label for=m-endocsrailway-wikisignallingoperation-modes-check><a href=/en/docs/railway-wiki/signalling/operation-modes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingoperation-modes><span>Line operation modes</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikisignallingoperation-modessingle-track-lines-li><input type=checkbox id=m-endocsrailway-wikisignallingoperation-modessingle-track-lines-check>
<label for=m-endocsrailway-wikisignallingoperation-modessingle-track-lines-check><a href=/en/docs/railway-wiki/signalling/operation-modes/single-track-lines/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingoperation-modessingle-track-lines><span>Single-track lines</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikisignallingoperation-modesdouble-track-lines-li><input type=checkbox id=m-endocsrailway-wikisignallingoperation-modesdouble-track-lines-check>
<label for=m-endocsrailway-wikisignallingoperation-modesdouble-track-lines-check><a href=/en/docs/railway-wiki/signalling/operation-modes/double-track-lines/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingoperation-modesdouble-track-lines><span>Double-track lines</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsrailway-wikisignallingspacing-li><input type=checkbox id=m-endocsrailway-wikisignallingspacing-check>
<label for=m-endocsrailway-wikisignallingspacing-check><a href=/en/docs/railway-wiki/signalling/spacing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingspacing><span>Train spacing systems</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikisignallingspacingautomatic_block_systems-li><input type=checkbox id=m-endocsrailway-wikisignallingspacingautomatic_block_systems-check>
<label for=m-endocsrailway-wikisignallingspacingautomatic_block_systems-check><a href=/en/docs/railway-wiki/signalling/spacing/automatic_block_systems/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingspacingautomatic_block_systems><span>Automatic block systems</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsrailway-wikisignallingspacingertms-li><input type=checkbox id=m-endocsrailway-wikisignallingspacingertms-check>
<label for=m-endocsrailway-wikisignallingspacingertms-check><a href=/en/docs/railway-wiki/signalling/spacing/ertms/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingspacingertms><span>ETCS (ERTMS)</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikisignallingspacingertmsetcs-li><input type=checkbox id=m-endocsrailway-wikisignallingspacingertmsetcs-check>
<label for=m-endocsrailway-wikisignallingspacingertmsetcs-check><a href=/en/docs/railway-wiki/signalling/spacing/ertms/etcs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsrailway-wikisignallingspacingertmsetcs><span>ETCS</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikisignallingspacingks-li><input type=checkbox id=m-endocsrailway-wikisignallingspacingks-check>
<label for=m-endocsrailway-wikisignallingspacingks-check><a href=/en/docs/railway-wiki/signalling/spacing/ks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingspacingks><span>Ks Signalling</span></a></label></li></ul></li></ul></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/OpenRailAssociation/osrd-website/tree/master/content/reference/design-docs/editoast-errors/_index.en.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/OpenRailAssociation/osrd-website/edit/master/content/reference/design-docs/editoast-errors/_index.en.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/OpenRailAssociation/osrd-website/new/master/content/reference/design-docs/editoast-errors?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/OpenRailAssociation/osrd-website/issues/new?title=Editoast%20error%20management" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/OpenRailAssociation/osrd/issues/new class="td-page-meta--project td-page-meta__project-issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
<a id=print href=/en/docs/reference/design-docs/editoast-errors/_print/><i class="fa-solid fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#nominal-case>Nominal case</a></li><li><a href=#share-errors-between-crates>Share errors between crates</a></li><li><a href=#ease-composability>Ease composability</a><ul><li><a href=#nesting-viewerrors>Nesting <code>ViewError</code>s</a></li></ul></li><li><a href=#full-deriveviewerror-spec>Full <code>derive(ViewError)</code> spec</a><ul><li><a href=#providing-context>Providing <code>context</code></a></li><li><a href=#about-core-errors>About Core errors</a></li><li><a href=#why-do-we-need-a-derive-macro>Why do we need a derive macro?</a></li></ul></li><li><a href=#implementation-plan>Implementation plan</a><ul><li><a href=#setup>Setup</a></li><li><a href=#migration>Migration</a></li><li><a href=#wrapping-up-things>Wrapping up things</a></li></ul></li><li><a href=#rejected-ideas>Rejected ideas</a><ul><li><a href=#anonymous-enums>Anonymous enums</a></li><li><a href=#incident-reports>Incident reports</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/en/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/en/docs/reference/>Technical reference</a></li><li class=breadcrumb-item><a href=/en/docs/reference/design-docs/>Design documents</a></li><li class="breadcrumb-item active" aria-current=page>Editoast error management</li></ol></nav><div class=td-content><h1>Editoast error management</h1><header class=article-meta></header><h1 id=issues-of-the-old-system>Issues of the old system</h1><ul><li>Mix between internal errors and API errors</li><li>Errors are converted into <code>InternalError</code> early, which means that a caller of a function returning an <code>editoast::Result</code> will have some trouble <code>match</code>ing on the error returned<ul><li>That means that it&rsquo;s troublesome to add context to an existing error, or to wrap it into another higher-level one.</li></ul></li><li>We can&rsquo;t track at compile-time which errors are returned by each function: that means that we don&rsquo;t know for sure which errors an endpoint can return (without careful manual investigation at least&mldr;)</li><li>Consequently, we hardly can declare in the OpenApi file what errors an endpoint precisely returns, degrading the editoast API quality</li><li>The frontend still requires editoast to declare all its errors though, to ensure they are translated properly. To achieve that we dynamically collect each <code>EditoastError</code> using the crate <code>inventory</code>. All the error descriptions collected are then transformed into OpenAPI schemas procedurally. On top of being a Rust antipattern (collecting state in proc-macros), this is complex to maintain on both editoast and frontend sides.<ul><li>Not having each endpoint linked to the list of errors it can raise, also prevents the frontend easily handling errors properly.</li></ul></li><li>It&rsquo;s still unclear how we should expose errors from Core.</li></ul><h1 id=goals>Goals</h1><ul><li>Have a clear separation between logically distinct errors.</li><li>Dispose of a way to actually match on errors when they occur deeper in the stack</li><li>Separate the error definition and their serialization.</li><li>Establish how we want to forward Core&rsquo;s errors.</li><li>Tie the errors to the endpoint they originate from in the OpenAPI.</li></ul><h1 id=constraints>Constraints</h1><ul><li>Keep the same error format (for backward compatibility reasons to avoid involving the frontend too much).<ul><li>We must keep the <code>editoast:</code> prefix in the error type.</li></ul></li><li>The error must live until it is handled, conversion to our standard error format only happens in the response serialization.</li><li>Errors must implement <code>std::error::Error</code>.</li><li>Errors must be composable. This will typically be handled by <code>thiserror</code>&rsquo;s <code>#[from]</code> attribute.</li><li>Error variants must be shareable to ensure the deduplication of error kinds. For example, let&rsquo;s say we have two functions <code>get_infra(id: usize)</code> and <code>rename_infra(id: usize, name: String)</code>. Both functions error types have to include a variant describing the error case of an infrastructure not being found by its ID. However, we can&rsquo;t duplicate something like <code>InfraNotFound { id: usize }</code> in both error types as this leads to two different error paths describing the same error case. This is especially problematic for error translation keys. We need to be able to define an error <code>InfraNotFound</code> and include it in both error types.<ul><li>A unicity check may be performed in the post-processing of the OpenAPI file to ensure that each error has a unique error type.</li></ul></li><li>Each endpoint must provide all its error cases in the OpenAPI. (How the frontend will consume them is another problem that we&rsquo;ll have to deal with.)</li><li>As for OSRD errors, the <code>context</code> field of the error is populated in the views.</li><li>Errors can be handled in a generic manner (for situations where it makes some sense to do so).<ul><li>I.e.: some form of downcasting is available.</li></ul></li></ul><h1 id=new-system>New system</h1><ul><li>Rely on <code>thiserror</code> everywhere.</li><li>Keep the <code>trait EditoastError</code> but only implement it for errors defined in <code>views</code>.<ul><li>Since it is only used in <code>views</code> now, let&rsquo;s rename it to <code>trait ViewError</code>.</li></ul></li><li>Create a proc-macro <code>derive(ViewError)</code> which interfaces with <code>derive(thiserror::Error)</code>.</li><li>The <code>context</code> is empty by default but can be provided by the <code>impl ViewError</code>. The macro is also able to take context providers.</li><li><code>ViewError</code>&rsquo;s <code>#[source]</code>, <code>#[from]</code>, <code>source</code> and <code>backtrace</code> fields are never serialized, unless explicitly provided. This shouldn&rsquo;t be the case as it exposes editoast internals at the API level.</li><li><code>impl&lt;T: ViewError> utoipa::IntoResponses for T</code> (may be generated or inferred)</li><li>Errors <strong>should not</strong> implement <code>Serialize</code> except for view errors (<code>derive(ViewError)</code>) which generates an <code>impl ViewError</code> used to serialize in the HTTP response.</li><li>Error cases that will be used repeatedly are defined as a <code>struct</code> but still <code>derive(thiserror::Error)</code>.</li><li>The <code>error_type</code> of each variant is generated by the macro at the format <code>ErrorTypeName::VariantName</code>, but can be provided explicitly if conflicts arise.<ul><li><code>editoast:</code> will be prepended systematically to indicate the service that raised the error.</li><li>Since this type is not guaranteed to be unique, we may implement a post-processing step to ensure errors with the same <code>error_type</code> have the same OpenAPI schema.</li><li>To ease the debugging process, an optional <code>source_location</code> will be provided in <code>ViewError</code>s containing a link to the GitHub file and line where the error is defined.</li></ul></li></ul><h2 id=nominal-case>Nominal case</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in mod views;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>get_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span>: <span style=color:#000>Key</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Resource</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GetError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>GetError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;ID not found&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>IdNotFound</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span>: <span style=color:#204a87;font-weight:700>u64</span> <span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;name not found&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>NameNotFound</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>process_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span>: <span style=color:#000>Resource</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Computation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProcessingError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ProcessingError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;Resource is invalid&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InvalidResource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource</span>: <span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;Resource is too old&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>OutdatedResource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource</span>: <span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[utoipa::path(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    ...,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    responses(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        (status = 200, body = Computation),
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        EndpointError, // impl utoipa::IntoResponse
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    )
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>endpoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Path</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>)</span>: <span style=color:#000>Path</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Key</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Computation</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EndpointError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>get_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>process_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Json</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EndpointError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;Resource not found&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// &lt;=&gt; status = 400
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>ResourceNotFound</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GetError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(internal)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// &lt;=&gt; status = 500, default
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>ProcessingFailed</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProcessingError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=share-errors-between-crates>Share errors between crates</h2><p>Since we require no other constraint that <code>impl std::error::Error</code> for composition, it&rsquo;s easy to nest errors using <code>thiserror</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in editoast_models
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;postgres error: {0}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>DbError</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>diesel</span>::<span style=color:#000>Error</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// in editoast_valkey (if we actually had that crate 👀)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;valkey error: {0}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ValkeyError</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span>::<span style=color:#000>RedisError</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// in editoast_views, where diesel isn&#39;t available
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;invalid resource form: {0}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>FormError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ResourceForm</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(name = </span><span style=color:#4e9a06>&#34;CreateResourceError&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// schema name &amp; error_type
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>CreateError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;will be overridden, but still useful for development&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(internal, name = </span><span style=color:#4e9a06>&#34;Database&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Db</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(transparent)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// shown to the user
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InvalidForm</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FormError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>create</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CreateError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>UpdateError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(internal)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Db</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(internal)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Valkey</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ValkeyError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(transparent)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InvalidForm</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FormError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>update</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UpdateError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=ease-composability>Ease composability</h2><h3 id=nesting-viewerrors>Nesting <code>ViewError</code>s</h3><p>We composed errors by nesting them thanks to <code>thiserror</code>. However, to compose and reuse <code>EditoastErrors</code>, we need a special flag so that when we attempt to serialize the error, we return the serialization of the source error directly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;no such infra: {id}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(context, status = NOT_FOUND)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// accepts http::StatusCode associated constants
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>InfraNotFound</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span>: <span style=color:#204a87;font-weight:700>u64</span> <span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;unauthorized&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(status = 401)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Unauthorized</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EndpointError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>NotFound</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[view_error]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>InfraNotFound</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Unauthorized</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[view_error]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Unauthorized</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;oh no&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Error1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=full-deriveviewerror-spec>Full <code>derive(ViewError)</code> spec</h2><p>The macro supports enums, named structs and tuple structs (fixme correct naming).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// not an EditoastError
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;wrong string: {0}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>WrongString</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// error_type = &#34;InvalidInt&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// context = { value: number }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#[derive(ViewError, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;wrong int: {value}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(user, name = </span><span style=color:#4e9a06>&#34;InvalidInt&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>WrongInt</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span>: <span style=color:#204a87;font-weight:700>i64</span> <span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(ViewError, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;my error type&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(context)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>MyError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// error_type = &#34;MyError::InvalidString&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// context = { expected_format: string }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// #[view_error(internal)] by default
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InvalidString</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>source</span>: <span style=color:#000>WrongString</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>expected_format</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// error_type = &#34;MyError::InvalidInt&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// context = { value: number } (xyz is skipped as we forward the ViewError)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>WrongInt</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[view_error]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>source</span>: <span style=color:#000>WrongInt</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xyz</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// error_type = &#34;MyError::Bad&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// context = { &#34;0&#34;: string, &#34;1&#34;: number }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;user did a bad with {0} and {1}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user, name = </span><span style=color:#4e9a06>&#34;Bad&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Oops</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=providing-context>Providing <code>context</code></h3><p>Context is computed just before the error is serialized in <code>axum</code>&rsquo;s error handler.</p><p>Note: it shouldn&rsquo;t be used in <code>editoast</code> as we now have enums variants we can <code>match</code> on. The <code>context</code> response field is meant to provide data potentially useful to the frontend so that it may perform some kind of error recovery.</p><p><code>derive(ViewError)</code> provides a few ways to set it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>NoContext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>because</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// context = { }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user, context)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>AllFieldsIntoContext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reasons</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// context = { &#34;reasons&#34;: [string] }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// select (and maybe rename) some fields to include to the context
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user, context(reason, recovery_id = </span><span style=color:#4e9a06>&#34;recovery&#34;</span><span style=color:#8f5902;font-style:italic>))]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>SomeFieldsIntoContext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>reason</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>recovery_id</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>not_serializable</span>: <span style=color:#000>mpsc</span>::<span style=color:#000>Sender</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>not_wanted</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// context = { &#34;reason&#34;: string, &#34;recovery&#34;: string }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// with a provider function
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(context_with = context_provider)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Variant1</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Variant2</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>context_provider</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>error</span>: <span style=color:#000>Error</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>serde_json</span>::<span style=color:#000>Value</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=about-core-errors>About Core errors</h3><p>The Core service is a bit special as it already returns errors with the common OSRD format. Since editoast doesn&rsquo;t really need to parse and recover from Core errors<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, we don&rsquo;t need an exhaustive list of them. We still need to differentiate them from other editoast errors (let&rsquo;s not start tossing <code>InternalError</code> around again…) and to provide a key for the frontend to translate them.</p><p>Core errors are then &ldquo;lightly&rdquo; wrapped: we keep the error as a generic <code>serde_json::Value</code> that we include into a <code>struct CoreError</code> that we can augment with additional information about the request. This way, the original is preserved, forwarded to the frontend, but fits our new error paradigm.</p><p><code>CoreError</code> draft:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in editoast_core
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>CoreError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// RabbitMQ &#34;endpoint&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rpc</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Request metadata
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metadata</span>: <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The original error
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>error</span>: <span style=color:#000>serde_json</span>::<span style=color:#000>Value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Note: the <code>error</code> field is kept as a <code>serde_json::Value</code> and not parsed (even though its format is standard) as we&rsquo;re not supposed to perform any kind of analysis or recovery on it. If we end up parsing it in the future, that means we need a stronger mapping between Core errors and what editoast expects. The red flag will be more obvious if we end up manipulating a JSON dict instead of a proper structure.</p><h3 id=why-do-we-need-a-derive-macro>Why do we need a derive macro?</h3><p>The main issue with our error system is that the types we manipulate do not serialize to the error format we want. For example, an error defined like so:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;{cause}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>MyError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cause</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fix</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>shouldn&rsquo;t be serialized as:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;cause&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Emperor Zurg&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;fix&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Buzz Lightyear&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>like <code>serde::Serialize</code> would do, but as:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;error_type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;editoast:MyError&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>500</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Emperor Zurg&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;context&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;cause&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Emperor Zurg&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;fix&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Buzz Lightyear&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>making <code>derive(serde::Serialize)</code> basically useless for our errors. On top of that, since by design the derive macros of <code>utoipa</code> (<code>ToSchema</code>, <code>IntoResponse</code> especially) interpret the type structure like <code>derive(serde::Serialize)</code> would do, we can&rsquo;t rely on them either. Therefore we need a custom derive macro to convey the structural information of the type at runtime, while still allowing a custom <code>Serialize</code> and <code>IntoResponse</code> implementations.</p><p>Another solution would be to shift our error definition paradigm and orient ourselves to a system without code generation (probably using a combination of traits and builders). This would imply to rewrite all our errors and their handling, which is costly 🤑🫰. We&rsquo;d also have to get rid of the convenience of <code>thiserror</code>, a huge loss in terms of ergonomics. And that would break the consistency with the other sub-crates of editoast.</p><p>The macro doesn&rsquo;t even have to be overly complex. The <code>trait ViewError</code> could be responsible of translating the static type definition into an associated constant, which would be used to compute data produced at runtime. (Ie. <code>impl axum::IntoResponse for T: ViewError</code> and <code>impl utoipa::IntoResponses for T: ViewError</code>.) This would reduce the amount of generated code, at the expense of more complex data manipulation at runtime.</p><p>Going this deep into the implementation is not the goal of this document: the best way to do things will be decided when the migration work will start.</p><h2 id=implementation-plan>Implementation plan</h2><p>We&rsquo;ll need a progressive migration as this implies too much change to fit in a single PR. <code>EditoastError</code> and <code>ViewError</code> will have to cohabit for some time.</p><h3 id=setup>Setup</h3><ol><li>Create the <code>trait views::ViewError</code></li><li>Implement an <code>axum::IntoResponse</code> for <code>ViewError</code> to generate a standard OSRD error response payload</li><li>Add a post-processing step to the OpenAPI generation to ensure the consistency of error status codes. More details below.</li><li>Create a derive macro <code>ViewError</code> that interfaces with <code>thiserror::Error</code> API and generates <em>at least</em> <code>impl ViewError</code></li><li>The macro may generate an <code>impl utoipa::IntoResponses</code> that tells <code>utoipa</code> what to expect in the response payloads. This trait may be auto-implemented for each <code>ViewError</code> type (we&rsquo;ll see how things go in the implementation).</li><li>We&rsquo;ll have to change the frontend error keys collection script almost entirely by the end of this migration. We could update it to also look for errors in the OpenAPI routes response section but that&rsquo;s extra work which brings little benefits. We accept a temporary desync of the error keys while this migration is ongoing.</li></ol><h3 id=migration>Migration</h3><p>The easier way to proceed here would be, to start by converting simple errors that occur deep in the stack (such as Postgres errors, Valkey errors, Core errors, etc.). This way, we can rely on the Rust compiler to guide us through the process and ensure we don&rsquo;t forget any error. We&rsquo;ll need some kind of adapters to incorporate these errors into <code>EditoastError</code>s. We may find a generic way to do that, but that&rsquo;s more an implementation detail, especially since that would be temporary.</p><p>A good starting place would be <code>editoast_search</code><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> because its internal errors do not implement <code>EditoastError</code> already. Valkey errors may also be a decent candidate.</p><p>One large change that will have to be atomic will be the adaptation of <code>Model</code>&rsquo;s errors<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><h3 id=wrapping-up-things>Wrapping up things</h3><p>Eventually, when all errors are converted and views errors are attached to their endpoint(s) in the OpenAPI, we&rsquo;ll have to:</p><ol><li>Remove <code>trait EditoastError</code>, <code>derive(EditoastError)</code> and <code>struct InternalError</code> (at least its former version as the name may be reused in a different scope)</li><li>Adapt the frontend error keys collection script to look for errors in the OpenAPI routes response section instead of <code>components/schemas</code></li><li>(Out of scope) Discuss with the frontend the level of visibility about internal errors we want to give the user</li></ol><h2 id=rejected-ideas>Rejected ideas</h2><h3 id=anonymous-enums>Anonymous enums</h3><div class="pageinfo pageinfo-warning"><p>Rejected because it wouldn&rsquo;t be trivial to implement the multiple <code>From&lt;T, U, ..> for EnumX&lt;T, U, ..></code> without negative type parameters or the fallback type (unstable). That&rsquo;s necessary to make the <code>EnumX</code> usage transparent and avoid using <code>T1</code>, &mldr;, <code>Tn</code> variants explicitly. The crate <code>anon_enum</code> deals with this issue by not providing the feature, so it won&rsquo;t help either.</p></div><p>Since we now have to really manage errors happening in every function <strong>as precisely as possible</strong>, there will likely be a lot of error enums going around. This may be a hassle and wrongfully encourage returning <code>Option</code> as an error. To circumvent that, an easy (albeit opinionated) QoL feature would be to use anonymous enums.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>get_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Resource</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Enum3</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ValkeyError</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MissingResourceError</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>process_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span>: <span style=color:#000>Resource</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Computation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Enum2</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProcessingError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[utoipa::path(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    ...,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    responses(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        (status = 200, body = Computation),
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        (status = 400, body = EndpointError)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    )
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>endpoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Path</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>)</span>: <span style=color:#000>Path</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Key</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Computation</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EndpointError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>get_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>process_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Json</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EndpointError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Db</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Valkey</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ValkeyError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(transparent)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Missing</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MissingResourceError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(transparent)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Processing</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProcessingError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The implementation of the <code>EnumX</code> type would be rather easy to generate for many tuple sizes. The crate <a href=https://docs.rs/anon_enum/1.1.0/anon_enum/>anon_enum</a> exists but if we choose to use this pattern, it&rsquo;s probably better to have our own type for greater flexibility and avoid another dependency.</p><h3 id=incident-reports>Incident reports</h3><div class="pageinfo pageinfo-warning"><p>Rejected because it would be another mechanism to maintain with little benefits: errors are already persisted using opentelemetry, and for &ldquo;internal server errors&rdquo;, it&rsquo;s up to the frontend to choose how much details is shown to the user.</p></div><p>For <code>internal</code> errors that won&rsquo;t contain meaningful information for the end user, we substitute the error by:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;error_type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;InternalError&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&lt;a meaningful message&gt;&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>500</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;context&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{},</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;incident&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&lt;uuid&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>In order to be able to find and investigate the error later on, we associate to each <code>5xx</code> error a unique <code>incident</code> identifier. At first we&rsquo;ll just log the incident with:</p><ul><li>the error message</li><li>the error <code>Debug</code> representation</li><li>the backtrace(s), if any</li></ul><p>The log entry will be persisted in datadog/jaeger so it&rsquo;s probably good enough at first.</p><p>It&rsquo;s useful in development to have the real error shown in the interface instead of just &ldquo;Internal error&rdquo;. We can set an environment variable <code>OSRD_DEV=1</code> to avoid replacing the error in the <code>axum</code> handler.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Core errors will likely never be recoverable from either editoast or the frontend. For the latter, such errors are likely to be displayed as a generic &ldquo;Internal error&rdquo; message. So no translation is needed. For these reasons, we don&rsquo;t need to pass them in the OpenAPI. However, if in the future, we want editoast to actually parse Core errors, ensuring a proper mapping will still be possible.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Provided we start this migration before the rewrite of the search engine.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>This work has already started at the time of writing.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><div class=section-index></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/OpenRailAssociation/osrd aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2025
<span class=td-footer__authors>OSRD contributors</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><script src=/js/main.min.70982f4f1de53d56b47d6b66c1ed442a9653a5be8820e0ba651d5d17d9a9bbe1.js integrity="sha256-cJgvTx3lPVa0fWtmwe1EKpZTpb6IIOC6ZR1dF9mpu+E=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>