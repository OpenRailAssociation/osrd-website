<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://osrd.fr/en/docs/reference/design-docs/editoast-errors/><link rel=alternate type=application/rss+xml href=https://osrd.fr/en/docs/reference/design-docs/editoast-errors/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Editoast error management | OSRD</title>
<meta name=description content="Open Source Railway Designer"><meta property="og:title" content="Editoast error management"><meta property="og:description" content="Open Source Railway Designer"><meta property="og:type" content="website"><meta property="og:url" content="https://osrd.fr/en/docs/reference/design-docs/editoast-errors/"><meta itemprop=name content="Editoast error management"><meta itemprop=description content="Open Source Railway Designer"><meta name=twitter:card content="summary"><meta name=twitter:title content="Editoast error management"><meta name=twitter:description content="Open Source Railway Designer"><link rel=preload href=/scss/main.min.86a6bb6b7070828a4efa42be7dea9c275f5278ac1b9f2879d2d7ee6cddf7c620.css as=style><link href=/scss/main.min.86a6bb6b7070828a4efa42be7dea9c275f5278ac1b9f2879d2d7ee6cddf7c620.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/en/><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" id="svg36" width="110.767" height="22"><style id="style1">.st9{fill:#fff}</style><g id="ok" transform="scale(.1918)"><g id="g36"><g id="g29"><path id="path23" d="M38.5 83.4c-1.9 8.2-2.9 17-2.9 26.5v4.8h16.6c-2.8-13.2-7.8-23.4-13.7-31.3z" class="st9"/><path id="path24" d="M0 57.5v19.9c3.1 1.2 6.3 2.7 9.5 4.6 8.5 5.2 15 12.6 19.4 21.8v-31c-3.4-3-6.9-5.5-10.3-7.5-6.5-3.7-13-6.2-18.6-7.8z" class="st9"/><path id="path25" d="M35.6 69.9c4.3-11.3 10.6-21.1 18.9-29.4V0H35.6z" class="st9"/><path id="path26" d="M40.8 75.4c5.3 6.2 10.1 13.8 13.7 23.3V50.6C48.6 57.8 44 66.1 40.8 75.4z" class="st9"/><path id="path27" d="M100.7.0H61.3v34.5C73.1 25.2 86 20 96.9 17.2c1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-11.4 2.9-25.3 8.6-37.2 19.7v31.8c2.9-6.3 6.7-11.7 11.4-16.4 9.4-9.3 21-14.1 30.5-16.6 1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-4.7 1.2-10.1 3.1-15.3 6-19 10.3-28.2 28.4-28.2 55.2v4.8h39.3c7.8.0 14.1-6.3 14.1-14.1V14.1C114.7 6.3 108.4.0 100.7.0z" class="st9"/><path id="path28" d="M22 59.6c2.2 1.3 4.5 2.8 6.8 4.6V0H14.1C6.3.0.0 6.3.0 14.1v36.4c6.5 1.7 14.2 4.5 22 9.1z" class="st9"/><path id="path29" d="M5.4 87.5c-1.8-1.1-3.6-2-5.4-2.8v15.9c0 7.8 6.3 14.1 14.1 14.1h11.6c-3.6-12.2-10.4-21.3-20.3-27.2z" class="st9"/></g><g id="g30"><path id="path30" d="M201.7 109c-30.8.0-53.7-21.2-53.7-52.5.0-31.7 22.9-51.6 53.7-51.6 31 0 53.9 20 53.9 51.6-.1 31.3-23 52.5-53.9 52.5zm0-82.6c-16.7.0-28.2 12.8-28.2 30.1.0 17.9 11.6 30.7 28.2 30.7S230 74.4 230 56.6c0-17.3-11.6-30.2-28.3-30.2z" class="st9"/></g><g id="g32"><g id="g31"><path id="path31" d="M334.3 33.3c-4-5.2-11.4-8.5-17.6-8.5-6.2.0-13.8 2.1-13.8 9.9.0 6.6 5.9 8.7 15.2 11.6 13.4 4.3 30.7 10 30.7 29.7.0 22.7-18.3 32.9-37.8 32.9-14.1.0-28.3-5.2-37-14.2l15.6-15.9c4.7 6 13.5 10.5 21.3 10.5 7.3.0 13.7-2.8 13.7-10.7.0-7.5-7.5-9.9-20.5-14.1C291.6 60.3 279 53.9 279 36c0-21.9 19.8-31 38.2-31 11.2.0 23.7 4.2 32.4 12.1z" class="st9"/></g></g><g id="g34"><g id="g33"><path id="path32" d="m433.1 106.4-21.3-39.2h-8.1v39.2h-23.4V7.6H418c19 0 37.8 7.3 37.8 29.9.0 13.3-7.8 22.7-20.5 26.6l25.8 42.3zm-16.9-79.6h-12.7v23h11.3c7.7.0 17.3-2 17.3-12 0-9.2-8.7-11-15.9-11z" class="st9"/></g></g><g id="g35"><path id="path34" d="M522.2 106.4h-36.8V7.6H521c28 0 56.5 11.7 56.5 49.1.0 34.7-28.1 49.7-55.3 49.7zm-1.7-78.5h-11.9v57.8h11.3c17 0 32.8-7 32.8-29 0-22.2-15.8-28.8-32.2-28.8z" class="st9"/></g></g></g></svg></span><span class=navbar-brand__name>OSRD</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/en/about/><span>About</span></a></li><li class=nav-item><a class="nav-link active" href=/en/docs/><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/en/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/en/join-us/><span>Join us</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/fr/>FranÃ§ais</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this siteâ€¦" aria-label="Search this siteâ€¦" autocomplete=off data-offline-search-index-json-src=/offline-search-index.a286d65757fe00ed91821112de8384ff.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/en/docs/reference/design-docs/editoast-errors/>Return to the regular view of this page</a>.</p></div><h1 class=title>Editoast error management</h1><ul></ul><div class=content><h1 id=issues-of-the-old-system>Issues of the old system</h1><ul><li>Mix between internal errors and API errors</li><li>Errors are converted into <code>InternalError</code> early, which means that a caller of a function returning an <code>editoast::Result</code> will have some trouble <code>match</code>ing on the error returned<ul><li>That means that it&rsquo;s troublesome to add context to an existing error, or to wrap it into another higher-level one.</li></ul></li><li>We can&rsquo;t track at compile-time which errors are returned by each function: that means that we don&rsquo;t know for sure which errors an endpoint can return (without careful manual investigation at least&mldr;)</li><li>Consequently, we hardly can declare in the OpenApi file what errors an endpoint precisely returns, degrading the editoast API quality</li><li>The frontend still requires editoast to declare all its errors though, to ensure they are translated properly. To achieve that we dynamically collect each <code>EditoastError</code> using the crate <code>inventory</code>. All the error descriptions collected are then transformed into OpenAPI schemas procedurally. On top of being a Rust antipattern (collecting state in proc-macros), this is complex to maintain on both editoast and frontend sides.<ul><li>Not having each endpoint linked to the list of errors it can raise, also prevents the frontend easily handling errors properly.</li></ul></li><li>It&rsquo;s still unclear how we should expose errors from Core.</li></ul><h1 id=goals>Goals</h1><ul><li>Have a clear separation between logically distinct errors.</li><li>Dispose of a way to actually match on errors when they occur deeper in the stack</li><li>Separate the error definition and their serialization.</li><li>Establish how we want to forward Core&rsquo;s errors.</li><li>Tie the errors to the endpoint they originate from in the OpenAPI.</li></ul><h1 id=constraints>Constraints</h1><ul><li>Keep the same error format (for backward compatibility reasons to avoid involving the frontend too much).<ul><li>We must keep the <code>editoast:</code> prefix in the error type.</li></ul></li><li>The error must live until it is handled, conversion to our standard error format only happens in the response serialization.</li><li>Errors must implement <code>std::error::Error</code>.</li><li>Errors must be composable. This will typically be handled by <code>thiserror</code>&rsquo;s <code>#[from]</code> attribute.</li><li>Error variants must be shareable to ensure the deduplication of error kinds. For example, let&rsquo;s say we have two functions <code>get_infra(id: usize)</code> and <code>rename_infra(id: usize, name: String)</code>. Both functions error types have to include a variant describing the error case of an infrastructure not being found by its ID. However, we can&rsquo;t duplicate something like <code>InfraNotFound { id: usize }</code> in both error types as this leads to two different error paths describing the same error case. This is especially problematic for error translation keys. We need to be able to define an error <code>InfraNotFound</code> and include it in both error types.<ul><li>A unicity check may be performed in the post-processing of the OpenAPI file to ensure that each error has a unique error type.</li></ul></li><li>Each endpoint must provide all its error cases in the OpenAPI. (How the frontend will consume them is another problem that we&rsquo;ll have to deal with.)</li><li>As for OSRD errors, the <code>context</code> field of the error is populated in the views.</li><li>Errors can be handled in a generic manner (for situations where it makes some sense to do so).<ul><li>I.e.: some form of downcasting is available.</li></ul></li></ul><h1 id=new-system>New system</h1><ul><li>Rely on <code>thiserror</code> everywhere.</li><li>Keep the <code>trait EditoastError</code> but only implement it for errors defined in <code>views</code>.<ul><li>Since it is only used in <code>views</code> now, let&rsquo;s rename it to <code>trait ViewError</code>.</li></ul></li><li>Create a proc-macro <code>derive(ViewError)</code> which interfaces with <code>derive(thiserror::Error)</code>.</li><li>The <code>context</code> is empty by default but can be provided by the <code>impl ViewError</code>. The macro is also able to take context providers.</li><li><code>ViewError</code>&rsquo;s <code>#[source]</code>, <code>#[from]</code>, <code>source</code> and <code>backtrace</code> fields are never serialized, unless explicitly provided. This shouldn&rsquo;t be the case as it exposes editoast internals at the API level.</li><li><code>impl&lt;T: ViewError> utoipa::IntoResponses for T</code> (may be generated or inferred)</li><li>Errors <strong>should not</strong> implement <code>Serialize</code> except for view errors (<code>derive(ViewError)</code>) which generates an <code>impl ViewError</code> used to serialize in the HTTP response.</li><li>Error cases that will be used repeatedly are defined as a <code>struct</code> but still <code>derive(thiserror::Error)</code>.</li><li>The <code>error_type</code> of each variant is generated by the macro at the format <code>ErrorTypeName::VariantName</code>, but can be provided explicitly if conflicts arise.<ul><li><code>editoast:</code> will be prepended systematically to indicate the service that raised the error.</li><li>Since this type is not guaranteed to be unique, we may implement a post-processing step to ensure errors with the same <code>error_type</code> have the same OpenAPI schema.</li><li>To ease the debugging process, an optional <code>source_location</code> will be provided in <code>ViewError</code>s containing a link to the GitHub file and line where the error is defined.</li></ul></li></ul><h2 id=nominal-case>Nominal case</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in mod views;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>get_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span>: <span style=color:#000>Key</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Resource</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GetError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>GetError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;ID not found&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>IdNotFound</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span>: <span style=color:#204a87;font-weight:700>u64</span> <span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;name not found&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>NameNotFound</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>process_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span>: <span style=color:#000>Resource</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Computation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProcessingError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ProcessingError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;Resource is invalid&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InvalidResource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource</span>: <span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;Resource is too old&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>OutdatedResource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource</span>: <span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[utoipa::path(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    ...,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    responses(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        (status = 200, body = Computation),
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        EndpointError, // impl utoipa::IntoResponse
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    )
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>endpoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Path</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>)</span>: <span style=color:#000>Path</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Key</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Computation</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EndpointError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>get_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>process_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Json</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EndpointError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;Resource not found&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// &lt;=&gt; status = 400
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>ResourceNotFound</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GetError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(internal)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// &lt;=&gt; status = 500, default
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>ProcessingFailed</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProcessingError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=share-errors-between-crates>Share errors between crates</h2><p>Since we require no other constraint that <code>impl std::error::Error</code> for composition, it&rsquo;s easy to nest errors using <code>thiserror</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in editoast_models
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;postgres error: {0}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>DbError</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>diesel</span>::<span style=color:#000>Error</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// in editoast_valkey (if we actually had that crate ðŸ‘€)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;valkey error: {0}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ValkeyError</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span>::<span style=color:#000>RedisError</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// in editoast_views, where diesel isn&#39;t available
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;invalid resource form: {0}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>FormError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ResourceForm</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(name = </span><span style=color:#4e9a06>&#34;CreateResourceError&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// schema name &amp; error_type
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>CreateError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;will be overridden, but still useful for development&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(internal, name = </span><span style=color:#4e9a06>&#34;Database&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Db</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(transparent)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// shown to the user
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InvalidForm</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FormError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>create</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CreateError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>UpdateError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(internal)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Db</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(internal)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Valkey</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ValkeyError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(transparent)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InvalidForm</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FormError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>update</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UpdateError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=ease-composability>Ease composability</h2><h3 id=nesting-viewerrors>Nesting <code>ViewError</code>s</h3><p>We composed errors by nesting them thanks to <code>thiserror</code>. However, to compose and reuse <code>EditoastErrors</code>, we need a special flag so that when we attempt to serialize the error, we return the serialization of the source error directly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;no such infra: {id}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(context, status = NOT_FOUND)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// accepts http::StatusCode associated constants
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>InfraNotFound</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span>: <span style=color:#204a87;font-weight:700>u64</span> <span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;unauthorized&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(status = 401)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Unauthorized</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EndpointError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>NotFound</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[view_error]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>InfraNotFound</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Unauthorized</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[view_error]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Unauthorized</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;oh no&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Error1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=full-deriveviewerror-spec>Full <code>derive(ViewError)</code> spec</h2><p>The macro supports enums, named structs and tuple structs (fixme correct naming).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// not an EditoastError
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;wrong string: {0}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>WrongString</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// error_type = &#34;InvalidInt&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// context = { value: number }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#[derive(ViewError, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;wrong int: {value}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(user, name = </span><span style=color:#4e9a06>&#34;InvalidInt&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>WrongInt</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span>: <span style=color:#204a87;font-weight:700>i64</span> <span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(ViewError, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;my error type&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(context)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>MyError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// error_type = &#34;MyError::InvalidString&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// context = { expected_format: string }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// #[view_error(internal)] by default
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InvalidString</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>source</span>: <span style=color:#000>WrongString</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>expected_format</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// error_type = &#34;MyError::InvalidInt&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// context = { value: number } (xyz is skipped as we forward the ViewError)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>WrongInt</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#[view_error]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>source</span>: <span style=color:#000>WrongInt</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xyz</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// error_type = &#34;MyError::Bad&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// context = { &#34;0&#34;: string, &#34;1&#34;: number }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;user did a bad with {0} and {1}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user, name = </span><span style=color:#4e9a06>&#34;Bad&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Oops</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=providing-context>Providing <code>context</code></h3><p>Context is computed just before the error is serialized in <code>axum</code>&rsquo;s error handler.</p><p>Note: it shouldn&rsquo;t be used in <code>editoast</code> as we now have enums variants we can <code>match</code> on. The <code>context</code> response field is meant to provide data potentially useful to the frontend so that it may perform some kind of error recovery.</p><p><code>derive(ViewError)</code> provides a few ways to set it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>NoContext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>because</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// context = { }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user, context)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>AllFieldsIntoContext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reasons</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// context = { &#34;reasons&#34;: [string] }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// select (and maybe rename) some fields to include to the context
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user, context(reason, recovery_id = </span><span style=color:#4e9a06>&#34;recovery&#34;</span><span style=color:#8f5902;font-style:italic>))]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>SomeFieldsIntoContext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>reason</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>recovery_id</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>not_serializable</span>: <span style=color:#000>mpsc</span>::<span style=color:#000>Sender</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>not_wanted</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>},</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// context = { &#34;reason&#34;: string, &#34;recovery&#34;: string }
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// with a provider function
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[view_error(context_with = context_provider)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Variant1</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Variant2</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>context_provider</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>error</span>: <span style=color:#000>Error</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>serde_json</span>::<span style=color:#000>Value</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=about-core-errors>About Core errors</h3><p>The Core service is a bit special as it already returns errors with the common OSRD format. Since editoast doesn&rsquo;t really need to parse and recover from Core errors<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, we don&rsquo;t need an exhaustive list of them. We still need to differentiate them from other editoast errors (let&rsquo;s not start tossing <code>InternalError</code> around againâ€¦) and to provide a key for the frontend to translate them.</p><p>Core errors are then &ldquo;lightly&rdquo; wrapped: we keep the error as a generic <code>serde_json::Value</code> that we include into a <code>struct CoreError</code> that we can augment with additional information about the request. This way, the original is preserved, forwarded to the frontend, but fits our new error paradigm.</p><p><code>CoreError</code> draft:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in editoast_core
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>CoreError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// RabbitMQ &#34;endpoint&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rpc</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Request metadata
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>metadata</span>: <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The original error
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>error</span>: <span style=color:#000>serde_json</span>::<span style=color:#000>Value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Note: the <code>error</code> field is kept as a <code>serde_json::Value</code> and not parsed (even though its format is standard) as we&rsquo;re not supposed to perform any kind of analysis or recovery on it. If we end up parsing it in the future, that means we need a stronger mapping between Core errors and what editoast expects. The red flag will be more obvious if we end up manipulating a JSON dict instead of a proper structure.</p><h3 id=why-do-we-need-a-derive-macro>Why do we need a derive macro?</h3><p>The main issue with our error system is that the types we manipulate do not serialize to the error format we want. For example, an error defined like so:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[error(</span><span style=color:#4e9a06>&#34;{cause}&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>MyError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cause</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fix</span>: <span style=color:#204a87>String</span> <span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>shouldn&rsquo;t be serialized as:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;cause&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Emperor Zurg&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;fix&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Buzz Lightyear&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>like <code>serde::Serialize</code> would do, but as:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;error_type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;editoast:MyError&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>500</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Emperor Zurg&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;context&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;cause&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Emperor Zurg&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;fix&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Buzz Lightyear&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>making <code>derive(serde::Serialize)</code> basically useless for our errors. On top of that, since by design the derive macros of <code>utoipa</code> (<code>ToSchema</code>, <code>IntoResponse</code> especially) interpret the type structure like <code>derive(serde::Serialize)</code> would do, we can&rsquo;t rely on them either. Therefore we need a custom derive macro to convey the structural information of the type at runtime, while still allowing a custom <code>Serialize</code> and <code>IntoResponse</code> implementations.</p><p>Another solution would be to shift our error definition paradigm and orient ourselves to a system without code generation (probably using a combination of traits and builders). This would imply to rewrite all our errors and their handling, which is costly ðŸ¤‘ðŸ«°. We&rsquo;d also have to get rid of the convenience of <code>thiserror</code>, a huge loss in terms of ergonomics. And that would break the consistency with the other sub-crates of editoast.</p><p>The macro doesn&rsquo;t even have to be overly complex. The <code>trait ViewError</code> could be responsible of translating the static type definition into an associated constant, which would be used to compute data produced at runtime. (Ie. <code>impl axum::IntoResponse for T: ViewError</code> and <code>impl utoipa::IntoResponses for T: ViewError</code>.) This would reduce the amount of generated code, at the expense of more complex data manipulation at runtime.</p><p>Going this deep into the implementation is not the goal of this document: the best way to do things will be decided when the migration work will start.</p><h2 id=implementation-plan>Implementation plan</h2><p>We&rsquo;ll need a progressive migration as this implies too much change to fit in a single PR. <code>EditoastError</code> and <code>ViewError</code> will have to cohabit for some time.</p><h3 id=setup>Setup</h3><ol><li>Create the <code>trait views::ViewError</code></li><li>Implement an <code>axum::IntoResponse</code> for <code>ViewError</code> to generate a standard OSRD error response payload</li><li>Add a post-processing step to the OpenAPI generation to ensure the consistency of error status codes. More details below.</li><li>Create a derive macro <code>ViewError</code> that interfaces with <code>thiserror::Error</code> API and generates <em>at least</em> <code>impl ViewError</code></li><li>The macro may generate an <code>impl utoipa::IntoResponses</code> that tells <code>utoipa</code> what to expect in the response payloads. This trait may be auto-implemented for each <code>ViewError</code> type (we&rsquo;ll see how things go in the implementation).</li><li>We&rsquo;ll have to change the frontend error keys collection script almost entirely by the end of this migration. We could update it to also look for errors in the OpenAPI routes response section but that&rsquo;s extra work which brings little benefits. We accept a temporary desync of the error keys while this migration is ongoing.</li></ol><h3 id=migration>Migration</h3><p>The easier way to proceed here would be, to start by converting simple errors that occur deep in the stack (such as Postgres errors, Valkey errors, Core errors, etc.). This way, we can rely on the Rust compiler to guide us through the process and ensure we don&rsquo;t forget any error. We&rsquo;ll need some kind of adapters to incorporate these errors into <code>EditoastError</code>s. We may find a generic way to do that, but that&rsquo;s more an implementation detail, especially since that would be temporary.</p><p>A good starting place would be <code>editoast_search</code><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> because its internal errors do not implement <code>EditoastError</code> already. Valkey errors may also be a decent candidate.</p><p>One large change that will have to be atomic will be the adaptation of <code>Model</code>&rsquo;s errors<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><h3 id=wrapping-up-things>Wrapping up things</h3><p>Eventually, when all errors are converted and views errors are attached to their endpoint(s) in the OpenAPI, we&rsquo;ll have to:</p><ol><li>Remove <code>trait EditoastError</code>, <code>derive(EditoastError)</code> and <code>struct InternalError</code> (at least its former version as the name may be reused in a different scope)</li><li>Adapt the frontend error keys collection script to look for errors in the OpenAPI routes response section instead of <code>components/schemas</code></li><li>(Out of scope) Discuss with the frontend the level of visibility about internal errors we want to give the user</li></ol><h2 id=rejected-ideas>Rejected ideas</h2><h3 id=anonymous-enums>Anonymous enums</h3><div class="pageinfo pageinfo-warning"><p>Rejected because it wouldn&rsquo;t be trivial to implement the multiple <code>From&lt;T, U, ..> for EnumX&lt;T, U, ..></code> without negative type parameters or the fallback type (unstable). That&rsquo;s necessary to make the <code>EnumX</code> usage transparent and avoid using <code>T1</code>, &mldr;, <code>Tn</code> variants explicitly. The crate <code>anon_enum</code> deals with this issue by not providing the feature, so it won&rsquo;t help either.</p></div><p>Since we now have to really manage errors happening in every function <strong>as precisely as possible</strong>, there will likely be a lot of error enums going around. This may be a hassle and wrongfully encourage returning <code>Option</code> as an error. To circumvent that, an easy (albeit opinionated) QoL feature would be to use anonymous enums.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>get_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Resource</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Enum3</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ValkeyError</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MissingResourceError</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>process_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span>: <span style=color:#000>Resource</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Computation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Enum2</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProcessingError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[utoipa::path(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    ...,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    responses(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        (status = 200, body = Computation),
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        (status = 400, body = EndpointError)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    )
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>endpoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Path</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>)</span>: <span style=color:#000>Path</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Key</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Computation</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EndpointError</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>get_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>process_resource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Json</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, thiserror::Error, ViewError)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EndpointError</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Db</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DbError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Valkey</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ValkeyError</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(transparent)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Missing</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MissingResourceError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[error(transparent)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[view_error(user)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Processing</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#[from]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProcessingError</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The implementation of the <code>EnumX</code> type would be rather easy to generate for many tuple sizes. The crate <a href=https://docs.rs/anon_enum/1.1.0/anon_enum/>anon_enum</a> exists but if we choose to use this pattern, it&rsquo;s probably better to have our own type for greater flexibility and avoid another dependency.</p><h3 id=incident-reports>Incident reports</h3><div class="pageinfo pageinfo-warning"><p>Rejected because it would be another mechanism to maintain with little benefits: errors are already persisted using opentelemetry, and for &ldquo;internal server errors&rdquo;, it&rsquo;s up to the frontend to choose how much details is shown to the user.</p></div><p>For <code>internal</code> errors that won&rsquo;t contain meaningful information for the end user, we substitute the error by:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;error_type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;InternalError&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&lt;a meaningful message&gt;&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>500</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;context&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{},</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;incident&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&lt;uuid&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>In order to be able to find and investigate the error later on, we associate to each <code>5xx</code> error a unique <code>incident</code> identifier. At first we&rsquo;ll just log the incident with:</p><ul><li>the error message</li><li>the error <code>Debug</code> representation</li><li>the backtrace(s), if any</li></ul><p>The log entry will be persisted in datadog/jaeger so it&rsquo;s probably good enough at first.</p><p>It&rsquo;s useful in development to have the real error shown in the interface instead of just &ldquo;Internal error&rdquo;. We can set an environment variable <code>OSRD_DEV=1</code> to avoid replacing the error in the <code>axum</code> handler.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Core errors will likely never be recoverable from either editoast or the frontend. For the latter, such errors are likely to be displayed as a generic &ldquo;Internal error&rdquo; message. So no translation is needed. For these reasons, we don&rsquo;t need to pass them in the OpenAPI. However, if in the future, we want editoast to actually parse Core errors, ensuring a proper mapping will still be possible.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Provided we start this migration before the rewrite of the search engine.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>This work has already started at the time of writing.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/OpenRailAssociation/osrd aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2025 OSRD contributors. All Rights Reserved</span></div></div></div></footer></div><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><script src=https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js integrity="sha512-ku2nmBrzAXY5YwohzTqLYH1/lvyMrpTVxgQKrvTabd/b/uesqltLORdmpVapYv6QhZVCLUX6wkvFaKOAY4xpUA==" crossorigin=anonymous></script><script src=/js/main.min.4261519102c0270f3bdd4edcd2b45867ee7a584a0ea82c94f59e4f991c6337a1.js integrity="sha256-QmFRkQLAJw873U7c0rRYZ+56WEoOqCyU9Z5PmRxjN6E=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>