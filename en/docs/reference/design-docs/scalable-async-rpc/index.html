<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Scalable async RPC | OSRD</title>
<meta name=description content="TODO: create another document describing RPC interactions between core and editoast
Context and requirements Without this proposal, editoast directly makes calls to core using http. Using k8s, if multiple core workers are started, requests are randomly distributed to core workers.
This architecture brings a number of issues:
To respond to a request, the core worker need to hold the request’s full infrastructure in memory. Workers do not have enough memory to hold all infrastructures in memory. Requests thus need to be routed to core workers specialized by infrastructure, which cannot be easily done using http. If too many requests are dispatched to a busy core worker, they will just time out. There is no easy way to scale up the number of workers to react to increased load. Because calls need to complete within the timeout of the client’s http requests, the system falls apart when latency increases due to load. This proposal intends to address these issues by introducing an RPC system which:"><meta property="og:url" content="https://osrd.fr/en/docs/reference/design-docs/scalable-async-rpc/"><meta property="og:site_name" content="OSRD"><meta property="og:title" content="Scalable async RPC"><meta property="og:description" content="TODO: create another document describing RPC interactions between core and editoast
Context and requirements Without this proposal, editoast directly makes calls to core using http. Using k8s, if multiple core workers are started, requests are randomly distributed to core workers.
This architecture brings a number of issues:
To respond to a request, the core worker need to hold the request’s full infrastructure in memory. Workers do not have enough memory to hold all infrastructures in memory. Requests thus need to be routed to core workers specialized by infrastructure, which cannot be easily done using http. If too many requests are dispatched to a busy core worker, they will just time out. There is no easy way to scale up the number of workers to react to increased load. Because calls need to complete within the timeout of the client’s http requests, the system falls apart when latency increases due to load. This proposal intends to address these issues by introducing an RPC system which:"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta itemprop=name content="Scalable async RPC"><meta itemprop=description content="TODO: create another document describing RPC interactions between core and editoast
Context and requirements Without this proposal, editoast directly makes calls to core using http. Using k8s, if multiple core workers are started, requests are randomly distributed to core workers.
This architecture brings a number of issues:
To respond to a request, the core worker need to hold the request’s full infrastructure in memory. Workers do not have enough memory to hold all infrastructures in memory. Requests thus need to be routed to core workers specialized by infrastructure, which cannot be easily done using http. If too many requests are dispatched to a busy core worker, they will just time out. There is no easy way to scale up the number of workers to react to increased load. Because calls need to complete within the timeout of the client’s http requests, the system falls apart when latency increases due to load. This proposal intends to address these issues by introducing an RPC system which:"><meta itemprop=wordCount content="3795"><meta name=twitter:card content="summary"><meta name=twitter:title content="Scalable async RPC"><meta name=twitter:description content="TODO: create another document describing RPC interactions between core and editoast
Context and requirements Without this proposal, editoast directly makes calls to core using http. Using k8s, if multiple core workers are started, requests are randomly distributed to core workers.
This architecture brings a number of issues:
To respond to a request, the core worker need to hold the request’s full infrastructure in memory. Workers do not have enough memory to hold all infrastructures in memory. Requests thus need to be routed to core workers specialized by infrastructure, which cannot be easily done using http. If too many requests are dispatched to a busy core worker, they will just time out. There is no easy way to scale up the number of workers to react to increased load. Because calls need to complete within the timeout of the client’s http requests, the system falls apart when latency increases due to load. This proposal intends to address these issues by introducing an RPC system which:"><link rel=preload href=/scss/main.min.48e4394a6d7434765a152dc0a5126083c99b73e5ace11fdd6da0f8a64fa9f30f.css as=style integrity="sha256-SOQ5Sm10NHZaFS3ApRJgg8mbc+Ws4R/dbaD4pk+p8w8=" crossorigin=anonymous><link href=/scss/main.min.48e4394a6d7434765a152dc0a5126083c99b73e5ace11fdd6da0f8a64fa9f30f.css rel=stylesheet integrity="sha256-SOQ5Sm10NHZaFS3ApRJgg8mbc+Ws4R/dbaD4pk+p8w8=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/en/><span class="navbar-brand__logo navbar-logo"><svg id="svg36" width="110.767" height="22"><style id="style1">.st9{fill:#fff}</style><g id="ok" transform="scale(.1918)"><g id="g36"><g id="g29"><path id="path23" d="M38.5 83.4c-1.9 8.2-2.9 17-2.9 26.5v4.8h16.6c-2.8-13.2-7.8-23.4-13.7-31.3z" class="st9"/><path id="path24" d="M0 57.5v19.9c3.1 1.2 6.3 2.7 9.5 4.6 8.5 5.2 15 12.6 19.4 21.8v-31c-3.4-3-6.9-5.5-10.3-7.5-6.5-3.7-13-6.2-18.6-7.8z" class="st9"/><path id="path25" d="M35.6 69.9c4.3-11.3 10.6-21.1 18.9-29.4V0H35.6z" class="st9"/><path id="path26" d="M40.8 75.4c5.3 6.2 10.1 13.8 13.7 23.3V50.6C48.6 57.8 44 66.1 40.8 75.4z" class="st9"/><path id="path27" d="M100.7.0H61.3v34.5C73.1 25.2 86 20 96.9 17.2c1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-11.4 2.9-25.3 8.6-37.2 19.7v31.8c2.9-6.3 6.7-11.7 11.4-16.4 9.4-9.3 21-14.1 30.5-16.6 1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-4.7 1.2-10.1 3.1-15.3 6-19 10.3-28.2 28.4-28.2 55.2v4.8h39.3c7.8.0 14.1-6.3 14.1-14.1V14.1C114.7 6.3 108.4.0 100.7.0z" class="st9"/><path id="path28" d="M22 59.6c2.2 1.3 4.5 2.8 6.8 4.6V0H14.1C6.3.0.0 6.3.0 14.1v36.4c6.5 1.7 14.2 4.5 22 9.1z" class="st9"/><path id="path29" d="M5.4 87.5c-1.8-1.1-3.6-2-5.4-2.8v15.9c0 7.8 6.3 14.1 14.1 14.1h11.6c-3.6-12.2-10.4-21.3-20.3-27.2z" class="st9"/></g><g id="g30"><path id="path30" d="M201.7 109c-30.8.0-53.7-21.2-53.7-52.5.0-31.7 22.9-51.6 53.7-51.6 31 0 53.9 20 53.9 51.6-.1 31.3-23 52.5-53.9 52.5zm0-82.6c-16.7.0-28.2 12.8-28.2 30.1.0 17.9 11.6 30.7 28.2 30.7S230 74.4 230 56.6c0-17.3-11.6-30.2-28.3-30.2z" class="st9"/></g><g id="g32"><g id="g31"><path id="path31" d="M334.3 33.3c-4-5.2-11.4-8.5-17.6-8.5-6.2.0-13.8 2.1-13.8 9.9.0 6.6 5.9 8.7 15.2 11.6 13.4 4.3 30.7 10 30.7 29.7.0 22.7-18.3 32.9-37.8 32.9-14.1.0-28.3-5.2-37-14.2l15.6-15.9c4.7 6 13.5 10.5 21.3 10.5 7.3.0 13.7-2.8 13.7-10.7.0-7.5-7.5-9.9-20.5-14.1C291.6 60.3 279 53.9 279 36c0-21.9 19.8-31 38.2-31 11.2.0 23.7 4.2 32.4 12.1z" class="st9"/></g></g><g id="g34"><g id="g33"><path id="path32" d="m433.1 106.4-21.3-39.2h-8.1v39.2h-23.4V7.6H418c19 0 37.8 7.3 37.8 29.9.0 13.3-7.8 22.7-20.5 26.6l25.8 42.3zm-16.9-79.6h-12.7v23h11.3c7.7.0 17.3-2 17.3-12 0-9.2-8.7-11-15.9-11z" class="st9"/></g></g><g id="g35"><path id="path34" d="M522.2 106.4h-36.8V7.6H521c28 0 56.5 11.7 56.5 49.1.0 34.7-28.1 49.7-55.3 49.7zm-1.7-78.5h-11.9v57.8h11.3c17 0 32.8-7 32.8-29 0-22.2-15.8-28.8-32.2-28.8z" class="st9"/></g></g></g></svg></span><span class=navbar-brand__name>OSRD</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/en/about/><span>About</span></a></li><li class=nav-item><a class="nav-link active" href=/en/docs/><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/en/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/en/join-us/><span>Join us</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/fr/>Français</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.9b18ff02cb00321dc9805ff58543a27d.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.9b18ff02cb00321dc9805ff58543a27d.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse foldable-nav" id=td-section-nav><div class="td-sidebar-nav__section nav-item dropdown d-block d-lg-none"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/fr/>Français</a></li></ul></div></div><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-endocs-li><a href=/en/docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-endocs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsexplanation-li><input type=checkbox id=m-endocsexplanation-check>
<label for=m-endocsexplanation-check><a href=/en/docs/explanation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanation><span>Explanations</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationcontainers-architecture-li><input type=checkbox id=m-endocsexplanationcontainers-architecture-check>
<label for=m-endocsexplanationcontainers-architecture-check><a href=/en/docs/explanation/containers-architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationcontainers-architecture><span>Containers architecture</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsexplanationmodels-li><input type=checkbox id=m-endocsexplanationmodels-check>
<label for=m-endocsexplanationmodels-check><a href=/en/docs/explanation/models/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationmodels><span>Models</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationmodelsdata-models-full-example-li><input type=checkbox id=m-endocsexplanationmodelsdata-models-full-example-check>
<label for=m-endocsexplanationmodelsdata-models-full-example-check><a href=/en/docs/explanation/models/data-models-full-example/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationmodelsdata-models-full-example><span>Infrastructure example</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationmodelsneutral_sections-li><input type=checkbox id=m-endocsexplanationmodelsneutral_sections-check>
<label for=m-endocsexplanationmodelsneutral_sections-check><a href=/en/docs/explanation/models/neutral_sections/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationmodelsneutral_sections><span>Neutral Sections</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationmodelsrealistic-rolling-stocks-li><input type=checkbox id=m-endocsexplanationmodelsrealistic-rolling-stocks-check>
<label for=m-endocsexplanationmodelsrealistic-rolling-stocks-check><a href=/en/docs/explanation/models/realistic-rolling-stocks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationmodelsrealistic-rolling-stocks><span>Rolling stock categories</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsexplanationrunning_time_calculation-li><input type=checkbox id=m-endocsexplanationrunning_time_calculation-check>
<label for=m-endocsexplanationrunning_time_calculation-check><a href=/en/docs/explanation/running_time_calculation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationrunning_time_calculation><span>Running time calculation</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationphysical_modeling-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationphysical_modeling-check>
<label for=m-endocsexplanationrunning_time_calculationphysical_modeling-check><a href=/en/docs/explanation/running_time_calculation/physical_modeling/ title="Physical modeling" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationphysical_modeling><span>1 - Physical modeling</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationnumerical_integration-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationnumerical_integration-check>
<label for=m-endocsexplanationrunning_time_calculationnumerical_integration-check><a href=/en/docs/explanation/running_time_calculation/numerical_integration/ title="Numerical integration" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationnumerical_integration><span>2 - Numerical integration</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationenvelopes_system-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationenvelopes_system-check>
<label for=m-endocsexplanationrunning_time_calculationenvelopes_system-check><a href=/en/docs/explanation/running_time_calculation/envelopes_system/ title="Envelopes system" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationenvelopes_system><span>3 - Envelopes system</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationpipeline-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationpipeline-check>
<label for=m-endocsexplanationrunning_time_calculationpipeline-check><a href=/en/docs/explanation/running_time_calculation/pipeline/ title=Pipeline class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationpipeline><span>4 - Pipeline</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationrunning_time_calculationallowances-li><input type=checkbox id=m-endocsexplanationrunning_time_calculationallowances-check>
<label for=m-endocsexplanationrunning_time_calculationallowances-check><a href=/en/docs/explanation/running_time_calculation/allowances/ title=Allowances class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsexplanationrunning_time_calculationallowances><span>5 - Allowances</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsexplanationnetzgrafik-editor-li><input type=checkbox id=m-endocsexplanationnetzgrafik-editor-check>
<label for=m-endocsexplanationnetzgrafik-editor-check><a href=/en/docs/explanation/netzgrafik-editor/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsexplanationnetzgrafik-editor><span>Netzgrafik-Editor</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguides-li><input type=checkbox id=m-endocsguides-check>
<label for=m-endocsguides-check><a href=/en/docs/guides/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguides><span>How-to Guides</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguidescontribute-li><input type=checkbox id=m-endocsguidescontribute-check>
<label for=m-endocsguidescontribute-check><a href=/en/docs/guides/contribute/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidescontribute><span>Contribute to OSRD</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributepreamble-li><input type=checkbox id=m-endocsguidescontributepreamble-check>
<label for=m-endocsguidescontributepreamble-check><a href=/en/docs/guides/contribute/preamble/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributepreamble><span>Preamble</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributelicense-and-set-up-li><input type=checkbox id=m-endocsguidescontributelicense-and-set-up-check>
<label for=m-endocsguidescontributelicense-and-set-up-check><a href=/en/docs/guides/contribute/license-and-set-up/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributelicense-and-set-up><span>License and set-up</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguidescontributecontribute-code-li><input type=checkbox id=m-endocsguidescontributecontribute-code-check>
<label for=m-endocsguidescontributecontribute-code-check><a href=/en/docs/guides/contribute/contribute-code/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidescontributecontribute-code><span>Contribute code</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codegeneral-principles-li><input type=checkbox id=m-endocsguidescontributecontribute-codegeneral-principles-check>
<label for=m-endocsguidescontributecontribute-codegeneral-principles-check><a href=/en/docs/guides/contribute/contribute-code/general-principles/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codegeneral-principles><span>General principles</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codebackend-conventions-li><input type=checkbox id=m-endocsguidescontributecontribute-codebackend-conventions-check>
<label for=m-endocsguidescontributecontribute-codebackend-conventions-check><a href=/en/docs/guides/contribute/contribute-code/backend-conventions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codebackend-conventions><span>Back-end conventions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codefrontend-conventions-li><input type=checkbox id=m-endocsguidescontributecontribute-codefrontend-conventions-check>
<label for=m-endocsguidescontributecontribute-codefrontend-conventions-check><a href=/en/docs/guides/contribute/contribute-code/frontend-conventions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codefrontend-conventions><span>Front-end conventions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codewrite-code-li><input type=checkbox id=m-endocsguidescontributecontribute-codewrite-code-check>
<label for=m-endocsguidescontributecontribute-codewrite-code-check><a href=/en/docs/guides/contribute/contribute-code/write-code/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codewrite-code><span>Write code</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codecommit-conventions-li><input type=checkbox id=m-endocsguidescontributecontribute-codecommit-conventions-check>
<label for=m-endocsguidescontributecontribute-codecommit-conventions-check><a href=/en/docs/guides/contribute/contribute-code/commit-conventions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codecommit-conventions><span>Commit conventions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codeshare-changes-li><input type=checkbox id=m-endocsguidescontributecontribute-codeshare-changes-check>
<label for=m-endocsguidescontributecontribute-codeshare-changes-check><a href=/en/docs/guides/contribute/contribute-code/share-changes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codeshare-changes><span>Share your changes</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecontribute-codetests-li><input type=checkbox id=m-endocsguidescontributecontribute-codetests-check>
<label for=m-endocsguidescontributecontribute-codetests-check><a href=/en/docs/guides/contribute/contribute-code/tests/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecontribute-codetests><span>Tests</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributecode-review-li><input type=checkbox id=m-endocsguidescontributecode-review-check>
<label for=m-endocsguidescontributecode-review-check><a href=/en/docs/guides/contribute/code-review/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributecode-review><span>Review process</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributebug-reports-li><input type=checkbox id=m-endocsguidescontributebug-reports-check>
<label for=m-endocsguidescontributebug-reports-check><a href=/en/docs/guides/contribute/bug-reports/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributebug-reports><span>Report issues</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributeinstall-docker-li><input type=checkbox id=m-endocsguidescontributeinstall-docker-check>
<label for=m-endocsguidescontributeinstall-docker-check><a href=/en/docs/guides/contribute/install-docker/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributeinstall-docker><span>Install docker</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidescontributereview-process-li><input type=checkbox id=m-endocsguidescontributereview-process-check>
<label for=m-endocsguidescontributereview-process-check><a href=/en/docs/guides/contribute/review-process/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidescontributereview-process><span></span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguidesdeploy-li><input type=checkbox id=m-endocsguidesdeploy-check>
<label for=m-endocsguidesdeploy-check><a href=/en/docs/guides/deploy/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidesdeploy><span>Deploy OSRD</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesdeploydocker-compose-li><input type=checkbox id=m-endocsguidesdeploydocker-compose-check>
<label for=m-endocsguidesdeploydocker-compose-check><a href=/en/docs/guides/deploy/docker-compose/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidesdeploydocker-compose><span>Docker Compose</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesdeploykubernetes-li><input type=checkbox id=m-endocsguidesdeploykubernetes-check>
<label for=m-endocsguidesdeploykubernetes-check><a href=/en/docs/guides/deploy/kubernetes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidesdeploykubernetes><span>Kubernetes with Helm</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesdeploystdcm-search-env-li><input type=checkbox id=m-endocsguidesdeploystdcm-search-env-check>
<label for=m-endocsguidesdeploystdcm-search-env-check><a href=/en/docs/guides/deploy/stdcm-search-env/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidesdeploystdcm-search-env><span>STDCM search environment configuration</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguideslogo-li><input type=checkbox id=m-endocsguideslogo-check>
<label for=m-endocsguideslogo-check><a href=/en/docs/guides/logo/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguideslogo><span>Logo</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesdesign-li><input type=checkbox id=m-endocsguidesdesign-check>
<label for=m-endocsguidesdesign-check><a href=/en/docs/guides/design/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidesdesign><span>OSRD's design</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsguidesrelease-li><input type=checkbox id=m-endocsguidesrelease-check>
<label for=m-endocsguidesrelease-check><a href=/en/docs/guides/release/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsguidesrelease><span>Release</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesreleaseprocess-li><input type=checkbox id=m-endocsguidesreleaseprocess-check>
<label for=m-endocsguidesreleaseprocess-check><a href=/en/docs/guides/release/process/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidesreleaseprocess><span>Release process</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsguidesreleasepublish-li><input type=checkbox id=m-endocsguidesreleasepublish-check>
<label for=m-endocsguidesreleasepublish-check><a href=/en/docs/guides/release/publish/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsguidesreleasepublish><span>Publish a new release</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-endocsreference-li><input type=checkbox id=m-endocsreference-check checked>
<label for=m-endocsreference-check><a href=/en/docs/reference/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreference><span>Technical reference</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencearchitecture-li><input type=checkbox id=m-endocsreferencearchitecture-check>
<label for=m-endocsreferencearchitecture-check><a href=/en/docs/reference/architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencearchitecture><span>Architecture</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencearchitecturedata_flow-li><input type=checkbox id=m-endocsreferencearchitecturedata_flow-check>
<label for=m-endocsreferencearchitecturedata_flow-check><a href=/en/docs/reference/architecture/data_flow/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencearchitecturedata_flow><span>Data-flow</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencearchitectureservices-li><input type=checkbox id=m-endocsreferencearchitectureservices-check>
<label for=m-endocsreferencearchitectureservices-check><a href=/en/docs/reference/architecture/services/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencearchitectureservices><span>Services</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-endocsreferencedesign-docs-li><input type=checkbox id=m-endocsreferencedesign-docs-check checked>
<label for=m-endocsreferencedesign-docs-check><a href=/en/docs/reference/design-docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docs><span>Design documents</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docssignaling-li><input type=checkbox id=m-endocsreferencedesign-docssignaling-check>
<label for=m-endocsreferencedesign-docssignaling-check><a href=/en/docs/reference/design-docs/signaling/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docssignaling><span>Signaling</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docssignalingsignaling-systems-li><input type=checkbox id=m-endocsreferencedesign-docssignalingsignaling-systems-check>
<label for=m-endocsreferencedesign-docssignalingsignaling-systems-check><a href=/en/docs/reference/design-docs/signaling/signaling-systems/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docssignalingsignaling-systems><span>Signaling systems</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docssignalingblocks-and-signals-li><input type=checkbox id=m-endocsreferencedesign-docssignalingblocks-and-signals-check>
<label for=m-endocsreferencedesign-docssignalingblocks-and-signals-check><a href=/en/docs/reference/design-docs/signaling/blocks-and-signals/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docssignalingblocks-and-signals><span>Blocks and signals</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docssignalingspeed-limits-li><input type=checkbox id=m-endocsreferencedesign-docssignalingspeed-limits-check>
<label for=m-endocsreferencedesign-docssignalingspeed-limits-check><a href=/en/docs/reference/design-docs/signaling/speed-limits/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docssignalingspeed-limits><span>Speed limits</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docssignalingsimulation-li><input type=checkbox id=m-endocsreferencedesign-docssignalingsimulation-check>
<label for=m-endocsreferencedesign-docssignalingsimulation-check><a href=/en/docs/reference/design-docs/signaling/simulation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docssignalingsimulation><span>Simulation lifecycle</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsconflict-detection-li><input type=checkbox id=m-endocsreferencedesign-docsconflict-detection-check>
<label for=m-endocsreferencedesign-docsconflict-detection-check><a href=/en/docs/reference/design-docs/conflict-detection/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsconflict-detection><span>Conflict detection</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docstrain-sim-v3-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3-check><a href=/en/docs/reference/design-docs/train-sim-v3/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docstrain-sim-v3><span>Train simulation v3</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstrain-sim-v3overview-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3overview-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3overview-check><a href=/en/docs/reference/design-docs/train-sim-v3/overview/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstrain-sim-v3overview><span>Overview</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstrain-sim-v3prior-art-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3prior-art-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3prior-art-check><a href=/en/docs/reference/design-docs/train-sim-v3/prior-art/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstrain-sim-v3prior-art><span>Prior art</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstrain-sim-v3driving-instruction-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3driving-instruction-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3driving-instruction-check><a href=/en/docs/reference/design-docs/train-sim-v3/driving-instruction/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstrain-sim-v3driving-instruction><span>Driving instructions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstrain-sim-v3driver-behavior-modules-li><input type=checkbox id=m-endocsreferencedesign-docstrain-sim-v3driver-behavior-modules-check>
<label for=m-endocsreferencedesign-docstrain-sim-v3driver-behavior-modules-check><a href=/en/docs/reference/design-docs/train-sim-v3/driver-behavior-modules/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstrain-sim-v3driver-behavior-modules><span>Driver behavior modules</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docsstdcm-li><input type=checkbox id=m-endocsreferencedesign-docsstdcm-check>
<label for=m-endocsreferencedesign-docsstdcm-check><a href=/en/docs/reference/design-docs/stdcm/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docsstdcm><span>Search for last-minute train slots (STDCM)</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmdomain_context-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmdomain_context-check>
<label for=m-endocsreferencedesign-docsstdcmdomain_context-check><a href=/en/docs/reference/design-docs/stdcm/domain_context/ title="Business context" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmdomain_context><span>1 - Business Context</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docsstdcmpathfinding_module-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_module-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_module-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/ title="Train slot search module" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docsstdcmpathfinding_module><span>2 - Train slot search module</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleinfrastructure_exploration-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_moduleinfrastructure_exploration-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_moduleinfrastructure_exploration-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/infrastructure_exploration/ title="Infrastructure exploration" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleinfrastructure_exploration><span>1 - Infrastructure exploration</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_detection-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_detection-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_detection-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/conflict_detection/ title="Conflict detection" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_detection><span>2 - Conflict detection</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_modulegraph_representation-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_modulegraph_representation-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_modulegraph_representation-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/graph_representation/ title="Encoding the solution space" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_modulegraph_representation><span>2 - Encoding the solution space</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_modulebacktracking-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_modulebacktracking-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_modulebacktracking-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/backtracking/ title="Discontinuities and backtracking" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_modulebacktracking><span>3 - Discontinuities and backtracking</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_avoidance-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_avoidance-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_avoidance-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/conflict_avoidance/ title="Conflict avoidance" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleconflict_avoidance><span>4 - Conflict avoidance</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_modulestandard_allowance-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_modulestandard_allowance-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_modulestandard_allowance-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/standard_allowance/ title="Standard allowance" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_modulestandard_allowance><span>5 - Standard allowance</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleimplementation_details-li><input type=checkbox id=m-endocsreferencedesign-docsstdcmpathfinding_moduleimplementation_details-check>
<label for=m-endocsreferencedesign-docsstdcmpathfinding_moduleimplementation_details-check><a href=/en/docs/reference/design-docs/stdcm/pathfinding_module/implementation_details/ title="Implementation details" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsstdcmpathfinding_moduleimplementation_details><span>6 - Implementation details</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docstimetable-li><input type=checkbox id=m-endocsreferencedesign-docstimetable-check>
<label for=m-endocsreferencedesign-docstimetable-check><a href=/en/docs/reference/design-docs/timetable/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docstimetable><span>Timetable v2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferencedesign-docsauth-li><input type=checkbox id=m-endocsreferencedesign-docsauth-check>
<label for=m-endocsreferencedesign-docsauth-check><a href=/en/docs/reference/design-docs/auth/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docsauth><span>Authentication and authorization</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docsautheditoast-internal-api-li><input type=checkbox id=m-endocsreferencedesign-docsautheditoast-internal-api-check>
<label for=m-endocsreferencedesign-docsautheditoast-internal-api-check><a href=/en/docs/reference/design-docs/auth/editoast-internal-api/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsautheditoast-internal-api><span>Editoast internal authorization API</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferencedesign-docseditoast-errors-li><input type=checkbox id=m-endocsreferencedesign-docseditoast-errors-check>
<label for=m-endocsreferencedesign-docseditoast-errors-check><a href=/en/docs/reference/design-docs/editoast-errors/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferencedesign-docseditoast-errors><span>Editoast error management</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-endocsreferencedesign-docsscalable-async-rpc-li><input type=checkbox id=m-endocsreferencedesign-docsscalable-async-rpc-check checked>
<label for=m-endocsreferencedesign-docsscalable-async-rpc-check><a href=/en/docs/reference/design-docs/scalable-async-rpc/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-endocsreferencedesign-docsscalable-async-rpc><span class=td-sidebar-nav-active-item>Scalable async RPC</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsreferenceapis-li><input type=checkbox id=m-endocsreferenceapis-check>
<label for=m-endocsreferenceapis-check><a href=/en/docs/reference/apis/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsreferenceapis><span>APIs</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferenceapiseditoast-li><input type=checkbox id=m-endocsreferenceapiseditoast-check>
<label for=m-endocsreferenceapiseditoast-check><a href=/en/docs/reference/apis/editoast/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferenceapiseditoast><span>Editoast</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsreferenceapisgateway-li><input type=checkbox id=m-endocsreferenceapisgateway-check>
<label for=m-endocsreferenceapisgateway-check><a href=/en/docs/reference/apis/gateway/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsreferenceapisgateway><span>Gateway</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsrailway-wiki-li><input type=checkbox id=m-endocsrailway-wiki-check>
<label for=m-endocsrailway-wiki-check><a href=/en/docs/railway-wiki/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wiki><span>Railway Wiki</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikiglossary-li><input type=checkbox id=m-endocsrailway-wikiglossary-check>
<label for=m-endocsrailway-wikiglossary-check><a href=/en/docs/railway-wiki/glossary/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikiglossary><span>Glossary</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-endocsrailway-wikisignallingspacingertms-li><input type=checkbox id=m-endocsrailway-wikisignallingspacingertms-check>
<label for=m-endocsrailway-wikisignallingspacingertms-check><a href=/en/docs/railway-wiki/signalling/spacing/ertms/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-endocsrailway-wikisignallingspacingertms><span>ETCS (ERTMS)</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-endocsrailway-wikisignallingspacingertmsetcs-li><input type=checkbox id=m-endocsrailway-wikisignallingspacingertmsetcs-check>
<label for=m-endocsrailway-wikisignallingspacingertmsetcs-check><a href=/en/docs/railway-wiki/signalling/spacing/ertms/etcs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-endocsrailway-wikisignallingspacingertmsetcs><span>ETCS</span></a></label></li></ul></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/OpenRailAssociation/osrd-website/tree/master/content/reference/design-docs/scalable-async-rpc/index.en.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/OpenRailAssociation/osrd-website/edit/master/content/reference/design-docs/scalable-async-rpc/index.en.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/OpenRailAssociation/osrd-website/new/master/content/reference/design-docs/scalable-async-rpc?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/OpenRailAssociation/osrd-website/issues/new?title=Scalable%20async%20RPC" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/OpenRailAssociation/osrd/issues/new class="td-page-meta--project td-page-meta__project-issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
<a id=print href=/en/docs/reference/design-docs/_print/><i class="fa-solid fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#context-and-requirements>Context and requirements</a><ul><li><a href=#goals>Goals</a></li><li><a href=#non-goals>Non-goals</a></li></ul></li><li><a href=#concepts>Concepts</a><ul><li><a href=#client>Client</a></li><li><a href=#worker-key>Worker key</a></li><li><a href=#worker-pools>Worker pools</a></li><li><a href=#worker-group>Worker group</a></li><li><a href=#worker>Worker</a></li><li><a href=#osrdyne>osrdyne</a></li></ul></li><li><a href=#rpc-protocol>RPC protocol</a><ul><li><a href=#client-protocol>Client protocol</a></li><li><a href=#worker-protocol>Worker protocol</a></li></ul></li><li><a href=#message-passing-architecture>Message passing architecture</a></li><li><a href=#message-lifetime>Message lifetime</a></li><li><a href=#service-architecture>Service architecture</a></li><li><a href=#life-of-an-rpc-call>Life of an RPC call</a><ul><li><a href=#fast-path>Fast path</a></li><li><a href=#worker-group-startup>Worker group startup</a></li></ul></li><li><a href=#osrdyne-architecture>osrdyne architecture</a><ul><li><a href=#exchanges-and-queues>Exchanges and queues</a></li><li><a href=#worker-group-manager>Worker group manager</a></li><li><a href=#request-queues-control-loop>Request queues control loop</a></li><li><a href=#worker-groups-control-loop>Worker groups control loop</a></li><li><a href=#worker-activity-processor>Worker activity processor</a></li></ul></li><li><a href=#failure-mode-analysis>Failure mode analysis</a><ul><li><a href=#the-worker-fails-to-parse-a-message>The worker fails to parse a message</a></li><li><a href=#the-worker-dies-or-stalls-when-processing-a-message>The worker dies or stalls when processing a message</a></li><li><a href=#osrdyne-fails-to-start>osrdyne fails to start</a></li><li><a href=#invalid-worker-key>Invalid worker key</a></li><li><a href=#workers-fails-to-start>Workers fails to start</a></li><li><a href=#multiple-osrdyne-daemons-are-started-on-the-same-pool>Multiple osrdyne daemons are started on the same pool</a></li></ul></li><li><a href=#known-limitations>Known limitations</a><ul><li><a href=#latency-publisher-confirms-and-reliability>Latency, publisher confirms and reliability</a></li><li><a href=#at-least-once-semantics>At least once semantics</a></li></ul></li><li><a href=#design-decisions>Design decisions</a><ul><li><a href=#using-rabbitmq>Using RabbitMQ</a></li><li><a href=#queues-are-created-by-osrdyne>Queues are created by osrdyne</a></li><li><a href=#osrdyne-republishes-orphan-messages>osrdyne republishes orphan messages</a></li><li><a href=#osrdyne-responds-to-dead-lettered-messages>osrdyne responds to dead lettered messages</a></li><li><a href=#messages-are-only-acked-by-workers-once-processed>Messages are only ACKed by workers once processed</a></li><li><a href=#report-worker-activity-using-amqp>Report worker activity using AMQP</a></li><li><a href=#make-worker-group-lifetime-decisions-in-a-separate-actor>Make worker group lifetime decisions in a separate actor</a></li><li><a href=#unbind-the-queue-and-wait-before-stopping-workers>Unbind the queue and wait before stopping workers</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/en/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/en/docs/reference/>Technical reference</a></li><li class=breadcrumb-item><a href=/en/docs/reference/design-docs/>Design documents</a></li><li class="breadcrumb-item active" aria-current=page>Scalable async RPC</li></ol></nav><div class=td-content><h1>Scalable async RPC</h1><header class=article-meta></header><p>TODO: create another document describing RPC interactions between core and editoast</p><h2 id=context-and-requirements>Context and requirements</h2><p>Without this proposal, editoast directly makes calls to core using http.
Using k8s, if multiple core workers are started, requests are randomly
distributed to core workers.</p><p>This architecture brings a number of issues:</p><ul><li>To respond to a request, the core worker need to hold the request&rsquo;s full infrastructure in memory.
Workers do not have enough memory to hold all infrastructures in memory.
Requests thus need to be routed to core workers specialized by infrastructure, which cannot be easily done using http.</li><li>If too many requests are dispatched to a busy core worker, they will just time out.</li><li>There is no easy way to scale up the number of workers to react to increased load.</li><li>Because calls need to complete within the timeout of the client&rsquo;s http requests,
the system falls apart when latency increases due to load.</li></ul><p>This proposal intends to address these issues by introducing an RPC system which:</p><ul><li>manages <a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-key>specialized</a> workers</li><li>automatically scales specialized workers</li></ul><h3 id=goals>Goals</h3><ul><li><code>high priority</code> the RPC protocol between editoast and core should be the same for development and production setups</li><li><code>high priority</code> requests are dispatched to specialized workers</li><li><code>high priority</code> the RPC system should be stateless and failure-resilient</li><li><code>low priority</code> the complexity of the local development setup should not increase</li></ul><h3 id=non-goals>Non-goals</h3><ul><li><code>not a goal</code> streaming events to the front-end</li><li><code>not a goal</code> reliable response processing</li><li><code>not a goal</code> caching</li></ul><h2 id=concepts>Concepts</h2><pre class=mermaid>flowchart TD
client
osrdyne
worker-pool
worker-group
worker-group-queue
worker


worker-pool -- contains --&gt; worker-group
worker-group -- contains and manages --&gt; worker
client -- pub --&gt; worker-group-queue
worker-group -- has a --&gt; worker-group-queue
worker -- sub --&gt; worker-group-queue
osrdyne -- manages --&gt; worker-pool
osrdyne -- manages --&gt; worker-group
osrdyne -- manages --&gt; worker-group-queue</pre><h3 id=client>Client</h3><p>Clients submit RPC <a href=/en/docs/reference/design-docs/scalable-async-rpc/#client-protocol>requests</a> to the message queue. RPC requests are published using AMQP 0.9.1.</p><p>For example, <code>editoast</code> would be a client.</p><h3 id=worker-key>Worker key</h3><p>Every submitted request includes a requested <code>worker-key</code>, as the message&rsquo;s <code>routing-key</code>.</p><p><strong>The key is what identifies which worker group will process the request</strong>.</p><p>Workers known their worker key at startup. All workers in a worker group have the same worker key.
It is an arbitrary utf-8 string set by the client, whose meaning is not defined by the RPC protocol:</p><ul><li>It could just be a way to have separate processing queues. In this case, workers may not care about what their is.</li><li>There could be an extra layer of protocol between client and worker about how the key is meant to be interpreted</li></ul><p>Here are some <strong>examples</strong> of how such protocols may work:</p><ul><li>it could be the identifier of a resource to act upon: <code>42</code></li><li>it could be the identifiers of multiple resources: <code>infra=42,timetable=24</code></li><li>it could even be, even though that&rsquo;s probably <strong>not a good idea</strong>, random worker settings:
<code>log_level=debug</code></li></ul><h3 id=worker-pools>Worker pools</h3><p>Worker pools are collections of workers of the same type, which can be specialized by key.
osrdyne creates an exchange for each worker pool, where clients can submit requests.</p><p>For example, <code>core</code> would be a worker pool.</p><h3 id=worker-group>Worker group</h3><p>Worker groups are collections of workers of the same pool and key, processing messages from the same queue.
<strong>Worker groups are responsible for scaling the number of workers depending on queue length and processing rate.</strong></p><p>Worker groups are managed by osrdyne. osrdyne should support multiple worker group drivers:</p><ul><li>a <a href=https://keda.sh>keda</a> k8s driver</li><li>a k8s autoscaler driver</li><li>a docker driver</li><li>a subprocess driver, where a single worker is started as a subprocess for each worker group</li><li>a systemd template unit driver</li><li>a noop driver, where workers have to be started manually</li></ul><p>For example, each <code>core</code> worker group handles a given infrastructure.</p><h3 id=worker>Worker</h3><p>A worker is a server processing requests from its worker group queue. Worker have a key.
For example, <code>core</code> workers are keyed by infrastructure.</p><h3 id=osrdyne>osrdyne</h3><ul><li>manages all exchanges, policies, queues and bindings</li><li>starts and stops worker groups as needed</li><li>generates error responses if the worker group fails to respond</li></ul><p>Each osrdyne instance manages a worker pool. See the <a href=/en/docs/reference/design-docs/scalable-async-rpc/#osrdyne-architecture>dedicated section</a>.</p><h2 id=rpc-protocol>RPC protocol</h2><h3 id=client-protocol>Client protocol</h3><p>Requests are submitted using AMQP 0.9.1&rsquo;s <code>basic.publish</code>:</p><table><thead><tr><th>AMQP field</th><th>semantics</th></tr></thead><tbody><tr><td><code>exchange</code></td><td><a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-pools>worker pool</a> identifier</td></tr><tr><td><code>routing-key</code></td><td><a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-key>requested key</a></td></tr><tr><td><code>correlation-id</code></td><td>an optional request id. The response will copy this field.</td></tr><tr><td><code>reply-to</code> property</td><td>optional response queue</td></tr><tr><td><code>mandatory</code></td><td><code>true</code> to ensure an error is returned if the message cannot be routed</td></tr></tbody></table><p>The body of the request will be dispatched to a worker of the requested pool and key.
The request is guaranteed to be dispatched <strong>at least once</strong></p><p>The response format is as follows:</p><table><thead><tr><th>AMQP field</th><th>semantics</th></tr></thead><tbody><tr><td><code>correlation-id</code></td><td>the correlation ID from the request</td></tr><tr><td><code>x-status</code> property</td><td>either <code>ok</code>, <a href=https://www.rabbitmq.com/docs/dlx#effects>or the reason for dead lettering</a>, taken from the request&rsquo;s <code>x-first-death-reason</code></td></tr><tr><td>body</td><td>optional response data</td></tr></tbody></table><h3 id=worker-protocol>Worker protocol</h3><p>When starting workers, the worker group driver provides:</p><table><thead><tr><th>Variable name</th><th>semantics</th></tr></thead><tbody><tr><td><code>WORKER_ID</code></td><td>a unique identifier for this worker</td></tr><tr><td><code>WORKER_KEY</code></td><td>the <a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-key>worker key</a></td></tr><tr><td><code>WORKER_POOL</code></td><td>the name of the worker pool</td></tr><tr><td><code>WORKER_REQUESTS_QUEUE</code></td><td>the queue to consume work from</td></tr><tr><td><code>WORKER_ACTIVITY_EXCHANGE</code></td><td>the exchange to publish events to</td></tr></tbody></table><p>Workers then have to:</p><ul><li>publish a <code>started</code> <a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-activity-reports>activity report message</a></li><li>subscribe to <code>WORKER_REQUESTS_QUEUE</code> using <code>basic.consume</code></li><li>for each request message:<ul><li>publish a <code>request-received</code> <a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-activity-reports>activity report message</a></li><li>if the worker cannot process the request, it can request a requeue using <code>basic.reject</code> with <code>requeue=true</code></li><li>build and publish a response to the <a href=https://www.rabbitmq.com/tutorials/amqp-concepts#exchange-default>default exchange</a></li><li><code>basic.ack</code> the request</li></ul></li></ul><h4 id=worker-response-protocol>Worker response protocol</h4><p>Responses are submitted using AMQP 0.9.1&rsquo;s <code>basic.publish</code>:</p><table><thead><tr><th>AMQP field</th><th>semantics</th></tr></thead><tbody><tr><td><code>exchange</code></td><td><a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-pools>worker pool</a> identifier</td></tr><tr><td><code>routing-key</code></td><td><a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-key>requested key</a></td></tr><tr><td><code>reply-to</code> property</td><td>optional response queue</td></tr></tbody></table><h4 id=worker-activity-reports>Worker activity reports</h4><p>Workers report the following activity events:</p><ul><li><code>started</code>: the worker is about to start processing requests</li><li><code>request-received</code>: a request was received</li></ul><table><thead><tr><th>AMQP field</th><th>value</th></tr></thead><tbody><tr><td><code>exchange</code></td><td><code>WORKER_ACTIVITY_EXCHANGE</code></td></tr><tr><td><code>routing-key</code></td><td><code>WORKER_KEY</code></td></tr><tr><td><code>x-event</code> property</td><td>the event type</td></tr></tbody></table><h2 id=message-passing-architecture>Message passing architecture</h2><p><img src=/en/docs/reference/design-docs/scalable-async-rpc/message-passing-architecture.svg alt="Message passing architecture"></p><p>For a full reference of all exchanges and queues, see the <a href=/en/docs/reference/design-docs/scalable-async-rpc/#exchange-and-queues>exchanges and queues</a> section</p><h2 id=message-lifetime>Message lifetime</h2><pre class=mermaid>flowchart TD
received
processed

received --&gt; requests
received -- alternate exchange --&gt; orphans
orphans -- controller starts worker group --&gt; requests
requests -- dead letter --&gt; dlx
dlx -- controller generates error --&gt; processed
requests -- worker responds --&gt; processed</pre><h2 id=service-architecture>Service architecture</h2><pre class=mermaid>flowchart TD

client

subgraph RPC layer
rabbitmq[RabbitMQ]
osrdyne[osrdyne]
end

subgraph worker-group[worker group]
worker
end

client -- enqueues --&gt; rabbitmq
osrdyne -- sub orphan messages --&gt; rabbitmq
osrdyne -- manages queues --&gt; rabbitmq
osrdyne -- starts and stops --&gt; worker-group
osrdyne -- sub activity events --&gt; rabbitmq
worker -- sub requests --&gt; rabbitmq
worker -- pub responses --&gt; rabbitmq
worker -- pub activity events --&gt; rabbitmq</pre><ul><li><code>osrdyne</code> stops and starts worker groups following demand</li><li><code>worker</code> processes requests dequeued from rabbitmq</li></ul><h2 id=life-of-an-rpc-call>Life of an RPC call</h2><p>In this example:</p><ul><li><code>editoast</code> is the client</li><li>it makes a request to the <code>core</code> worker pool</li><li>the <code>core</code> worker pool is keyed on infrastructures</li></ul><h3 id=fast-path>Fast path</h3><ul><li>Editoast publishes a request message to <code>exchange=core</code> with <code>routing_key=42</code>. If the message expects a reply, <code>reply-to</code> is set.</li><li>If the <code>core</code> exchange already has binding for worker group <code>42</code>, a worker picks up the request</li><li>The worker processes the request, and uses the <code>reply-to</code> field to submit a response.</li><li>The worker ACKs the request.</li></ul><h3 id=worker-group-startup>Worker group startup</h3><p>These steps only occur if the worker group / queue has not yet started:</p><ul><li>If there is no queue bound to routing key <code>42</code>, the message is routed to the <code>core-orphan-xchg</code> exchange.
This exchange is a fanout exchange with a single queue, where <code>osrdyne</code> processes messages.</li><li><code>osrdyne</code> processes the message:<ul><li>creates queue <code>core-req-42</code>, binds it to the <code>core</code> exchange on routing key <code>42</code></li><li>forward the message to exchange <code>core</code></li><li>ACK the original message once the original is forwarded</li><li>start worker group <code>core</code> key <code>42</code></li></ul></li><li>the worker group starts up and processes the request</li></ul><h2 id=osrdyne-architecture>osrdyne architecture</h2><pre class=mermaid>flowchart TD


%% inputs
activity-queue([activity queue])
orphan-queue([orphan queue])
dead-letter-queue([dead letter queue])
rabbitmq-api[RabbitMQ HTTP API]

%% components
orphan-processor[orphan processor]
dead-letter-responder[dead letter responder]

subgraph pool manager
pool-state-tracker[pool state tracker]
wgs-control-loop[worker groups control loop]
req-queues-control-loop[request queues control loop]
end
wg-driver[worker group driver]

%% outputs
request-xchg([request exchange])
poison-inventory([poison request inventory])
response([response queue])


%% relations

dead-letter-queue -- sub --&gt; dead-letter-responder --&gt; response &amp; poison-inventory
orphan-queue -- sub --&gt; orphan-processor -- forward --&gt; request-xchg
orphan-processor -- request worker group start --&gt; pool-state-tracker
orphan-processor -- wait for execution --&gt; req-queues-control-loop
rabbitmq-api -- initial queue list --&gt; pool-state-tracker
activity-queue -- worker activity --&gt; pool-state-tracker
pool-state-tracker -- expected state --&gt; wgs-control-loop &amp; req-queues-control-loop
wgs-control-loop -- start / stop --&gt; wg-driver</pre><ul><li><p>the <strong>pool manager</strong> is the most complex component of osrdyne. It is in charge of creating,
deleting request queues, and deciding which worker groups should be running at any given time. To make such decisions, it needs:</p><ul><li>the ability to list existing queues at startup, which is done using the RabbitMQ HTTP API</li><li>worker activity events, to know which queues are active</li><li>queue creation commands from the orphan processor</li></ul><p>The pool manager runs two control loops:</p><ul><li>the <strong>worker groups control loop</strong> starts and stops worker groups using the <strong>worker group driver</strong></li><li>the <strong>request queues control loop</strong> creates and deletes request queues</li></ul></li><li><p>the <strong>orphan processor</strong> reacts to orphan messages by sending worker group start commands to the worker group manager</p></li><li><p>the <strong>dead letter responder</strong>:</p><ul><li>responds errors to dead lettered messages following the <a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-protocol>worker protocol</a></li><li>if a message is deemed to have caused repeated worker crashes, publish to the poison inventory</li></ul></li></ul><p>On worker pool startup:</p><ul><li>create and bind all <a href=/en/docs/reference/design-docs/scalable-async-rpc/#exchanges-and-queues>exchanges and queues</a></li><li>configure the TTL, delivery timeout and delivery limit policies using the HTTP API</li><li>start the <strong>orphan processor</strong>, <strong>dead letter responder</strong> and <strong>worker group manager</strong></li></ul><h3 id=exchanges-and-queues>Exchanges and queues</h3><p>osrdyne creates a number of exchanges and queues. Most of the setup is done
per worker pool, except for worker group request queues.</p><p>Worker pool exchanges:</p><ul><li>pool requests exchange <code>{pool}-req-xchg</code>, type <code>direct</code>:<ul><li>alternate exchange is <code>{pool}-orphan-xchg</code></li><li>dead letter exchange is <code>{pool}-dl-xchg</code></li><li>worker group request queues are bound to this exchange</li></ul></li><li>orphan exchange <code>{pool}-orphan-xchg</code>, type <code>fanout</code></li><li>dead letter exchange <code>{pool}-dl-xchg</code>, type <code>fanout</code></li><li>activity queue <code>{pool}-activity-xchg</code>, type <code>fanout</code></li></ul><p>Worker pool queues:</p><ul><li>dead letter queue <code>{pool}-dl</code>, bound to <code>{pool}-dl-xchg</code> (<strong>exclusive</strong>)</li><li>orphan queue <code>{pool}-orphan</code>, bound to <code>{pool}-orphan-xchg</code> (<strong>exclusive</strong>)</li><li>worker activity queue <code>{pool}-activity</code>, bound to <code>{pool}-activity-xchg</code></li><li>poison queue <code>{pool}-poison</code>. Used to collect messages which could not be processed, supposedly due to worker crash</li></ul><p>Worker group queues:</p><ul><li>request queue <code>{pool}-req-{key}</code>, bound by key to <code>{pool}-req-xchg</code></li></ul><h3 id=worker-group-manager>Worker group manager</h3><p>The worker group manager has three internal components:</p><ul><li>the <strong>pool state tracker</strong> tracks the expected status of worker groups</li><li>the <strong>request queues control loop</strong> applies changes to worker group request queues</li><li>the <strong>worker groups control loop</strong> applies changes to worker groups</li></ul><p>The state tracker assigns a 64 bit generation identifier to each expected state.
The two control loops report the last synchronized state.</p><p>When the orphan processor wants to start a worker group, it has to:</p><ul><li>tell the <strong>state tracker</strong>, which gives a generation identifier for the new expected state</li><li>wait until the <strong>request queue control loop</strong> has caught up to this generation <strong>and</strong> has
created the queue (which may be delayed due to networking issues)</li></ul><h4 id=pool-state-tracker>Pool state tracker</h4><pre class=mermaid>stateDiagram-v2
Inactive --&gt; Active: received request
Active --&gt; Unbound: unbind delay elapsed
Unbound --&gt; Inactive: stop delay elapsed
Unbound --&gt; Active: received request</pre><p>Two time constants govern how the expected state of worker groups evolves:</p><ul><li><code>UNBIND_DELAY</code> delay until the queue transitions from <code>Active</code> to <code>Unbound</code></li><li><code>STOP_DELAY</code> delay until the worker group is stopped</li></ul><p>The state tracker has the following API:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>WGStatus</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Active</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Unbound</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Generation</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>PoolState</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>generation</span>: <span style=color:#000>Generation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>wgs</span>: <span style=color:#000>im</span>::<span style=color:#000>OrdMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>WGStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>trait</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PoolStateTracker</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>initial_worker_groups</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Self</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Require some worker group to be active. The extra lifetime adds active duration compared to the configured spool down schedule.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// This allows the worker activity processor to debounce activity events without lowering the active time of worker groups.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Returns the state generation where this worker group starts being active.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>require_worker_group</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>str</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>extra_lifetime</span>: <span style=color:#000>Duration</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Generation</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Subscribe to a stream of target pool state updates
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>subscribe</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>tokio</span>::<span style=color:#000>sync</span>::<span style=color:#000>watch</span>::<span style=color:#000>Receiver</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PoolState</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=request-queues-control-loop>Request queues control loop</h3><p>The request queue control loop takes care of creating, binding, unbinding and stopping request queues.
It subscribes to the pool state tracker, and reacts to state changes.</p><p>It exposes the following API, which is used by the orphan processor to wait for updates to propagate:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ReqQueueStatus</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>expected</span>: <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>WGStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>actual</span>: <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>WGStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ReqQueuesState</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>generation</span>: <span style=color:#000>Generation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>queues</span>: <span style=color:#000>im</span>::<span style=color:#000>OrdMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReqQueueStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>trait</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestQueueControlLoop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>target</span>: <span style=color:#000>tokio</span>::<span style=color:#000>sync</span>::<span style=color:#000>watch</span>::<span style=color:#000>Receiver</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PoolState</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Self</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>subscribe</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>tokio</span>::<span style=color:#000>sync</span>::<span style=color:#000>watch</span>::<span style=color:#000>Receiver</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ReqQueuesState</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>it runs the following control loop:</p><ul><li>fetch the set of <code>current</code>ly active request queues</li><li>control loop:<ul><li>for each queue in <code>expected</code> and not in <code>current</code>:<ul><li>attempt to create the queue</li><li>if successful, update the current set</li></ul></li><li>for each queue in <code>current</code> and not in <code>expected</code>:<ul><li>attempt to remove the queue, if empty and unused</li><li>if successful, update the current set</li></ul></li><li>for each waiting orphan processor, release if the condition is met</li></ul></li></ul><p>The control loop runs when <code>current</code> != <code>expected</code>, or when <code>expected</code> changes.</p><h3 id=worker-groups-control-loop>Worker groups control loop</h3><p>osrdyne is responsible for starting and stopping worker groups following demand.
<strong>It it NOT responsible for scaling the number of workers per worker group</strong>.</p><p>osrdyne runs the following control loop:</p><ul><li>receive the set of <code>expected</code> worker groups from the <strong>pool state tracker</strong></li><li>build the set of <code>running</code> worker groups: query running worker groups from the <strong>worker group driver</strong>. If this fails, log and continue to the next iteration of the control loop.</li><li>make both sets converge:<ul><li>for each worker group in <code>expected</code> and not in <code>running</code>:<ul><li>use the docker / kubernetes API to start the worker group. This must be idempotent. <strong>do not retry</strong> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li></ul></li><li>for each worker group in <code>running</code> and not in <code>expected</code>:<ul><li>use the docker / kubernetes API to attempts to stop the worker group. This must be idempotent. <strong>do not retry</strong> <sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li></ul></li></ul></li></ul><h3 id=worker-activity-processor>Worker activity processor</h3><p>As the number of worker activity events could be very high, we may not want to forward all of these to the pool state tracker:
if multiple messages are received within a short time span, only the first one is relevant. A separate actor can be used to receive
and dedup activity messages, and forward a low bandwidth summary to the pool state tracker.</p><h2 id=failure-mode-analysis>Failure mode analysis</h2><h3 id=the-worker-fails-to-parse-a-message>The worker fails to parse a message</h3><p>This is an application layer error:
the worker must respond, and indicate that something went wrong</p><h3 id=the-worker-dies-or-stalls-when-processing-a-message>The worker dies or stalls when processing a message</h3><p>RabbitMQ will wait until the message TTL expires, and re-queues it.
A limit must be set on the number of times a message can be re-queued using a <a href=https://www.rabbitmq.com/docs/quorum-queues#poison-message-handling><code>delivery-limit</code></a>.
When this limit is reached, the poison message is sent to the dead letter exchange, and the client times out.</p><h3 id=osrdyne-fails-to-start>osrdyne fails to start</h3><ul><li>If exchanges are not setup, the client cannot publish messages</li><li>If the appropriate work group is operational, the <a href=/en/docs/reference/design-docs/scalable-async-rpc/#fast-path>fast path</a> can proceed</li><li>Otherwise, requests pile up in the orphan queue, and the client ends up timing out</li></ul><h3 id=invalid-worker-key>Invalid worker key</h3><p>Because the key is an arbitrary string set by the client, it has to be processed carefully:</p><ul><li>the format is defined as a convention between the client and workers. If the format isn&rsquo;t right,
it is up to the worker to publish a response to the client.</li><li>key validity conditions is also up to the worker: if the key is supposed to be some
object ID, but the object does not exist, the worker needs to start up and respond</li></ul><p><strong>Even if the key does not conform to the convention established between the client and the
worker, the worker needs to start and respond to all requests.</strong></p><h3 id=workers-fails-to-start>Workers fails to start</h3><p><strong>A <a href=https://www.rabbitmq.com/blog/2014/01/23/preventing-unbounded-buffers-with-rabbitmq#per-queue-message-ttl>per-queue message TTL</a>
should be set to avoid requests accumulating indefinitely.</strong></p><p>Workers failing to start will cause:</p><ul><li>messages to accumulate in the queue.</li><li>when message TTL is reached, it will get transferred to the dead letter queue</li><li>the client will time out awaiting a response</li></ul><h3 id=multiple-osrdyne-daemons-are-started-on-the-same-pool>Multiple osrdyne daemons are started on the same pool</h3><p>It shouldn&rsquo;t be an issue, as:</p><ul><li>all operations done on startup are idempotent</li><li>before doing anything, the daemon has to start listening as an <strong>exclusive consumer of the dead letter and orphan queues</strong></li></ul><h2 id=known-limitations>Known limitations</h2><h3 id=latency-publisher-confirms-and-reliability>Latency, publisher confirms and reliability</h3><p>Without publisher confirms, networker or broken failure can result in message loss.
However, publisher confirms add quite a bit of latency (about 200ms), as it ensures messages are persisted to disk if the queue is durable.</p><p><strong>We should use publisher confirms for responses and orphan transfers, and leave the decision of whether to do it for requests to the client.</strong></p><h3 id=at-least-once-semantics>At least once semantics</h3><p>Most things in this protocol have at least once semantics if publisher confirms are used:</p><ul><li><code>request delivery to workers</code>: if osrdyne is restarted while transferring an orphan to its destination, the orphan may be transferred twice</li><li><code>response delivery to clients</code>: if a worker takes slightly too long to ACK a message, but still responds, it may be requeued and re-processed, and thus responded to twice</li></ul><h2 id=design-decisions>Design decisions</h2><h3 id=using-rabbitmq>Using RabbitMQ</h3><p>To implement this solution, we rely on a combination of <a href=https://www.rabbitmq.com/docs/extensions>features unique to RabbitMQ</a>:</p><ul><li>each worker type needs a separate <strong>exchange</strong> and configuration</li><li>when a message cannot be routed within a worker type&rsquo;s exchange, it is redirected to an <strong>alternate exchange</strong> managed by the worker manager</li><li><strong>dead lettering</strong> is leveraged to generate protocol errors</li><li>the worker manager uses the <strong>RabbitMQ HTTP API</strong> to list queues</li></ul><p>In addition to its attractive feature set, RabbitMQ has:</p><ul><li>various useful quality of life features, such as direct reply and per-message TTL</li><li>long demonstrated its <strong>reliability</strong></li><li>multiple engineers on staff <strong>experience</strong>d with the tool</li></ul><h3 id=queues-are-created-by-osrdyne>Queues are created by osrdyne</h3><p>At some point, we explored the possibility of RPC clients creating queues.
osrdyne would react to queue creation by starting workers. If the
queue were to be unused for a while, osrdyne would stop workers and
delete the queue.</p><p>This creates a race condition on queue deletion:</p><ul><li>osrdyne sees that the queue is empty</li><li>the client ensures the queue is created</li><li>osrdyne deletes the queue</li><li>the client attempts to publish a message to the now deleted queue</li></ul><p>We thus decided to move the responsibility of queue management to the
osrdyne, and implement a mechanism to ensure messages cannot be
dropped due to a missing queue.</p><h3 id=osrdyne-republishes-orphan-messages>osrdyne republishes orphan messages</h3><p>Initially, we though of a solution whereby osrdyne&rsquo;s orphan processor uses <a href=https://www.rabbitmq.com/docs/dlx>dead lettering</a>
to send messages back to their original exchange. This is in fact a bad idea, as dead lettering <a href=https://www.rabbitmq.com/docs/dlx#effects>inhibits per message TTL</a>.</p><p>Instead, the orphan processor has to proxy messages back to their original exchange.
<strong>This proxying process can cause requests to get delivered multiple times to the target queue</strong>.</p><h3 id=osrdyne-responds-to-dead-lettered-messages>osrdyne responds to dead lettered messages</h3><p>If a message is dead lettered for some reason (expired TTL, delivery limit, max queue length),
we figured it would be best to give the client some idea that something went wrong.</p><p>The <a href=/en/docs/reference/design-docs/scalable-async-rpc/#worker-protocol>worker protocol</a> thus has to allow the client to distinguish protocol errors from worker responses.</p><h3 id=messages-are-only-acked-by-workers-once-processed>Messages are only ACKed by workers once processed</h3><p>If messages are ACKed on reception:</p><ul><li>processing time is not limited by message timeout (which is arguably not a feature)</li><li>the broker does not attempt re-delivery if the worker were to stop and not respond for some reason</li></ul><p>If messages are ACKed once processed:</p><ul><li>messages whose processing time exceeds TTL will be re-queued, even if the worker is still processing the message. <strong>This can result in multiple responses being delivered</strong>.</li><li>if the worker crashes or is stopped, the message will be re-queued</li></ul><p>We decided to rely on a <a href=https://www.rabbitmq.com/docs/quorum-queues#poison-message-handling><code>delivery-limit</code> policy</a> to handle poison messages, and ACK messages once processed.</p><h3 id=report-worker-activity-using-amqp>Report worker activity using AMQP</h3><p>osrdyne needs to maintain queue usage statistics in order to know when worker groups can be stopped.
At first, we considered having workers use valkey to store the timestamp of the last processed message for the queue.
We decided against it as:</p><ul><li>it would mean the workers store a timestamp directly in database, read by a supervisor process. it&rsquo;s a pretty bad design</li><li>it adds an additional database to the RPC architecture, for little to no benefit compared to just using rabbitmq</li><li>if one of the workers has its clock drift by more than the worker group expiration time compared to osrdyne, the worker group will get stopped</li><li>any worker can get the pool deleted by forcing the timestamp to an old value</li><li>it adds a failure mode: if osrdyne / workers are unable to reach valkey, weird bugs may ensue</li></ul><p>Instead, we decided to require worker to publish activity updates to a dedicated queue.
This queue can be watched by osrdyne, which can use these events to know when to stop a worker group.</p><h3 id=make-worker-group-lifetime-decisions-in-a-separate-actor>Make worker group lifetime decisions in a separate actor</h3><p>The lifetime of worker groups is influenced by three types of asynchronous events:</p><ul><li>worker activity</li><li>orphan requests</li><li>worker group spool down deadlines</li></ul><p>When the orphan processor gets a request, it needs to create the worker group&rsquo;s request
queue before it can proceed to forward the message.</p><p>If queues were created and deleted asynchronously when these events are received, it would introduce a race condition:</p><ul><li>the orphan processor creates the queue</li><li>the queue gets deleted because it expired at the same time</li><li>the orphan processor forwards the message, which gets lost</li></ul><p>We found multiple solutions for this issue:</p><ul><li>process all asynchronous events in a single actor. This was not deemed viable because worker activity processing is work intensive, and orphan request processing is latency sensitive.</li><li>having a single actor create and delete queues (the <a href=/en/docs/reference/design-docs/scalable-async-rpc/#request-queues-control-loop><strong>request queues control loop</strong></a>) and making the orphan processor wait until the control loop creates the queue</li></ul><h3 id=unbind-the-queue-and-wait-before-stopping-workers>Unbind the queue and wait before stopping workers</h3><p>In a previous design, we tried to delete work queue in one go. It created a race condition issue on queue deletion,
caused by the fact osrdyne does not get direct notifications of when messages are received on a work queue:</p><ul><li>we decide to stop the worker group</li><li>work is received on the queue, but we aren&rsquo;t made aware as no worker is up</li><li>we try to delete the queue, but cannot do so without loosing messages</li></ul><p>We could think of two fixes for this issue:</p><ul><li>implement a two stage shutdown, where no work can get to the queue for a while before workers are stopped</li><li>detect that the queue still has messages after workers have stopped, and start workers back up</li></ul><p>We decided to implement two stage worker group shutdown:</p><ul><li>if no activity is register for <code>UNBIND_DELAY</code>, unbind the work queue</li><li>wait for a while to see if any worker picks up work from the queue and notifies osrdyne, which would rebind the queue</li><li>if no orphan nor worker activity is registered for <code>STOP_DELAY</code>, stop workers and delete the queue</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>The control loop is designed to make the state of all worker groups converge at once.
Retrying convergence for one worker group adds latency to convergence for all worker groups.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/OpenRailAssociation/osrd aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2025
<span class=td-footer__authors>OSRD contributors.</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><script type=module async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@latest\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {"enable":true};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script><script src=/js/main.min.70982f4f1de53d56b47d6b66c1ed442a9653a5be8820e0ba651d5d17d9a9bbe1.js integrity="sha256-cJgvTx3lPVa0fWtmwe1EKpZTpb6IIOC6ZR1dF9mpu+E=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>